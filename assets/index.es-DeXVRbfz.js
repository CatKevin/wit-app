const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./secp256k1-BE_Or2wZ.js","./index-BKGg5xyW.js","./index-DlX-mzzS.css"])))=>i.map(i=>d[i]);
import{bO as gt,bP as k,bQ as ts,bR as ui,bS as Ns,bT as ki,_ as el,bU as tl,bV as Ps,bW as sl,bX as Ya,bY as il,bZ as rl,b_ as Nr,b$ as nl,c0 as ol,c1 as al,c2 as it,c3 as qt,c4 as st,c5 as Gi,c6 as Fn,c7 as cl,c8 as hl,c9 as Ur,ca as mn,cb as ll,cc as ul,cd as wn,ce as ri,cf as bn,cg as Hn,ch as dl,ci as fl,cj as bt,ck as St,cl as nt}from"./index-BKGg5xyW.js";let pl=class extends ts{constructor(e){super()}};const Vn=k.FIVE_SECONDS,ss={pulse:"heartbeat_pulse"};let gl=class Za extends pl{constructor(e){super(e),this.events=new gt.EventEmitter,this.interval=Vn,this.interval=(e==null?void 0:e.interval)||Vn}static async init(e){const t=new Za(e);return await t.init(),t}async init(){await this.initialize()}stop(){clearInterval(this.intervalRef)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async initialize(){this.intervalRef=setInterval(()=>this.pulse(),k.toMiliseconds(this.interval))}pulse(){this.events.emit(ss.pulse)}};const yl={level:"info"},di="custom_context",vn=1e3*1024;let ml=class{constructor(e){this.nodeValue=e,this.sizeInBytes=new TextEncoder().encode(this.nodeValue).length,this.next=null}get value(){return this.nodeValue}get size(){return this.sizeInBytes}},Kn=class{constructor(e){this.head=null,this.tail=null,this.lengthInNodes=0,this.maxSizeInBytes=e,this.sizeInBytes=0}append(e){const t=new ml(e);if(t.size>this.maxSizeInBytes)throw new Error(`[LinkedList] Value too big to insert into list: ${e} with size ${t.size}`);for(;this.size+t.size>this.maxSizeInBytes;)this.shift();this.head?(this.tail&&(this.tail.next=t),this.tail=t):(this.head=t,this.tail=t),this.lengthInNodes++,this.sizeInBytes+=t.size}shift(){if(!this.head)return;const e=this.head;this.head=this.head.next,this.head||(this.tail=null),this.lengthInNodes--,this.sizeInBytes-=e.size}toArray(){const e=[];let t=this.head;for(;t!==null;)e.push(t.value),t=t.next;return e}get length(){return this.lengthInNodes}get size(){return this.sizeInBytes}toOrderedArray(){return Array.from(this)}[Symbol.iterator](){let e=this.head;return{next:()=>{if(!e)return{done:!0,value:null};const t=e.value;return e=e.next,{done:!1,value:t}}}}},Qa=class{constructor(e,t=vn){this.level=e??"error",this.levelValue=Ns.levels.values[this.level],this.MAX_LOG_SIZE_IN_BYTES=t,this.logs=new Kn(this.MAX_LOG_SIZE_IN_BYTES)}forwardToConsole(e,t){t===Ns.levels.values.error?console.error(e):t===Ns.levels.values.warn?console.warn(e):t===Ns.levels.values.debug?console.debug(e):t===Ns.levels.values.trace?console.trace(e):console.log(e)}appendToLogs(e){this.logs.append(ki({timestamp:new Date().toISOString(),log:e}));const t=typeof e=="string"?JSON.parse(e).level:e.level;t>=this.levelValue&&this.forwardToConsole(e,t)}getLogs(){return this.logs}clearLogs(){this.logs=new Kn(this.MAX_LOG_SIZE_IN_BYTES)}getLogArray(){return Array.from(this.logs)}logsToBlob(e){const t=this.getLogArray();return t.push(ki({extraMetadata:e})),new Blob(t,{type:"application/json"})}},wl=class{constructor(e,t=vn){this.baseChunkLogger=new Qa(e,t)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}downloadLogsBlobInBrowser(e){const t=URL.createObjectURL(this.logsToBlob(e)),i=document.createElement("a");i.href=t,i.download=`walletconnect-logs-${new Date().toISOString()}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(t)}},bl=class{constructor(e,t=vn){this.baseChunkLogger=new Qa(e,t)}write(e){this.baseChunkLogger.appendToLogs(e)}getLogs(){return this.baseChunkLogger.getLogs()}clearLogs(){this.baseChunkLogger.clearLogs()}getLogArray(){return this.baseChunkLogger.getLogArray()}logsToBlob(e){return this.baseChunkLogger.logsToBlob(e)}};var vl=Object.defineProperty,El=Object.defineProperties,Il=Object.getOwnPropertyDescriptors,Gn=Object.getOwnPropertySymbols,xl=Object.prototype.hasOwnProperty,Dl=Object.prototype.propertyIsEnumerable,Wn=(s,e,t)=>e in s?vl(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Bi=(s,e)=>{for(var t in e||(e={}))xl.call(e,t)&&Wn(s,t,e[t]);if(Gn)for(var t of Gn(e))Dl.call(e,t)&&Wn(s,t,e[t]);return s},qi=(s,e)=>El(s,Il(e));function Wi(s){return qi(Bi({},s),{level:(s==null?void 0:s.level)||yl.level})}function Pl(s,e=di){return s[e]||""}function Sl(s,e,t=di){return s[t]=e,s}function Ue(s,e=di){let t="";return typeof s.bindings>"u"?t=Pl(s,e):t=s.bindings().context||"",t}function _l(s,e,t=di){const i=Ue(s,t);return i.trim()?`${i}/${e}`:e}function _e(s,e,t=di){const i=_l(s,e,t),r=s.child({context:i});return Sl(r,i,t)}function $l(s){var e,t;const i=new wl((e=s.opts)==null?void 0:e.level,s.maxSizeInBytes);return{logger:ui(qi(Bi({},s.opts),{level:"trace",browser:qi(Bi({},(t=s.opts)==null?void 0:t.browser),{write:r=>i.write(r)})})),chunkLoggerController:i}}function Al(s){var e;const t=new bl((e=s.opts)==null?void 0:e.level,s.maxSizeInBytes);return{logger:ui(qi(Bi({},s.opts),{level:"trace"}),t),chunkLoggerController:t}}function Ol(s){return typeof s.loggerOverride<"u"&&typeof s.loggerOverride!="string"?{logger:s.loggerOverride,chunkLoggerController:null}:typeof window<"u"?$l(s):Al(s)}var Cl=Object.defineProperty,Tl=(s,e,t)=>e in s?Cl(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Jn=(s,e,t)=>Tl(s,typeof e!="symbol"?e+"":e,t);let Rl=class extends ts{constructor(e){super(),this.opts=e,Jn(this,"protocol","wc"),Jn(this,"version",2)}};var Nl=Object.defineProperty,Ul=(s,e,t)=>e in s?Nl(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,kl=(s,e,t)=>Ul(s,e+"",t);let Bl=class extends ts{constructor(e,t){super(),this.core=e,this.logger=t,kl(this,"records",new Map)}},ql=class{constructor(e,t){this.logger=e,this.core=t}},jl=class extends ts{constructor(e,t){super(),this.relayer=e,this.logger=t}},Ll=class extends ts{constructor(e){super()}},Ml=class{constructor(e,t,i,r){this.core=e,this.logger=t,this.name=i}},zl=class extends ts{constructor(e,t){super(),this.relayer=e,this.logger=t}},Fl=class extends ts{constructor(e,t){super(),this.core=e,this.logger=t}},Hl=class{constructor(e,t,i){this.core=e,this.logger=t,this.store=i}},Vl=class{constructor(e,t){this.projectId=e,this.logger=t}},Kl=class{constructor(e,t,i){this.core=e,this.logger=t,this.telemetryEnabled=i}};var Gl=Object.defineProperty,Wl=(s,e,t)=>e in s?Gl(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Yn=(s,e,t)=>Wl(s,typeof e!="symbol"?e+"":e,t);let Jl=class{constructor(e){this.opts=e,Yn(this,"protocol","wc"),Yn(this,"version",2)}},Yl=class{constructor(e){this.client=e}};function ni(s,{strict:e=!0}={}){return!s||typeof s!="string"?!1:e?/^0x[0-9a-fA-F]*$/.test(s):s.startsWith("0x")}function kr(s){return ni(s,{strict:!1})?Math.ceil((s.length-2)/2):s.length}const Xa="2.31.0";let Us={getDocsUrl:({docsBaseUrl:s,docsPath:e="",docsSlug:t})=>e?`${s??"https://viem.sh"}${e}${t?`#${t}`:""}`:void 0,version:`viem@${Xa}`};class Qt extends Error{constructor(e,t={}){var a;const i=(()=>{var c;return t.cause instanceof Qt?t.cause.details:(c=t.cause)!=null&&c.message?t.cause.message:t.details})(),r=t.cause instanceof Qt&&t.cause.docsPath||t.docsPath,n=(a=Us.getDocsUrl)==null?void 0:a.call(Us,{...t,docsPath:r}),o=[e||"An error occurred.","",...t.metaMessages?[...t.metaMessages,""]:[],...n?[`Docs: ${n}`]:[],...i?[`Details: ${i}`]:[],...Us.version?[`Version: ${Us.version}`]:[]].join(`
`);super(o,t.cause?{cause:t.cause}:void 0),Object.defineProperty(this,"details",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"docsPath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metaMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shortMessage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"BaseError"}),this.details=i,this.docsPath=r,this.metaMessages=t.metaMessages,this.name=t.name??this.name,this.shortMessage=e,this.version=Xa}walk(e){return ec(this,e)}}function ec(s,e){return e!=null&&e(s)?s:s&&typeof s=="object"&&"cause"in s&&s.cause!==void 0?ec(s.cause,e):e?null:s}class tc extends Qt{constructor({size:e,targetSize:t,type:i}){super(`${i.charAt(0).toUpperCase()}${i.slice(1).toLowerCase()} size (${e}) exceeds padding size (${t}).`,{name:"SizeExceedsPaddingSizeError"})}}function $s(s,{dir:e,size:t=32}={}){return typeof s=="string"?Zl(s,{dir:e,size:t}):Ql(s,{dir:e,size:t})}function Zl(s,{dir:e,size:t=32}={}){if(t===null)return s;const i=s.replace("0x","");if(i.length>t*2)throw new tc({size:Math.ceil(i.length/2),targetSize:t,type:"hex"});return`0x${i[e==="right"?"padEnd":"padStart"](t*2,"0")}`}function Ql(s,{dir:e,size:t=32}={}){if(t===null)return s;if(s.length>t)throw new tc({size:s.length,targetSize:t,type:"bytes"});const i=new Uint8Array(t);for(let r=0;r<t;r++){const n=e==="right";i[n?r:t-r-1]=s[n?r:s.length-r-1]}return i}class Xl extends Qt{constructor({max:e,min:t,signed:i,size:r,value:n}){super(`Number "${n}" is not in safe ${r?`${r*8}-bit ${i?"signed":"unsigned"} `:""}integer range ${e?`(${t} to ${e})`:`(above ${t})`}`,{name:"IntegerOutOfRangeError"})}}class eu extends Qt{constructor({givenSize:e,maxSize:t}){super(`Size cannot exceed ${t} bytes. Given size: ${e} bytes.`,{name:"SizeOverflowError"})}}function As(s,{size:e}){if(kr(s)>e)throw new eu({givenSize:kr(s),maxSize:e})}function Br(s,e={}){const{signed:t}=e;e.size&&As(s,{size:e.size});const i=BigInt(s);if(!t)return i;const r=(s.length-2)/2,n=(1n<<BigInt(r)*8n-1n)-1n;return i<=n?i:i-BigInt(`0x${"f".padStart(r*2,"f")}`)-1n}function tu(s,e={}){return Number(Br(s,e))}const su=Array.from({length:256},(s,e)=>e.toString(16).padStart(2,"0"));function qr(s,e={}){return typeof s=="number"||typeof s=="bigint"?ic(s,e):typeof s=="string"?nu(s,e):typeof s=="boolean"?iu(s,e):sc(s,e)}function iu(s,e={}){const t=`0x${Number(s)}`;return typeof e.size=="number"?(As(t,{size:e.size}),$s(t,{size:e.size})):t}function sc(s,e={}){let t="";for(let r=0;r<s.length;r++)t+=su[s[r]];const i=`0x${t}`;return typeof e.size=="number"?(As(i,{size:e.size}),$s(i,{dir:"right",size:e.size})):i}function ic(s,e={}){const{signed:t,size:i}=e,r=BigInt(s);let n;i?t?n=(1n<<BigInt(i)*8n-1n)-1n:n=2n**(BigInt(i)*8n)-1n:typeof s=="number"&&(n=BigInt(Number.MAX_SAFE_INTEGER));const o=typeof n=="bigint"&&t?-n-1n:0;if(n&&r>n||r<o){const c=typeof s=="bigint"?"n":"";throw new Xl({max:n?`${n}${c}`:void 0,min:`${o}${c}`,signed:t,size:i,value:`${s}${c}`})}const a=`0x${(t&&r<0?(1n<<BigInt(i*8))+BigInt(r):r).toString(16)}`;return i?$s(a,{size:i}):a}const ru=new TextEncoder;function nu(s,e={}){const t=ru.encode(s);return sc(t,e)}const ou=new TextEncoder;function au(s,e={}){return typeof s=="number"||typeof s=="bigint"?hu(s,e):typeof s=="boolean"?cu(s,e):ni(s)?rc(s,e):nc(s,e)}function cu(s,e={}){const t=new Uint8Array(1);return t[0]=Number(s),typeof e.size=="number"?(As(t,{size:e.size}),$s(t,{size:e.size})):t}const mt={zero:48,nine:57,A:65,F:70,a:97,f:102};function Zn(s){if(s>=mt.zero&&s<=mt.nine)return s-mt.zero;if(s>=mt.A&&s<=mt.F)return s-(mt.A-10);if(s>=mt.a&&s<=mt.f)return s-(mt.a-10)}function rc(s,e={}){let t=s;e.size&&(As(t,{size:e.size}),t=$s(t,{dir:"right",size:e.size}));let i=t.slice(2);i.length%2&&(i=`0${i}`);const r=i.length/2,n=new Uint8Array(r);for(let o=0,a=0;o<r;o++){const c=Zn(i.charCodeAt(a++)),h=Zn(i.charCodeAt(a++));if(c===void 0||h===void 0)throw new Qt(`Invalid byte sequence ("${i[a-2]}${i[a-1]}" in "${i}").`);n[o]=c*16+h}return n}function hu(s,e){const t=ic(s,e);return rc(t)}function nc(s,e={}){const t=ou.encode(s);return typeof e.size=="number"?(As(t,{size:e.size}),$s(t,{dir:"right",size:e.size})):t}const vi=BigInt(2**32-1),Qn=BigInt(32);function lu(s,e=!1){return e?{h:Number(s&vi),l:Number(s>>Qn&vi)}:{h:Number(s>>Qn&vi)|0,l:Number(s&vi)|0}}function uu(s,e=!1){const t=s.length;let i=new Uint32Array(t),r=new Uint32Array(t);for(let n=0;n<t;n++){const{h:o,l:a}=lu(s[n],e);[i[n],r[n]]=[o,a]}return[i,r]}const du=(s,e,t)=>s<<t|e>>>32-t,fu=(s,e,t)=>e<<t|s>>>32-t,pu=(s,e,t)=>e<<t-32|s>>>64-t,gu=(s,e,t)=>s<<t-32|e>>>64-t,ns=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function yu(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function ji(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function oi(s,...e){if(!yu(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function g2(s){if(typeof s!="function"||typeof s.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");ji(s.outputLen),ji(s.blockLen)}function Xn(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function mu(s,e){oi(s);const t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function wu(s){return new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4))}function oc(...s){for(let e=0;e<s.length;e++)s[e].fill(0)}function y2(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}function m2(s,e){return s<<32-e|s>>>e}const bu=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function vu(s){return s<<24&4278190080|s<<8&16711680|s>>>8&65280|s>>>24&255}function Eu(s){for(let e=0;e<s.length;e++)s[e]=vu(s[e]);return s}const eo=bu?s=>s:Eu;function Iu(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function ac(s){return typeof s=="string"&&(s=Iu(s)),oi(s),s}function w2(...s){let e=0;for(let i=0;i<s.length;i++){const r=s[i];oi(r),e+=r.length}const t=new Uint8Array(e);for(let i=0,r=0;i<s.length;i++){const n=s[i];t.set(n,r),r+=n.length}return t}class xu{}function Du(s){const e=i=>s().update(ac(i)).digest(),t=s();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>s(),e}function b2(s=32){if(ns&&typeof ns.getRandomValues=="function")return ns.getRandomValues(new Uint8Array(s));if(ns&&typeof ns.randomBytes=="function")return Uint8Array.from(ns.randomBytes(s));throw new Error("crypto.getRandomValues must be defined")}const Pu=BigInt(0),ks=BigInt(1),Su=BigInt(2),_u=BigInt(7),$u=BigInt(256),Au=BigInt(113),cc=[],hc=[],lc=[];for(let s=0,e=ks,t=1,i=0;s<24;s++){[t,i]=[i,(2*t+3*i)%5],cc.push(2*(5*i+t)),hc.push((s+1)*(s+2)/2%64);let r=Pu;for(let n=0;n<7;n++)e=(e<<ks^(e>>_u)*Au)%$u,e&Su&&(r^=ks<<(ks<<BigInt(n))-ks);lc.push(r)}const uc=uu(lc,!0),Ou=uc[0],Cu=uc[1],to=(s,e,t)=>t>32?pu(s,e,t):du(s,e,t),so=(s,e,t)=>t>32?gu(s,e,t):fu(s,e,t);function Tu(s,e=24){const t=new Uint32Array(10);for(let i=24-e;i<24;i++){for(let o=0;o<10;o++)t[o]=s[o]^s[o+10]^s[o+20]^s[o+30]^s[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,h=t[c],l=t[c+1],u=to(h,l,1)^t[a],d=so(h,l,1)^t[a+1];for(let p=0;p<50;p+=10)s[o+p]^=u,s[o+p+1]^=d}let r=s[2],n=s[3];for(let o=0;o<24;o++){const a=hc[o],c=to(r,n,a),h=so(r,n,a),l=cc[o];r=s[l],n=s[l+1],s[l]=c,s[l+1]=h}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=s[o+a];for(let a=0;a<10;a++)s[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}s[0]^=Ou[i],s[1]^=Cu[i]}oc(t)}class En extends xu{constructor(e,t,i,r=!1,n=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=e,this.suffix=t,this.outputLen=i,this.enableXOF=r,this.rounds=n,ji(i),!(0<e&&e<200))throw new Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=wu(this.state)}clone(){return this._cloneInto()}keccak(){eo(this.state32),Tu(this.state32,this.rounds),eo(this.state32),this.posOut=0,this.pos=0}update(e){Xn(this),e=ac(e),oi(e);const{blockLen:t,state:i}=this,r=e.length;for(let n=0;n<r;){const o=Math.min(t-this.pos,r-n);for(let a=0;a<o;a++)i[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:e,suffix:t,pos:i,blockLen:r}=this;e[i]^=t,t&128&&i===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){Xn(this,!1),oi(e),this.finish();const t=this.state,{blockLen:i}=this;for(let r=0,n=e.length;r<n;){this.posOut>=i&&this.keccak();const o=Math.min(i-this.posOut,n-r);e.set(t.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return ji(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(mu(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,oc(this.state)}_cloneInto(e){const{blockLen:t,suffix:i,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new En(t,i,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=i,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}}const Ru=(s,e,t)=>Du(()=>new En(e,s,t)),Nu=Ru(1,136,256/8);function dc(s,e){const t=e||"hex",i=Nu(ni(s,{strict:!1})?au(s):s);return t==="bytes"?i:qr(i)}class Uu extends Map{constructor(e){super(),Object.defineProperty(this,"maxSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSize=e}get(e){const t=super.get(e);return super.has(e)&&t!==void 0&&(this.delete(e),super.set(e,t)),t}set(e,t){if(super.set(e,t),this.maxSize&&this.size>this.maxSize){const i=this.keys().next().value;i&&this.delete(i)}return this}}const cr=new Uu(8192);function ku(s,e){if(cr.has(`${s}.${e}`))return cr.get(`${s}.${e}`);const t=s.substring(2).toLowerCase(),i=dc(nc(t),"bytes"),r=t.split("");for(let o=0;o<40;o+=2)i[o>>1]>>4>=8&&r[o]&&(r[o]=r[o].toUpperCase()),(i[o>>1]&15)>=8&&r[o+1]&&(r[o+1]=r[o+1].toUpperCase());const n=`0x${r.join("")}`;return cr.set(`${s}.${e}`,n),n}function Bu(s){const e=dc(`0x${s.substring(4)}`).substring(26);return ku(`0x${e}`)}async function qu({hash:s,signature:e}){const t=ni(s)?s:qr(s),{secp256k1:i}=await el(async()=>{const{secp256k1:o}=await import("./secp256k1-BE_Or2wZ.js");return{secp256k1:o}},__vite__mapDeps([0,1,2]),import.meta.url);return`0x${(()=>{if(typeof e=="object"&&"r"in e&&"s"in e){const{r:h,s:l,v:u,yParity:d}=e,p=Number(d??u),f=io(p);return new i.Signature(Br(h),Br(l)).addRecoveryBit(f)}const o=ni(e)?e:qr(e);if(kr(o)!==65)throw new Error("invalid signature length");const a=tu(`0x${o.slice(130)}`),c=io(a);return i.Signature.fromCompact(o.substring(2,130)).addRecoveryBit(c)})().recoverPublicKey(t.substring(2)).toHex(!1)}`}function io(s){if(s===0||s===1)return s;if(s===27)return 0;if(s===28)return 1;throw new Error("Invalid yParityOrV value")}async function ju({hash:s,signature:e}){return Bu(await qu({hash:s,signature:e}))}function Lu(s){if(s.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let h=0;h<e.length;h++)e[h]=255;for(let h=0;h<s.length;h++){const l=s.charAt(h),u=l.charCodeAt(0);if(e[u]!==255)throw new TypeError(l+" is ambiguous");e[u]=h}const t=s.length,i=s.charAt(0),r=Math.log(t)/Math.log(256),n=Math.log(256)/Math.log(t);function o(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";let l=0,u=0,d=0;const p=h.length;for(;d!==p&&h[d]===0;)d++,l++;const f=(p-d)*n+1>>>0,g=new Uint8Array(f);for(;d!==p;){let E=h[d],S=0;for(let T=f-1;(E!==0||S<u)&&T!==-1;T--,S++)E+=256*g[T]>>>0,g[T]=E%t>>>0,E=E/t>>>0;if(E!==0)throw new Error("Non-zero carry");u=S,d++}let m=f-u;for(;m!==f&&g[m]===0;)m++;let x=i.repeat(l);for(;m<f;++m)x+=s.charAt(g[m]);return x}function a(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;let l=0,u=0,d=0;for(;h[l]===i;)u++,l++;const p=(h.length-l)*r+1>>>0,f=new Uint8Array(p);for(;l<h.length;){const E=h.charCodeAt(l);if(E>255)return;let S=e[E];if(S===255)return;let T=0;for(let I=p-1;(S!==0||T<d)&&I!==-1;I--,T++)S+=t*f[I]>>>0,f[I]=S%256>>>0,S=S/256>>>0;if(S!==0)throw new Error("Non-zero carry");d=T,l++}let g=p-d;for(;g!==p&&f[g]===0;)g++;const m=new Uint8Array(u+(p-g));let x=u;for(;g!==p;)m[x++]=f[g++];return m}function c(h){const l=a(h);if(l)return l;throw new Error("Non-base"+t+" character")}return{encode:o,decodeUnsafe:a,decode:c}}var Mu="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const fi=Lu(Mu);function zu(s){const e=s.length;let t=0,i=0;for(;i<e;){let r=s.charCodeAt(i++);if(r&4294967168)if(!(r&4294965248))t+=2;else{if(r>=55296&&r<=56319&&i<e){const n=s.charCodeAt(i);(n&64512)===56320&&(++i,r=((r&1023)<<10)+(n&1023)+65536)}r&4294901760?t+=4:t+=3}else{t++;continue}}return t}function Fu(s,e,t){const i=s.length;let r=t,n=0;for(;n<i;){let o=s.charCodeAt(n++);if(o&4294967168)if(!(o&4294965248))e[r++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&n<i){const a=s.charCodeAt(n);(a&64512)===56320&&(++n,o=((o&1023)<<10)+(a&1023)+65536)}o&4294901760?(e[r++]=o>>18&7|240,e[r++]=o>>12&63|128,e[r++]=o>>6&63|128):(e[r++]=o>>12&15|224,e[r++]=o>>6&63|128)}else{e[r++]=o;continue}e[r++]=o&63|128}}const Hu=new TextEncoder,Vu=50;function Ku(s,e,t){Hu.encodeInto(s,e.subarray(t))}function Gu(s,e,t){s.length>Vu?Ku(s,e,t):Fu(s,e,t)}const Wu=4096;function fc(s,e,t){let i=e;const r=i+t,n=[];let o="";for(;i<r;){const a=s[i++];if(!(a&128))n.push(a);else if((a&224)===192){const c=s[i++]&63;n.push((a&31)<<6|c)}else if((a&240)===224){const c=s[i++]&63,h=s[i++]&63;n.push((a&31)<<12|c<<6|h)}else if((a&248)===240){const c=s[i++]&63,h=s[i++]&63,l=s[i++]&63;let u=(a&7)<<18|c<<12|h<<6|l;u>65535&&(u-=65536,n.push(u>>>10&1023|55296),u=56320|u&1023),n.push(u)}else n.push(a);n.length>=Wu&&(o+=String.fromCharCode(...n),n.length=0)}return n.length>0&&(o+=String.fromCharCode(...n)),o}const Ju=new TextDecoder,Yu=200;function Zu(s,e,t){const i=s.subarray(e,e+t);return Ju.decode(i)}function Qu(s,e,t){return t>Yu?Zu(s,e,t):fc(s,e,t)}class Ei{constructor(e,t){this.type=e,this.data=t}}class qe extends Error{constructor(e){super(e);const t=Object.create(qe.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:qe.name})}}const Bs=4294967295;function Xu(s,e,t){const i=t/4294967296,r=t;s.setUint32(e,i),s.setUint32(e+4,r)}function pc(s,e,t){const i=Math.floor(t/4294967296),r=t;s.setUint32(e,i),s.setUint32(e+4,r)}function gc(s,e){const t=s.getInt32(e),i=s.getUint32(e+4);return t*4294967296+i}function ed(s,e){const t=s.getUint32(e),i=s.getUint32(e+4);return t*4294967296+i}const td=-1,sd=4294967296-1,id=17179869184-1;function rd({sec:s,nsec:e}){if(s>=0&&e>=0&&s<=id)if(e===0&&s<=sd){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,s),t}else{const t=s/4294967296,i=s&4294967295,r=new Uint8Array(8),n=new DataView(r.buffer);return n.setUint32(0,e<<2|t&3),n.setUint32(4,i),r}else{const t=new Uint8Array(12),i=new DataView(t.buffer);return i.setUint32(0,e),pc(i,4,s),t}}function nd(s){const e=s.getTime(),t=Math.floor(e/1e3),i=(e-t*1e3)*1e6,r=Math.floor(i/1e9);return{sec:t+r,nsec:i-r*1e9}}function od(s){if(s instanceof Date){const e=nd(s);return rd(e)}else return null}function ad(s){const e=new DataView(s.buffer,s.byteOffset,s.byteLength);switch(s.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{const t=e.getUint32(0),i=e.getUint32(4),r=(t&3)*4294967296+i,n=t>>>2;return{sec:r,nsec:n}}case 12:{const t=gc(e,4),i=e.getUint32(0);return{sec:t,nsec:i}}default:throw new qe(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${s.length}`)}}function cd(s){const e=ad(s);return new Date(e.sec*1e3+e.nsec/1e6)}const hd={type:td,encode:od,decode:cd};class Li{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(hd)}register({type:e,encode:t,decode:i}){if(e>=0)this.encoders[e]=t,this.decoders[e]=i;else{const r=-1-e;this.builtInEncoders[r]=t,this.builtInDecoders[r]=i}}tryToEncode(e,t){for(let i=0;i<this.builtInEncoders.length;i++){const r=this.builtInEncoders[i];if(r!=null){const n=r(e,t);if(n!=null){const o=-1-i;return new Ei(o,n)}}}for(let i=0;i<this.encoders.length;i++){const r=this.encoders[i];if(r!=null){const n=r(e,t);if(n!=null){const o=i;return new Ei(o,n)}}}return e instanceof Ei?e:null}decode(e,t,i){const r=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return r?r(e,t,i):new Ei(t,e)}}Li.defaultCodec=new Li;function ld(s){return s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer}function jr(s){return s instanceof Uint8Array?s:ArrayBuffer.isView(s)?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):ld(s)?new Uint8Array(s):Uint8Array.from(s)}const ud=100,dd=2048;let fd=class yc{constructor(e){this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Li.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.maxDepth=(e==null?void 0:e.maxDepth)??ud,this.initialBufferSize=(e==null?void 0:e.initialBufferSize)??dd,this.sortKeys=(e==null?void 0:e.sortKeys)??!1,this.forceFloat32=(e==null?void 0:e.forceFloat32)??!1,this.ignoreUndefined=(e==null?void 0:e.ignoreUndefined)??!1,this.forceIntegerToFloat=(e==null?void 0:e.forceIntegerToFloat)??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new yc({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){const t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){const t=new ArrayBuffer(e),i=new Uint8Array(t),r=new DataView(t);i.set(this.bytes),this.view=r,this.bytes=i}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){const i=zu(e);this.ensureBufferSizeToWrite(5+i),this.writeStringHeader(i),Gu(e,this.bytes,this.pos),this.pos+=i}encodeObject(e,t){const i=this.extensionCodec.tryToEncode(e,this.context);if(i!=null)this.encodeExtension(i);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){const t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);const i=jr(e);this.writeU8a(i)}encodeArray(e,t){const i=e.length;if(i<16)this.writeU8(144+i);else if(i<65536)this.writeU8(220),this.writeU16(i);else if(i<4294967296)this.writeU8(221),this.writeU32(i);else throw new Error(`Too large array: ${i}`);for(const r of e)this.doEncode(r,t+1)}countWithoutUndefined(e,t){let i=0;for(const r of t)e[r]!==void 0&&i++;return i}encodeMap(e,t){const i=Object.keys(e);this.sortKeys&&i.sort();const r=this.ignoreUndefined?this.countWithoutUndefined(e,i):i.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else if(r<4294967296)this.writeU8(223),this.writeU32(r);else throw new Error(`Too large map object: ${r}`);for(const n of i){const o=e[n];this.ignoreUndefined&&o===void 0||(this.encodeString(n),this.doEncode(o,t+1))}}encodeExtension(e){if(typeof e.data=="function"){const i=e.data(this.pos+6),r=i.length;if(r>=4294967296)throw new Error(`Too large extension object: ${r}`);this.writeU8(201),this.writeU32(r),this.writeI8(e.type),this.writeU8a(i);return}const t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){const t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),Xu(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),pc(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function pd(s,e){return new fd(e).encodeSharedRef(s)}function hr(s){return`${s<0?"-":""}0x${Math.abs(s).toString(16).padStart(2,"0")}`}const gd=16,yd=16;class md{constructor(e=gd,t=yd){this.hit=0,this.miss=0,this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let i=0;i<this.maxKeyLength;i++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,i){const r=this.caches[i-1];e:for(const n of r){const o=n.bytes;for(let a=0;a<i;a++)if(o[a]!==e[t+a])continue e;return n.str}return null}store(e,t){const i=this.caches[e.length-1],r={bytes:e,str:t};i.length>=this.maxLengthPerKey?i[Math.random()*i.length|0]=r:i.push(r)}decode(e,t,i){const r=this.find(e,t,i);if(r!=null)return this.hit++,r;this.miss++;const n=fc(e,t,i),o=Uint8Array.prototype.slice.call(e,t,t+i);return this.store(o,n),n}}const Lr="array",Ys="map_key",mc="map_value",wd=s=>{if(typeof s=="string"||typeof s=="number")return s;throw new qe("The type of key must be string or number but "+typeof s)};class bd{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){const t=this.getUninitializedStateFromPool();t.type=Lr,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){const t=this.getUninitializedStateFromPool();t.type=Ys,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){const e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===Lr){const i=e;i.size=0,i.array=void 0,i.position=0,i.type=void 0}if(e.type===Ys||e.type===mc){const i=e;i.size=0,i.map=void 0,i.readCount=0,i.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}const qs=-1,In=new DataView(new ArrayBuffer(0)),vd=new Uint8Array(In.buffer);try{In.getInt8(0)}catch(s){if(!(s instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}const ro=new RangeError("Insufficient data"),Ed=new md;let Id=class wc{constructor(e){this.totalPos=0,this.pos=0,this.view=In,this.bytes=vd,this.headByte=qs,this.stack=new bd,this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Li.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.rawStrings=(e==null?void 0:e.rawStrings)??!1,this.maxStrLength=(e==null?void 0:e.maxStrLength)??Bs,this.maxBinLength=(e==null?void 0:e.maxBinLength)??Bs,this.maxArrayLength=(e==null?void 0:e.maxArrayLength)??Bs,this.maxMapLength=(e==null?void 0:e.maxMapLength)??Bs,this.maxExtLength=(e==null?void 0:e.maxExtLength)??Bs,this.keyDecoder=(e==null?void 0:e.keyDecoder)!==void 0?e.keyDecoder:Ed,this.mapKeyConverter=(e==null?void 0:e.mapKeyConverter)??wd}clone(){return new wc({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=qs,this.stack.reset()}setBuffer(e){const t=jr(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===qs&&!this.hasRemaining(1))this.setBuffer(e);else{const t=this.bytes.subarray(this.pos),i=jr(e),r=new Uint8Array(t.length+i.length);r.set(t),r.set(i,t.length),this.setBuffer(r)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){const{view:t,pos:i}=this;return new RangeError(`Extra ${t.byteLength-i} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);const t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,i;for await(const a of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{i=this.doDecodeSync(),t=!0}catch(c){if(!(c instanceof RangeError))throw c}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return i}const{headByte:r,pos:n,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${hr(r)} at ${o} (${n} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let i=t,r=-1;for await(const n of e){if(t&&r===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(n),i&&(r=this.readArraySize(),i=!1,this.complete());try{for(;yield this.doDecodeSync(),--r!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){const e=this.readHeadByte();let t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){const r=e-128;if(r!==0){this.pushMapState(r),this.complete();continue e}else t={}}else if(e<160){const r=e-144;if(r!==0){this.pushArrayState(r),this.complete();continue e}else t=[]}else{const r=e-160;t=this.decodeString(r,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){const r=this.lookU8();t=this.decodeString(r,1)}else if(e===218){const r=this.lookU16();t=this.decodeString(r,2)}else if(e===219){const r=this.lookU32();t=this.decodeString(r,4)}else if(e===220){const r=this.readU16();if(r!==0){this.pushArrayState(r),this.complete();continue e}else t=[]}else if(e===221){const r=this.readU32();if(r!==0){this.pushArrayState(r),this.complete();continue e}else t=[]}else if(e===222){const r=this.readU16();if(r!==0){this.pushMapState(r),this.complete();continue e}else t={}}else if(e===223){const r=this.readU32();if(r!==0){this.pushMapState(r),this.complete();continue e}else t={}}else if(e===196){const r=this.lookU8();t=this.decodeBinary(r,1)}else if(e===197){const r=this.lookU16();t=this.decodeBinary(r,2)}else if(e===198){const r=this.lookU32();t=this.decodeBinary(r,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){const r=this.lookU8();t=this.decodeExtension(r,1)}else if(e===200){const r=this.lookU16();t=this.decodeExtension(r,2)}else if(e===201){const r=this.lookU32();t=this.decodeExtension(r,4)}else throw new qe(`Unrecognized type byte: ${hr(e)}`);this.complete();const i=this.stack;for(;i.length>0;){const r=i.top();if(r.type===Lr)if(r.array[r.position]=t,r.position++,r.position===r.size)t=r.array,i.release(r);else continue e;else if(r.type===Ys){if(t==="__proto__")throw new qe("The key __proto__ is not allowed");r.key=this.mapKeyConverter(t),r.type=mc;continue e}else if(r.map[r.key]=t,r.readCount++,r.readCount===r.size)t=r.map,i.release(r);else{r.key=null,r.type=Ys;continue e}}return t}}readHeadByte(){return this.headByte===qs&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=qs}readArraySize(){const e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new qe(`Unrecognized array type byte: ${hr(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new qe(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new qe(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){var n;if(e>this.maxStrLength)throw new qe(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw ro;const i=this.pos+t;let r;return this.stateIsMapKey()&&((n=this.keyDecoder)!=null&&n.canBeCached(e))?r=this.keyDecoder.decode(this.bytes,i,e):r=Qu(this.bytes,i,e),this.pos+=t+e,r}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===Ys:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new qe(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw ro;const i=this.pos+t,r=this.bytes.subarray(i,i+e);return this.pos+=t+e,r}decodeExtension(e,t){if(e>this.maxExtLength)throw new qe(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);const i=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,i,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){const e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){const e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){const e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){const e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){const e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){const e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){const e=ed(this.view,this.pos);return this.pos+=8,e}readI64(){const e=gc(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){const e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){const e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){const e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){const e=this.view.getFloat64(this.pos);return this.pos+=8,e}};function xd(s,e){return new Id(e).decode(s)}function xn(s){return globalThis.Buffer!=null?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):s}function bc(s=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?xn(globalThis.Buffer.allocUnsafe(s)):new Uint8Array(s)}function Zs(s,e){e||(e=s.reduce((r,n)=>r+n.length,0));const t=bc(e);let i=0;for(const r of s)t.set(r,i),i+=r.length;return xn(t)}function Dd(s,e){if(s.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var r=0;r<s.length;r++){var n=s.charAt(r),o=n.charCodeAt(0);if(t[o]!==255)throw new TypeError(n+" is ambiguous");t[o]=r}var a=s.length,c=s.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,m=0,x=0,E=f.length;x!==E&&f[x]===0;)x++,g++;for(var S=(E-x)*l+1>>>0,T=new Uint8Array(S);x!==E;){for(var I=f[x],R=0,B=S-1;(I!==0||R<m)&&B!==-1;B--,R++)I+=256*T[B]>>>0,T[B]=I%a>>>0,I=I/a>>>0;if(I!==0)throw new Error("Non-zero carry");m=R,x++}for(var C=S-m;C!==S&&T[C]===0;)C++;for(var y=c.repeat(g);C<S;++C)y+=s.charAt(T[C]);return y}function d(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var m=0,x=0;f[g]===c;)m++,g++;for(var E=(f.length-g)*h+1>>>0,S=new Uint8Array(E);f[g];){var T=t[f.charCodeAt(g)];if(T===255)return;for(var I=0,R=E-1;(T!==0||I<x)&&R!==-1;R--,I++)T+=a*S[R]>>>0,S[R]=T%256>>>0,T=T/256>>>0;if(T!==0)throw new Error("Non-zero carry");x=I,g++}if(f[g]!==" "){for(var B=E-x;B!==E&&S[B]===0;)B++;for(var C=new Uint8Array(m+(E-B)),y=m;B!==E;)C[y++]=S[B++];return C}}}function p(f){var g=d(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:d,decode:p}}var Pd=Dd,Sd=Pd;const _d=s=>{if(s instanceof Uint8Array&&s.constructor.name==="Uint8Array")return s;if(s instanceof ArrayBuffer)return new Uint8Array(s);if(ArrayBuffer.isView(s))return new Uint8Array(s.buffer,s.byteOffset,s.byteLength);throw new Error("Unknown type, must be binary type")},$d=s=>new TextEncoder().encode(s),Ad=s=>new TextDecoder().decode(s);class Od{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Cd{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return vc(this,e)}}class Td{constructor(e){this.decoders=e}or(e){return vc(this,e)}decode(e){const t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const vc=(s,e)=>new Td({...s.decoders||{[s.prefix]:s},...e.decoders||{[e.prefix]:e}});class Rd{constructor(e,t,i,r){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=r,this.encoder=new Od(e,t,i),this.decoder=new Cd(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Ji=({name:s,prefix:e,encode:t,decode:i})=>new Rd(s,e,t,i),pi=({prefix:s,name:e,alphabet:t})=>{const{encode:i,decode:r}=Sd(t,e);return Ji({prefix:s,name:e,encode:i,decode:n=>_d(r(n))})},Nd=(s,e,t,i)=>{const r={};for(let l=0;l<e.length;++l)r[e[l]]=l;let n=s.length;for(;s[n-1]==="=";)--n;const o=new Uint8Array(n*t/8|0);let a=0,c=0,h=0;for(let l=0;l<n;++l){const u=r[s[l]];if(u===void 0)throw new SyntaxError(`Non-${i} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Ud=(s,e,t)=>{const i=e[e.length-1]==="=",r=(1<<t)-1;let n="",o=0,a=0;for(let c=0;c<s.length;++c)for(a=a<<8|s[c],o+=8;o>t;)o-=t,n+=e[r&a>>o];if(o&&(n+=e[r&a<<t-o]),i)for(;n.length*t&7;)n+="=";return n},we=({name:s,prefix:e,bitsPerChar:t,alphabet:i})=>Ji({prefix:e,name:s,encode(r){return Ud(r,i,t)},decode(r){return Nd(r,i,t,s)}}),kd=Ji({prefix:"\0",name:"identity",encode:s=>Ad(s),decode:s=>$d(s)}),Bd=Object.freeze(Object.defineProperty({__proto__:null,identity:kd},Symbol.toStringTag,{value:"Module"})),qd=we({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),jd=Object.freeze(Object.defineProperty({__proto__:null,base2:qd},Symbol.toStringTag,{value:"Module"})),Ld=we({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Md=Object.freeze(Object.defineProperty({__proto__:null,base8:Ld},Symbol.toStringTag,{value:"Module"})),zd=pi({prefix:"9",name:"base10",alphabet:"0123456789"}),Fd=Object.freeze(Object.defineProperty({__proto__:null,base10:zd},Symbol.toStringTag,{value:"Module"})),Hd=we({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Vd=we({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Kd=Object.freeze(Object.defineProperty({__proto__:null,base16:Hd,base16upper:Vd},Symbol.toStringTag,{value:"Module"})),Gd=we({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Wd=we({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Jd=we({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Yd=we({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Zd=we({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Qd=we({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Xd=we({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ef=we({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),tf=we({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),sf=Object.freeze(Object.defineProperty({__proto__:null,base32:Gd,base32hex:Zd,base32hexpad:Xd,base32hexpadupper:ef,base32hexupper:Qd,base32pad:Jd,base32padupper:Yd,base32upper:Wd,base32z:tf},Symbol.toStringTag,{value:"Module"})),rf=pi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),nf=pi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),of=Object.freeze(Object.defineProperty({__proto__:null,base36:rf,base36upper:nf},Symbol.toStringTag,{value:"Module"})),af=pi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),cf=pi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),hf=Object.freeze(Object.defineProperty({__proto__:null,base58btc:af,base58flickr:cf},Symbol.toStringTag,{value:"Module"})),lf=we({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),uf=we({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),df=we({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ff=we({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),pf=Object.freeze(Object.defineProperty({__proto__:null,base64:lf,base64pad:uf,base64url:df,base64urlpad:ff},Symbol.toStringTag,{value:"Module"})),Ec=Array.from(""),gf=Ec.reduce((s,e,t)=>(s[t]=e,s),[]),yf=Ec.reduce((s,e,t)=>(s[e.codePointAt(0)]=t,s),[]);function mf(s){return s.reduce((e,t)=>(e+=gf[t],e),"")}function wf(s){const e=[];for(const t of s){const i=yf[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const bf=Ji({prefix:"",name:"base256emoji",encode:mf,decode:wf}),vf=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:bf},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const no={...Bd,...jd,...Md,...Fd,...Kd,...sf,...of,...hf,...pf,...vf};function Ic(s,e,t,i){return{name:s,prefix:e,encoder:{name:s,prefix:e,encode:t},decoder:{decode:i}}}const oo=Ic("utf8","u",s=>"u"+new TextDecoder("utf8").decode(s),s=>new TextEncoder().encode(s.substring(1))),lr=Ic("ascii","a",s=>{let e="a";for(let t=0;t<s.length;t++)e+=String.fromCharCode(s[t]);return e},s=>{s=s.substring(1);const e=bc(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}),xc={utf8:oo,"utf-8":oo,hex:no.base16,latin1:lr,ascii:lr,binary:lr,...no};function We(s,e="utf8"){const t=xc[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?xn(globalThis.Buffer.from(s,"utf-8")):t.decoder.decode(`${t.prefix}${s}`)}function Ne(s,e="utf8"){const t=xc[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(s.buffer,s.byteOffset,s.byteLength).toString("utf8"):t.encoder.encode(s).substring(1)}var Ef={};const If=":";function jt(s){const[e,t]=s.split(If);return{namespace:e,reference:t}}function Dc(s,e){return s.includes(":")?[s]:e.chains||[]}var xf=Object.defineProperty,Df=Object.defineProperties,Pf=Object.getOwnPropertyDescriptors,ao=Object.getOwnPropertySymbols,Sf=Object.prototype.hasOwnProperty,_f=Object.prototype.propertyIsEnumerable,Mr=(s,e,t)=>e in s?xf(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,co=(s,e)=>{for(var t in e||(e={}))Sf.call(e,t)&&Mr(s,t,e[t]);if(ao)for(var t of ao(e))_f.call(e,t)&&Mr(s,t,e[t]);return s},$f=(s,e)=>Df(s,Pf(e)),ho=(s,e,t)=>Mr(s,typeof e!="symbol"?e+"":e,t);const Af="ReactNative",je={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"},Of="js";function Mi(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function zt(){return!Ps()&&!!Ya()&&navigator.product===Af}function Cf(){return zt()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="android"}function Tf(){return zt()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="ios"}function Os(){return!Mi()&&!!Ya()&&!!Ps()}function gi(){return zt()?je.reactNative:Mi()?je.node:Os()?je.browser:je.unknown}function lo(){var s;try{return zt()&&typeof global<"u"&&typeof(global==null?void 0:global.Application)<"u"?(s=global.Application)==null?void 0:s.applicationId:void 0}catch{return}}function Rf(s,e){const t=new URLSearchParams(s);for(const i of Object.keys(e).sort())if(e.hasOwnProperty(i)){const r=e[i];r!==void 0&&t.set(i,r)}return t.toString()}function Nf(s){var e,t;const i=Pc();try{return s!=null&&s.url&&i.url&&new URL(s.url).host!==new URL(i.url).host&&(console.warn(`The configured WalletConnect 'metadata.url':${s.url} differs from the actual page url:${i.url}. This is probably unintended and can lead to issues.`),s.url=i.url),(e=s==null?void 0:s.icons)!=null&&e.length&&s.icons.length>0&&(s.icons=s.icons.filter(r=>r!=="")),$f(co(co({},i),s),{url:(s==null?void 0:s.url)||i.url,name:(s==null?void 0:s.name)||i.name,description:(s==null?void 0:s.description)||i.description,icons:(t=s==null?void 0:s.icons)!=null&&t.length&&s.icons.length>0?s.icons:i.icons})}catch(r){return console.warn("Error populating app metadata",r),s||i}}function Pc(){return tl()||{name:"",description:"",url:"",icons:[""]}}function Uf(){if(gi()===je.reactNative&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"){const{OS:t,Version:i}=global.Platform;return[t,i].join("-")}const s=il();if(s===null)return"unknown";const e=s.os?s.os.replace(" ","").toLowerCase():"unknown";return s.type==="browser"?[e,s.name,s.version].join("-"):[e,s.version].join("-")}function kf(){var s;const e=gi();return e===je.browser?[e,((s=rl())==null?void 0:s.host)||"unknown"].join(":"):e}function Sc(s,e,t){const i=Uf(),r=kf();return[[s,e].join("-"),[Of,t].join("-"),i,r].join("/")}function Bf({protocol:s,version:e,relayUrl:t,sdkVersion:i,auth:r,projectId:n,useOnCloseEvent:o,bundleId:a,packageName:c}){const h=t.split("?"),l=Sc(s,e,i),u={auth:r,ua:l,projectId:n,useOnCloseEvent:o,packageName:c||void 0,bundleId:a||void 0},d=Rf(h[1]||"",u);return h[0]+"?"+d}function Wt(s,e){return s.filter(t=>e.includes(t)).length===s.length}function zr(s){return Object.fromEntries(s.entries())}function Fr(s){return new Map(Object.entries(s))}function Vt(s=k.FIVE_MINUTES,e){const t=k.toMiliseconds(s||k.FIVE_MINUTES);let i,r,n,o;return{resolve:a=>{n&&i&&(clearTimeout(n),i(a),o=Promise.resolve(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,c)=>{if(o)return a(o);n=setTimeout(()=>{const h=new Error(e);o=Promise.reject(h),c(h)},t),i=a,r=c})}}function ut(s,e,t){return new Promise(async(i,r)=>{const n=setTimeout(()=>r(new Error(t)),e);try{const o=await s;i(o)}catch(o){r(o)}clearTimeout(n)})}function _c(s,e){if(typeof e=="string"&&e.startsWith(`${s}:`))return e;if(s.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(s.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${s}`)}function qf(s){return _c("topic",s)}function jf(s){return _c("id",s)}function $c(s){const[e,t]=s.split(":"),i={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")i.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))i.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return i}function he(s,e){return k.fromMiliseconds(Date.now()+k.toMiliseconds(s))}function lt(s){return Date.now()>=k.toMiliseconds(s)}function Z(s,e){return`${s}${e?`:${e}`:""}`}function dt(s=[],e=[]){return[...new Set([...s,...e])]}async function Lf({id:s,topic:e,wcDeepLink:t}){var i;try{if(!t)return;const r=typeof t=="string"?JSON.parse(t):t,n=r==null?void 0:r.href;if(typeof n!="string")return;const o=Mf(n,s,e),a=gi();if(a===je.browser){if(!((i=Ps())!=null&&i.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}zf(o)}else a===je.reactNative&&typeof(global==null?void 0:global.Linking)<"u"&&await global.Linking.openURL(o)}catch(r){console.error(r)}}function Mf(s,e,t){const i=`requestId=${e}&sessionTopic=${t}`;s.endsWith("/")&&(s=s.slice(0,-1));let r=`${s}`;if(s.startsWith("https://t.me")){const n=s.includes("?")?"&startapp=":"?startapp=";r=`${r}${n}${Kf(i,!0)}`}else r=`${r}/wc?${i}`;return r}function zf(s){let e="_self";Vf()?e="_top":(Hf()||s.startsWith("https://")||s.startsWith("http://"))&&(e="_blank"),window.open(s,e,"noreferrer noopener")}async function Ff(s,e){let t="";try{if(Os()&&(t=localStorage.getItem(e),t))return t;t=await s.getItem(e)}catch(i){console.error(i)}return t}function uo(s,e){if(!s.includes(e))return null;const t=s.split(/([&,?,=])/),i=t.indexOf(e);return t[i+2]}function fo(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function Dn(){return typeof process<"u"&&Ef.IS_VITEST==="true"}function Hf(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function Vf(){try{return window.self!==window.top}catch{return!1}}function Kf(s,e=!1){const t=Buffer.from(s).toString("base64");return e?t.replace(/[=]/g,""):t}function Ac(s){return Buffer.from(s,"base64").toString("utf-8")}function Gf(s){return new Promise(e=>setTimeout(e,s))}let Wf=class{constructor({limit:e}){ho(this,"limit"),ho(this,"set"),this.limit=e,this.set=new Set}add(e){if(!this.set.has(e)){if(this.set.size>=this.limit){const t=this.set.values().next().value;t&&this.set.delete(t)}this.set.add(e)}}has(e){return this.set.has(e)}};const Ii=BigInt(2**32-1),po=BigInt(32);function Oc(s,e=!1){return e?{h:Number(s&Ii),l:Number(s>>po&Ii)}:{h:Number(s>>po&Ii)|0,l:Number(s&Ii)|0}}function Cc(s,e=!1){const t=s.length;let i=new Uint32Array(t),r=new Uint32Array(t);for(let n=0;n<t;n++){const{h:o,l:a}=Oc(s[n],e);[i[n],r[n]]=[o,a]}return[i,r]}const go=(s,e,t)=>s>>>t,yo=(s,e,t)=>s<<32-t|e>>>t,Nt=(s,e,t)=>s>>>t|e<<32-t,Ut=(s,e,t)=>s<<32-t|e>>>t,Gs=(s,e,t)=>s<<64-t|e>>>t-32,Ws=(s,e,t)=>s>>>t-32|e<<64-t,Jf=(s,e)=>e,Yf=(s,e)=>s,Zf=(s,e,t)=>s<<t|e>>>32-t,Qf=(s,e,t)=>e<<t|s>>>32-t,Xf=(s,e,t)=>e<<t-32|s>>>64-t,ep=(s,e,t)=>s<<t-32|e>>>64-t;function tt(s,e,t,i){const r=(e>>>0)+(i>>>0);return{h:s+t+(r/2**32|0)|0,l:r|0}}const Pn=(s,e,t)=>(s>>>0)+(e>>>0)+(t>>>0),Sn=(s,e,t,i)=>e+t+i+(s/2**32|0)|0,tp=(s,e,t,i)=>(s>>>0)+(e>>>0)+(t>>>0)+(i>>>0),sp=(s,e,t,i,r)=>e+t+i+r+(s/2**32|0)|0,ip=(s,e,t,i,r)=>(s>>>0)+(e>>>0)+(t>>>0)+(i>>>0)+(r>>>0),rp=(s,e,t,i,r,n)=>e+t+i+r+n+(s/2**32|0)|0,os=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function _n(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function Pt(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function Je(s,...e){if(!_n(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function $n(s){if(typeof s!="function"||typeof s.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Pt(s.outputLen),Pt(s.blockLen)}function Mt(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function An(s,e){Je(s);const t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ai(s){return new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4))}function Ye(...s){for(let e=0;e<s.length;e++)s[e].fill(0)}function ur(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}function ot(s,e){return s<<32-e|s>>>e}const Tc=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Rc(s){return s<<24&4278190080|s<<8&16711680|s>>>8&65280|s>>>24&255}const vt=Tc?s=>s:s=>Rc(s);function np(s){for(let e=0;e<s.length;e++)s[e]=Rc(s[e]);return s}const kt=Tc?s=>s:np,Nc=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",op=Array.from({length:256},(s,e)=>e.toString(16).padStart(2,"0"));function ci(s){if(Je(s),Nc)return s.toHex();let e="";for(let t=0;t<s.length;t++)e+=op[s[t]];return e}const wt={_0:48,_9:57,A:65,F:70,a:97,f:102};function mo(s){if(s>=wt._0&&s<=wt._9)return s-wt._0;if(s>=wt.A&&s<=wt.F)return s-(wt.A-10);if(s>=wt.a&&s<=wt.f)return s-(wt.a-10)}function On(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);if(Nc)return Uint8Array.fromHex(s);const e=s.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const i=new Uint8Array(t);for(let r=0,n=0;r<t;r++,n+=2){const o=mo(s.charCodeAt(n)),a=mo(s.charCodeAt(n+1));if(o===void 0||a===void 0){const c=s[n]+s[n+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+n)}i[r]=o*16+a}return i}function ap(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function rt(s){return typeof s=="string"&&(s=ap(s)),Je(s),s}function Jt(...s){let e=0;for(let i=0;i<s.length;i++){const r=s[i];Je(r),e+=r.length}const t=new Uint8Array(e);for(let i=0,r=0;i<s.length;i++){const n=s[i];t.set(n,r),r+=n.length}return t}let Yi=class{};function yi(s){const e=i=>s().update(rt(i)).digest(),t=s();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>s(),e}function cp(s){const e=(i,r)=>s(r).update(rt(i)).digest(),t=s({});return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=i=>s(i),e}function Cs(s=32){if(os&&typeof os.getRandomValues=="function")return os.getRandomValues(new Uint8Array(s));if(os&&typeof os.randomBytes=="function")return Uint8Array.from(os.randomBytes(s));throw new Error("crypto.getRandomValues must be defined")}const hp=BigInt(0),js=BigInt(1),lp=BigInt(2),up=BigInt(7),dp=BigInt(256),fp=BigInt(113),Uc=[],kc=[],Bc=[];for(let s=0,e=js,t=1,i=0;s<24;s++){[t,i]=[i,(2*t+3*i)%5],Uc.push(2*(5*i+t)),kc.push((s+1)*(s+2)/2%64);let r=hp;for(let n=0;n<7;n++)e=(e<<js^(e>>up)*fp)%dp,e&lp&&(r^=js<<(js<<BigInt(n))-js);Bc.push(r)}const qc=Cc(Bc,!0),pp=qc[0],gp=qc[1],wo=(s,e,t)=>t>32?Xf(s,e,t):Zf(s,e,t),bo=(s,e,t)=>t>32?ep(s,e,t):Qf(s,e,t);function yp(s,e=24){const t=new Uint32Array(10);for(let i=24-e;i<24;i++){for(let o=0;o<10;o++)t[o]=s[o]^s[o+10]^s[o+20]^s[o+30]^s[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,h=t[c],l=t[c+1],u=wo(h,l,1)^t[a],d=bo(h,l,1)^t[a+1];for(let p=0;p<50;p+=10)s[o+p]^=u,s[o+p+1]^=d}let r=s[2],n=s[3];for(let o=0;o<24;o++){const a=kc[o],c=wo(r,n,a),h=bo(r,n,a),l=Uc[o];r=s[l],n=s[l+1],s[l]=c,s[l+1]=h}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=s[o+a];for(let a=0;a<10;a++)s[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}s[0]^=pp[i],s[1]^=gp[i]}Ye(t)}let mp=class jc extends Yi{constructor(e,t,i,r=!1,n=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=e,this.suffix=t,this.outputLen=i,this.enableXOF=r,this.rounds=n,Pt(i),!(0<e&&e<200))throw new Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=ai(this.state)}clone(){return this._cloneInto()}keccak(){kt(this.state32),yp(this.state32,this.rounds),kt(this.state32),this.posOut=0,this.pos=0}update(e){Mt(this),e=rt(e),Je(e);const{blockLen:t,state:i}=this,r=e.length;for(let n=0;n<r;){const o=Math.min(t-this.pos,r-n);for(let a=0;a<o;a++)i[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:e,suffix:t,pos:i,blockLen:r}=this;e[i]^=t,t&128&&i===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){Mt(this,!1),Je(e),this.finish();const t=this.state,{blockLen:i}=this;for(let r=0,n=e.length;r<n;){this.posOut>=i&&this.keccak();const o=Math.min(i-this.posOut,n-r);e.set(t.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return Pt(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(An(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,Ye(this.state)}_cloneInto(e){const{blockLen:t,suffix:i,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new jc(t,i,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=i,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}};const wp=(s,e,t)=>yi(()=>new mp(e,s,t)),bp=wp(1,136,256/8);function vp(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);const r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=i?4:0,h=i?0:4;s.setUint32(e+c,o,i),s.setUint32(e+h,a,i)}function Ep(s,e,t){return s&e^~s&t}function Ip(s,e,t){return s&e^s&t^e&t}let Lc=class extends Yi{constructor(e,t,i,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=i,this.isLE=r,this.buffer=new Uint8Array(e),this.view=ur(this.buffer)}update(e){Mt(this),e=rt(e),Je(e);const{view:t,buffer:i,blockLen:r}=this,n=e.length;for(let o=0;o<n;){const a=Math.min(r-this.pos,n-o);if(a===r){const c=ur(e);for(;r<=n-o;o+=r)this.process(c,o);continue}i.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Mt(this),An(e,this),this.finished=!0;const{buffer:t,view:i,blockLen:r,isLE:n}=this;let{pos:o}=this;t[o++]=128,Ye(this.buffer.subarray(o)),this.padOffset>r-o&&(this.process(i,0),o=0);for(let u=o;u<r;u++)t[u]=0;vp(i,r-8,BigInt(this.length*8),n),this.process(i,0);const a=ur(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const h=c/4,l=this.get();if(h>l.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<h;u++)a.setUint32(4*u,l[u],n)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const i=e.slice(0,t);return this.destroy(),i}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:i,length:r,finished:n,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=n,e.length=r,e.pos=a,r%t&&e.buffer.set(i),e}clone(){return this._cloneInto()}};const _t=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ve=Uint32Array.from([3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]),Ee=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),xp=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),$t=new Uint32Array(64);let Dp=class extends Lc{constructor(e=32){super(64,e,8,!1),this.A=_t[0]|0,this.B=_t[1]|0,this.C=_t[2]|0,this.D=_t[3]|0,this.E=_t[4]|0,this.F=_t[5]|0,this.G=_t[6]|0,this.H=_t[7]|0}get(){const{A:e,B:t,C:i,D:r,E:n,F:o,G:a,H:c}=this;return[e,t,i,r,n,o,a,c]}set(e,t,i,r,n,o,a,c){this.A=e|0,this.B=t|0,this.C=i|0,this.D=r|0,this.E=n|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let u=0;u<16;u++,t+=4)$t[u]=e.getUint32(t,!1);for(let u=16;u<64;u++){const d=$t[u-15],p=$t[u-2],f=ot(d,7)^ot(d,18)^d>>>3,g=ot(p,17)^ot(p,19)^p>>>10;$t[u]=g+$t[u-7]+f+$t[u-16]|0}let{A:i,B:r,C:n,D:o,E:a,F:c,G:h,H:l}=this;for(let u=0;u<64;u++){const d=ot(a,6)^ot(a,11)^ot(a,25),p=l+d+Ep(a,c,h)+xp[u]+$t[u]|0,f=(ot(i,2)^ot(i,13)^ot(i,22))+Ip(i,r,n)|0;l=h,h=c,c=a,a=o+p|0,o=n,n=r,r=i,i=p+f|0}i=i+this.A|0,r=r+this.B|0,n=n+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,h=h+this.G|0,l=l+this.H|0,this.set(i,r,n,o,a,c,h,l)}roundClean(){Ye($t)}destroy(){this.set(0,0,0,0,0,0,0,0),Ye(this.buffer)}};const Mc=Cc(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(s=>BigInt(s))),Pp=Mc[0],Sp=Mc[1],At=new Uint32Array(80),Ot=new Uint32Array(80);let Cn=class extends Lc{constructor(e=64){super(128,e,16,!1),this.Ah=Ee[0]|0,this.Al=Ee[1]|0,this.Bh=Ee[2]|0,this.Bl=Ee[3]|0,this.Ch=Ee[4]|0,this.Cl=Ee[5]|0,this.Dh=Ee[6]|0,this.Dl=Ee[7]|0,this.Eh=Ee[8]|0,this.El=Ee[9]|0,this.Fh=Ee[10]|0,this.Fl=Ee[11]|0,this.Gh=Ee[12]|0,this.Gl=Ee[13]|0,this.Hh=Ee[14]|0,this.Hl=Ee[15]|0}get(){const{Ah:e,Al:t,Bh:i,Bl:r,Ch:n,Cl:o,Dh:a,Dl:c,Eh:h,El:l,Fh:u,Fl:d,Gh:p,Gl:f,Hh:g,Hl:m}=this;return[e,t,i,r,n,o,a,c,h,l,u,d,p,f,g,m]}set(e,t,i,r,n,o,a,c,h,l,u,d,p,f,g,m){this.Ah=e|0,this.Al=t|0,this.Bh=i|0,this.Bl=r|0,this.Ch=n|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=h|0,this.El=l|0,this.Fh=u|0,this.Fl=d|0,this.Gh=p|0,this.Gl=f|0,this.Hh=g|0,this.Hl=m|0}process(e,t){for(let S=0;S<16;S++,t+=4)At[S]=e.getUint32(t),Ot[S]=e.getUint32(t+=4);for(let S=16;S<80;S++){const T=At[S-15]|0,I=Ot[S-15]|0,R=Nt(T,I,1)^Nt(T,I,8)^go(T,I,7),B=Ut(T,I,1)^Ut(T,I,8)^yo(T,I,7),C=At[S-2]|0,y=Ot[S-2]|0,v=Nt(C,y,19)^Gs(C,y,61)^go(C,y,6),w=Ut(C,y,19)^Ws(C,y,61)^yo(C,y,6),b=tp(B,w,Ot[S-7],Ot[S-16]),D=sp(b,R,v,At[S-7],At[S-16]);At[S]=D|0,Ot[S]=b|0}let{Ah:i,Al:r,Bh:n,Bl:o,Ch:a,Cl:c,Dh:h,Dl:l,Eh:u,El:d,Fh:p,Fl:f,Gh:g,Gl:m,Hh:x,Hl:E}=this;for(let S=0;S<80;S++){const T=Nt(u,d,14)^Nt(u,d,18)^Gs(u,d,41),I=Ut(u,d,14)^Ut(u,d,18)^Ws(u,d,41),R=u&p^~u&g,B=d&f^~d&m,C=ip(E,I,B,Sp[S],Ot[S]),y=rp(C,x,T,R,Pp[S],At[S]),v=C|0,w=Nt(i,r,28)^Gs(i,r,34)^Gs(i,r,39),b=Ut(i,r,28)^Ws(i,r,34)^Ws(i,r,39),D=i&n^i&a^n&a,A=r&o^r&c^o&c;x=g|0,E=m|0,g=p|0,m=f|0,p=u|0,f=d|0,{h:u,l:d}=tt(h|0,l|0,y|0,v|0),h=a|0,l=c|0,a=n|0,c=o|0,n=i|0,o=r|0;const $=Pn(v,b,A);i=Sn($,y,w,D),r=$|0}({h:i,l:r}=tt(this.Ah|0,this.Al|0,i|0,r|0)),{h:n,l:o}=tt(this.Bh|0,this.Bl|0,n|0,o|0),{h:a,l:c}=tt(this.Ch|0,this.Cl|0,a|0,c|0),{h,l}=tt(this.Dh|0,this.Dl|0,h|0,l|0),{h:u,l:d}=tt(this.Eh|0,this.El|0,u|0,d|0),{h:p,l:f}=tt(this.Fh|0,this.Fl|0,p|0,f|0),{h:g,l:m}=tt(this.Gh|0,this.Gl|0,g|0,m|0),{h:x,l:E}=tt(this.Hh|0,this.Hl|0,x|0,E|0),this.set(i,r,n,o,a,c,h,l,u,d,p,f,g,m,x,E)}roundClean(){Ye(At,Ot)}destroy(){Ye(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},_p=class extends Cn{constructor(){super(48),this.Ah=ve[0]|0,this.Al=ve[1]|0,this.Bh=ve[2]|0,this.Bl=ve[3]|0,this.Ch=ve[4]|0,this.Cl=ve[5]|0,this.Dh=ve[6]|0,this.Dl=ve[7]|0,this.Eh=ve[8]|0,this.El=ve[9]|0,this.Fh=ve[10]|0,this.Fl=ve[11]|0,this.Gh=ve[12]|0,this.Gl=ve[13]|0,this.Hh=ve[14]|0,this.Hl=ve[15]|0}};const Ie=Uint32Array.from([573645204,4230739756,2673172387,3360449730,596883563,1867755857,2520282905,1497426621,2519219938,2827943907,3193839141,1401305490,721525244,746961066,246885852,2177182882]);class $p extends Cn{constructor(){super(32),this.Ah=Ie[0]|0,this.Al=Ie[1]|0,this.Bh=Ie[2]|0,this.Bl=Ie[3]|0,this.Ch=Ie[4]|0,this.Cl=Ie[5]|0,this.Dh=Ie[6]|0,this.Dl=Ie[7]|0,this.Eh=Ie[8]|0,this.El=Ie[9]|0,this.Fh=Ie[10]|0,this.Fl=Ie[11]|0,this.Gh=Ie[12]|0,this.Gl=Ie[13]|0,this.Hh=Ie[14]|0,this.Hl=Ie[15]|0}}const Zi=yi(()=>new Dp),Ap=yi(()=>new Cn),Op=yi(()=>new _p),Cp=yi(()=>new $p),Tp=Uint8Array.from([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9]),ue=Uint32Array.from([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),q=new Uint32Array(32);function Ct(s,e,t,i,r,n){const o=r[n],a=r[n+1];let c=q[2*s],h=q[2*s+1],l=q[2*e],u=q[2*e+1],d=q[2*t],p=q[2*t+1],f=q[2*i],g=q[2*i+1],m=Pn(c,l,o);h=Sn(m,h,u,a),c=m|0,{Dh:g,Dl:f}={Dh:g^h,Dl:f^c},{Dh:g,Dl:f}={Dh:Jf(g,f),Dl:Yf(g)},{h:p,l:d}=tt(p,d,g,f),{Bh:u,Bl:l}={Bh:u^p,Bl:l^d},{Bh:u,Bl:l}={Bh:Nt(u,l,24),Bl:Ut(u,l,24)},q[2*s]=c,q[2*s+1]=h,q[2*e]=l,q[2*e+1]=u,q[2*t]=d,q[2*t+1]=p,q[2*i]=f,q[2*i+1]=g}function Tt(s,e,t,i,r,n){const o=r[n],a=r[n+1];let c=q[2*s],h=q[2*s+1],l=q[2*e],u=q[2*e+1],d=q[2*t],p=q[2*t+1],f=q[2*i],g=q[2*i+1],m=Pn(c,l,o);h=Sn(m,h,u,a),c=m|0,{Dh:g,Dl:f}={Dh:g^h,Dl:f^c},{Dh:g,Dl:f}={Dh:Nt(g,f,16),Dl:Ut(g,f,16)},{h:p,l:d}=tt(p,d,g,f),{Bh:u,Bl:l}={Bh:u^p,Bl:l^d},{Bh:u,Bl:l}={Bh:Gs(u,l,63),Bl:Ws(u,l,63)},q[2*s]=c,q[2*s+1]=h,q[2*e]=l,q[2*e+1]=u,q[2*t]=d,q[2*t+1]=p,q[2*i]=f,q[2*i+1]=g}function Rp(s,e={},t,i,r){if(Pt(t),s<0||s>t)throw new Error("outputLen bigger than keyLen");const{key:n,salt:o,personalization:a}=e;if(n!==void 0&&(n.length<1||n.length>t))throw new Error("key length must be undefined or 1.."+t);if(o!==void 0&&o.length!==i)throw new Error("salt must be undefined or "+i);if(a!==void 0&&a.length!==r)throw new Error("personalization must be undefined or "+r)}class Np extends Yi{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,this.length=0,this.pos=0,Pt(e),Pt(t),this.blockLen=e,this.outputLen=t,this.buffer=new Uint8Array(e),this.buffer32=ai(this.buffer)}update(e){Mt(this),e=rt(e),Je(e);const{blockLen:t,buffer:i,buffer32:r}=this,n=e.length,o=e.byteOffset,a=e.buffer;for(let c=0;c<n;){this.pos===t&&(kt(r),this.compress(r,0,!1),kt(r),this.pos=0);const h=Math.min(t-this.pos,n-c),l=o+c;if(h===t&&!(l%4)&&c+h<n){const u=new Uint32Array(a,l,Math.floor((n-c)/4));kt(u);for(let d=0;c+t<n;d+=r.length,c+=t)this.length+=t,this.compress(u,d,!1);kt(u);continue}i.set(e.subarray(c,c+h),this.pos),this.pos+=h,this.length+=h,c+=h}return this}digestInto(e){Mt(this),An(e,this);const{pos:t,buffer32:i}=this;this.finished=!0,Ye(this.buffer.subarray(t)),kt(i),this.compress(i,0,!0),kt(i);const r=ai(e);this.get().forEach((n,o)=>r[o]=vt(n))}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const i=e.slice(0,t);return this.destroy(),i}_cloneInto(e){const{buffer:t,length:i,finished:r,destroyed:n,outputLen:o,pos:a}=this;return e||(e=new this.constructor({dkLen:o})),e.set(...this.get()),e.buffer.set(t),e.destroyed=n,e.finished=r,e.length=i,e.pos=a,e.outputLen=o,e}clone(){return this._cloneInto()}}class Up extends Np{constructor(e={}){const t=e.dkLen===void 0?64:e.dkLen;super(128,t),this.v0l=ue[0]|0,this.v0h=ue[1]|0,this.v1l=ue[2]|0,this.v1h=ue[3]|0,this.v2l=ue[4]|0,this.v2h=ue[5]|0,this.v3l=ue[6]|0,this.v3h=ue[7]|0,this.v4l=ue[8]|0,this.v4h=ue[9]|0,this.v5l=ue[10]|0,this.v5h=ue[11]|0,this.v6l=ue[12]|0,this.v6h=ue[13]|0,this.v7l=ue[14]|0,this.v7h=ue[15]|0,Rp(t,e,64,16,16);let{key:i,personalization:r,salt:n}=e,o=0;if(i!==void 0&&(i=rt(i),o=i.length),this.v0l^=this.outputLen|o<<8|65536|1<<24,n!==void 0){n=rt(n);const a=ai(n);this.v4l^=vt(a[0]),this.v4h^=vt(a[1]),this.v5l^=vt(a[2]),this.v5h^=vt(a[3])}if(r!==void 0){r=rt(r);const a=ai(r);this.v6l^=vt(a[0]),this.v6h^=vt(a[1]),this.v7l^=vt(a[2]),this.v7h^=vt(a[3])}if(i!==void 0){const a=new Uint8Array(this.blockLen);a.set(i),this.update(a)}}get(){let{v0l:e,v0h:t,v1l:i,v1h:r,v2l:n,v2h:o,v3l:a,v3h:c,v4l:h,v4h:l,v5l:u,v5h:d,v6l:p,v6h:f,v7l:g,v7h:m}=this;return[e,t,i,r,n,o,a,c,h,l,u,d,p,f,g,m]}set(e,t,i,r,n,o,a,c,h,l,u,d,p,f,g,m){this.v0l=e|0,this.v0h=t|0,this.v1l=i|0,this.v1h=r|0,this.v2l=n|0,this.v2h=o|0,this.v3l=a|0,this.v3h=c|0,this.v4l=h|0,this.v4h=l|0,this.v5l=u|0,this.v5h=d|0,this.v6l=p|0,this.v6h=f|0,this.v7l=g|0,this.v7h=m|0}compress(e,t,i){this.get().forEach((c,h)=>q[h]=c),q.set(ue,16);let{h:r,l:n}=Oc(BigInt(this.length));q[24]=ue[8]^n,q[25]=ue[9]^r,i&&(q[28]=~q[28],q[29]=~q[29]);let o=0;const a=Tp;for(let c=0;c<12;c++)Ct(0,4,8,12,e,t+2*a[o++]),Tt(0,4,8,12,e,t+2*a[o++]),Ct(1,5,9,13,e,t+2*a[o++]),Tt(1,5,9,13,e,t+2*a[o++]),Ct(2,6,10,14,e,t+2*a[o++]),Tt(2,6,10,14,e,t+2*a[o++]),Ct(3,7,11,15,e,t+2*a[o++]),Tt(3,7,11,15,e,t+2*a[o++]),Ct(0,5,10,15,e,t+2*a[o++]),Tt(0,5,10,15,e,t+2*a[o++]),Ct(1,6,11,12,e,t+2*a[o++]),Tt(1,6,11,12,e,t+2*a[o++]),Ct(2,7,8,13,e,t+2*a[o++]),Tt(2,7,8,13,e,t+2*a[o++]),Ct(3,4,9,14,e,t+2*a[o++]),Tt(3,4,9,14,e,t+2*a[o++]);this.v0l^=q[0]^q[16],this.v0h^=q[1]^q[17],this.v1l^=q[2]^q[18],this.v1h^=q[3]^q[19],this.v2l^=q[4]^q[20],this.v2h^=q[5]^q[21],this.v3l^=q[6]^q[22],this.v3h^=q[7]^q[23],this.v4l^=q[8]^q[24],this.v4h^=q[9]^q[25],this.v5l^=q[10]^q[26],this.v5h^=q[11]^q[27],this.v6l^=q[12]^q[28],this.v6h^=q[13]^q[29],this.v7l^=q[14]^q[30],this.v7h^=q[15]^q[31],Ye(q)}destroy(){this.destroyed=!0,Ye(this.buffer32),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const kp=cp(s=>new Up(s)),Bp="https://rpc.walletconnect.org/v1";function zc(s){const e=`Ethereum Signed Message:
${s.length}`,t=new TextEncoder().encode(e+s);return"0x"+Buffer.from(bp(t)).toString("hex")}async function qp(s,e,t,i,r,n){switch(t.t){case"eip191":return await jp(s,e,t.s);case"eip1271":return await Lp(s,e,t.s,i,r,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}async function jp(s,e,t){return(await ju({hash:zc(e),signature:t})).toLowerCase()===s.toLowerCase()}async function Lp(s,e,t,i,r,n){const o=jt(i);if(!o.namespace||!o.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${i}`);try{const a="0x1626ba7e",c="0000000000000000000000000000000000000000000000000000000000000040",h=t.substring(2),l=(h.length/2).toString(16).padStart(64,"0"),u=(e.startsWith("0x")?e:zc(e)).substring(2),d=a+u+c+l+h,p=await fetch(`${n||Bp}/?chainId=${i}&projectId=${r}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify({id:Mp(),jsonrpc:"2.0",method:"eth_call",params:[{to:s,data:d},"latest"]})}),{result:f}=await p.json();return f?f.slice(0,a.length).toLowerCase()===a.toLowerCase():!1}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}function Mp(){return Date.now()+Math.floor(Math.random()*1e3)}function zp(s){const e=atob(s),t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e.charCodeAt(o);const i=t[0];if(i===0)throw new Error("No signatures found");const r=1+i*64;if(t.length<r)throw new Error("Transaction data too short for claimed signature count");if(t.length<100)throw new Error("Transaction too short");const n=Buffer.from(s,"base64").slice(1,65);return fi.encode(n)}function Fp(s){const e=new Uint8Array(Buffer.from(s,"base64")),t=Array.from("TransactionData::").map(n=>n.charCodeAt(0)),i=new Uint8Array(t.length+e.length);i.set(t),i.set(e,t.length);const r=kp(i,{dkLen:32});return fi.encode(r)}function vo(s){const e=new Uint8Array(Zi(Hp(s)));return fi.encode(e)}function Hp(s){if(s instanceof Uint8Array)return s;if(Array.isArray(s))return new Uint8Array(s);if(typeof s=="object"&&s!=null&&s.data)return new Uint8Array(Object.values(s.data));if(typeof s=="object"&&s)return new Uint8Array(Object.values(s));throw new Error("getNearUint8ArrayFromBytes: Unexpected result type from bytes array")}function Eo(s){const e=Buffer.from(s,"base64"),t=xd(e).txn;if(!t)throw new Error("Invalid signed transaction: missing 'txn' field");const i=pd(t),r=Buffer.from("TX"),n=Buffer.concat([r,Buffer.from(i)]),o=Cp(n);return nl.encode(o).replace(/=+$/,"")}function dr(s){const e=[];let t=BigInt(s);for(;t>=BigInt(128);)e.push(Number(t&BigInt(127)|BigInt(128))),t>>=BigInt(7);return e.push(Number(t)),Buffer.from(e)}function Vp(s){const e=Buffer.from(s.signed.bodyBytes,"base64"),t=Buffer.from(s.signed.authInfoBytes,"base64"),i=Buffer.from(s.signature.signature,"base64"),r=[];r.push(Buffer.from([10])),r.push(dr(e.length)),r.push(e),r.push(Buffer.from([18])),r.push(dr(t.length)),r.push(t),r.push(Buffer.from([26])),r.push(dr(i.length)),r.push(i);const n=Buffer.concat(r),o=Zi(n);return Buffer.from(o).toString("hex").toUpperCase()}var Kp=Object.defineProperty,Gp=Object.defineProperties,Wp=Object.getOwnPropertyDescriptors,Io=Object.getOwnPropertySymbols,Jp=Object.prototype.hasOwnProperty,Yp=Object.prototype.propertyIsEnumerable,xo=(s,e,t)=>e in s?Kp(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Zp=(s,e)=>{for(var t in e||(e={}))Jp.call(e,t)&&xo(s,t,e[t]);if(Io)for(var t of Io(e))Yp.call(e,t)&&xo(s,t,e[t]);return s},Qp=(s,e)=>Gp(s,Wp(e));const Xp="did:pkh:",Tn=s=>s==null?void 0:s.split(":"),eg=s=>{const e=s&&Tn(s);if(e)return s.includes(Xp)?e[3]:e[1]},Hr=s=>{const e=s&&Tn(s);if(e)return e[2]+":"+e[3]},zi=s=>{const e=s&&Tn(s);if(e)return e.pop()};async function Do(s){const{cacao:e,projectId:t}=s,{s:i,p:r}=e,n=Fc(r,r.iss),o=zi(r.iss);return await qp(o,n,i,Hr(r.iss),t)}const Fc=(s,e)=>{const t=`${s.domain} wants you to sign in with your Ethereum account:`,i=zi(e);if(!s.aud&&!s.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let r=s.statement||void 0;const n=`URI: ${s.aud||s.uri}`,o=`Version: ${s.version}`,a=`Chain ID: ${eg(e)}`,c=`Nonce: ${s.nonce}`,h=`Issued At: ${s.iat}`,l=s.exp?`Expiration Time: ${s.exp}`:void 0,u=s.nbf?`Not Before: ${s.nbf}`:void 0,d=s.requestId?`Request ID: ${s.requestId}`:void 0,p=s.resources?`Resources:${s.resources.map(g=>`
- ${g}`).join("")}`:void 0,f=Ti(s.resources);if(f){const g=hi(f);r=hg(r,g)}return[t,i,"",r,"",n,o,a,c,h,l,u,d,p].filter(g=>g!=null).join(`
`)};function tg(s){return Buffer.from(JSON.stringify(s)).toString("base64")}function sg(s){return JSON.parse(Buffer.from(s,"base64").toString("utf-8"))}function Xt(s){if(!s)throw new Error("No recap provided, value is undefined");if(!s.att)throw new Error("No `att` property found");const e=Object.keys(s.att);if(!(e!=null&&e.length))throw new Error("No resources found in `att` property");e.forEach(t=>{const i=s.att[t];if(Array.isArray(i))throw new Error(`Resource must be an object: ${t}`);if(typeof i!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(i).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(i).forEach(r=>{const n=i[r];if(!Array.isArray(n))throw new Error(`Ability limits ${r} must be an array of objects, found: ${n}`);if(!n.length)throw new Error(`Value of ${r} is empty array, must be an array with objects`);n.forEach(o=>{if(typeof o!="object")throw new Error(`Ability limits (${r}) must be an array of objects, found: ${o}`)})})})}function ig(s,e,t,i={}){return t==null||t.sort((r,n)=>r.localeCompare(n)),{att:{[s]:rg(e,t,i)}}}function rg(s,e,t={}){e=e==null?void 0:e.sort((r,n)=>r.localeCompare(n));const i=e.map(r=>({[`${s}/${r}`]:[t]}));return Object.assign({},...i)}function Hc(s){return Xt(s),`urn:recap:${tg(s).replace(/=/g,"")}`}function hi(s){const e=sg(s.replace("urn:recap:",""));return Xt(e),e}function ng(s,e,t){const i=ig(s,e,t);return Hc(i)}function og(s){return s&&s.includes("urn:recap:")}function ag(s,e){const t=hi(s),i=hi(e),r=cg(t,i);return Hc(r)}function cg(s,e){Xt(s),Xt(e);const t=Object.keys(s.att).concat(Object.keys(e.att)).sort((r,n)=>r.localeCompare(n)),i={att:{}};return t.forEach(r=>{var n,o;Object.keys(((n=s.att)==null?void 0:n[r])||{}).concat(Object.keys(((o=e.att)==null?void 0:o[r])||{})).sort((a,c)=>a.localeCompare(c)).forEach(a=>{var c,h;i.att[r]=Qp(Zp({},i.att[r]),{[a]:((c=s.att[r])==null?void 0:c[a])||((h=e.att[r])==null?void 0:h[a])})})}),i}function hg(s="",e){Xt(e);const t="I further authorize the stated URI to perform the following actions on my behalf: ";if(s.includes(t))return s;const i=[];let r=0;Object.keys(e.att).forEach(a=>{const c=Object.keys(e.att[a]).map(u=>({ability:u.split("/")[0],action:u.split("/")[1]}));c.sort((u,d)=>u.action.localeCompare(d.action));const h={};c.forEach(u=>{h[u.ability]||(h[u.ability]=[]),h[u.ability].push(u.action)});const l=Object.keys(h).map(u=>(r++,`(${r}) '${u}': '${h[u].join("', '")}' for '${a}'.`));i.push(l.join(", ").replace(".,","."))});const n=i.join(" "),o=`${t}${n}`;return`${s?s+" ":""}${o}`}function Po(s){var e;const t=hi(s);Xt(t);const i=(e=t.att)==null?void 0:e.eip155;return i?Object.keys(i).map(r=>r.split("/")[1]):[]}function So(s){const e=hi(s);Xt(e);const t=[];return Object.values(e.att).forEach(i=>{Object.values(i).forEach(r=>{var n;(n=r==null?void 0:r[0])!=null&&n.chains&&t.push(r[0].chains)})}),[...new Set(t.flat())]}function Ti(s){if(!s)return;const e=s==null?void 0:s[s.length-1];return og(e)?e:void 0}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */function Vc(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function Vr(s){if(typeof s!="boolean")throw new Error(`boolean expected, not ${s}`)}function fr(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function Ce(s,...e){if(!Vc(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function _o(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function lg(s,e){Ce(s);const t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Lt(s){return new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4))}function Ss(...s){for(let e=0;e<s.length;e++)s[e].fill(0)}function ug(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}const dg=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function fg(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function Kr(s){if(typeof s=="string")s=fg(s);else if(Vc(s))s=Gr(s);else throw new Error("Uint8Array expected, got "+typeof s);return s}function pg(s,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(s,e)}function gg(s,e){if(s.length!==e.length)return!1;let t=0;for(let i=0;i<s.length;i++)t|=s[i]^e[i];return t===0}const yg=(s,e)=>{function t(i,...r){if(Ce(i),!dg)throw new Error("Non little-endian hardware is not yet supported");if(s.nonceLength!==void 0){const h=r[0];if(!h)throw new Error("nonce / iv required");s.varSizeNonce?Ce(h):Ce(h,s.nonceLength)}const n=s.tagLength;n&&r[1]!==void 0&&Ce(r[1]);const o=e(i,...r),a=(h,l)=>{if(l!==void 0){if(h!==2)throw new Error("cipher output not supported");Ce(l)}};let c=!1;return{encrypt(h,l){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Ce(h),a(o.encrypt.length,l),o.encrypt(h,l)},decrypt(h,l){if(Ce(h),n&&h.length<n)throw new Error("invalid ciphertext length: smaller than tagLength="+n);return a(o.decrypt.length,l),o.decrypt(h,l)}}}return Object.assign(t,s),t};function $o(s,e,t=!0){if(e===void 0)return new Uint8Array(s);if(e.length!==s)throw new Error("invalid output length, expected "+s+", got: "+e.length);if(t&&!wg(e))throw new Error("invalid output, must be aligned");return e}function Ao(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);const r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n);s.setUint32(e+4,o,i),s.setUint32(e+0,a,i)}function mg(s,e,t){Vr(t);const i=new Uint8Array(16),r=ug(i);return Ao(r,0,BigInt(e),t),Ao(r,8,BigInt(s),t),i}function wg(s){return s.byteOffset%4===0}function Gr(s){return Uint8Array.from(s)}const Kc=s=>Uint8Array.from(s.split("").map(e=>e.charCodeAt(0))),bg=Kc("expand 16-byte k"),vg=Kc("expand 32-byte k"),Eg=Lt(bg),Ig=Lt(vg);function W(s,e){return s<<e|s>>>32-e}function Wr(s){return s.byteOffset%4===0}const xi=64,xg=16,Gc=2**32-1,Oo=new Uint32Array;function Dg(s,e,t,i,r,n,o,a){const c=r.length,h=new Uint8Array(xi),l=Lt(h),u=Wr(r)&&Wr(n),d=u?Lt(r):Oo,p=u?Lt(n):Oo;for(let f=0;f<c;o++){if(s(e,t,i,l,o,a),o>=Gc)throw new Error("arx: counter overflow");const g=Math.min(xi,c-f);if(u&&g===xi){const m=f/4;if(f%4!==0)throw new Error("arx: invalid block position");for(let x=0,E;x<xg;x++)E=m+x,p[E]=d[E]^l[x];f+=xi;continue}for(let m=0,x;m<g;m++)x=f+m,n[x]=r[x]^h[m];f+=g}}function Pg(s,e){const{allowShortKeys:t,extendNonceFn:i,counterLength:r,counterRight:n,rounds:o}=pg({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof s!="function")throw new Error("core must be a function");return fr(r),fr(o),Vr(n),Vr(t),(a,c,h,l,u=0)=>{Ce(a),Ce(c),Ce(h);const d=h.length;if(l===void 0&&(l=new Uint8Array(d)),Ce(l),fr(u),u<0||u>=Gc)throw new Error("arx: counter overflow");if(l.length<d)throw new Error(`arx: output (${l.length}) is shorter than data (${d})`);const p=[];let f=a.length,g,m;if(f===32)p.push(g=Gr(a)),m=Ig;else if(f===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),m=Eg,p.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${f}`);Wr(c)||p.push(c=Gr(c));const x=Lt(g);if(i){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");i(m,x,Lt(c.subarray(0,16)),x),c=c.subarray(16)}const E=16-r;if(E!==c.length)throw new Error(`arx: nonce must be ${E} or 16 bytes`);if(E!==12){const T=new Uint8Array(12);T.set(c,n?0:12-c.length),c=T,p.push(c)}const S=Lt(c);return Dg(s,m,x,S,h,l,u,o),Ss(...p),l}}const pe=(s,e)=>s[e++]&255|(s[e++]&255)<<8;class Sg{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Kr(e),Ce(e,32);const t=pe(e,0),i=pe(e,2),r=pe(e,4),n=pe(e,6),o=pe(e,8),a=pe(e,10),c=pe(e,12),h=pe(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|i<<3)&8191,this.r[2]=(i>>>10|r<<6)&7939,this.r[3]=(r>>>7|n<<9)&8191,this.r[4]=(n>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|h<<8)&8191,this.r[9]=h>>>5&127;for(let l=0;l<8;l++)this.pad[l]=pe(e,16+2*l)}process(e,t,i=!1){const r=i?0:2048,{h:n,r:o}=this,a=o[0],c=o[1],h=o[2],l=o[3],u=o[4],d=o[5],p=o[6],f=o[7],g=o[8],m=o[9],x=pe(e,t+0),E=pe(e,t+2),S=pe(e,t+4),T=pe(e,t+6),I=pe(e,t+8),R=pe(e,t+10),B=pe(e,t+12),C=pe(e,t+14);let y=n[0]+(x&8191),v=n[1]+((x>>>13|E<<3)&8191),w=n[2]+((E>>>10|S<<6)&8191),b=n[3]+((S>>>7|T<<9)&8191),D=n[4]+((T>>>4|I<<12)&8191),A=n[5]+(I>>>1&8191),$=n[6]+((I>>>14|R<<2)&8191),O=n[7]+((R>>>11|B<<5)&8191),N=n[8]+((B>>>8|C<<8)&8191),j=n[9]+(C>>>5|r),_=0,M=_+y*a+v*(5*m)+w*(5*g)+b*(5*f)+D*(5*p);_=M>>>13,M&=8191,M+=A*(5*d)+$*(5*u)+O*(5*l)+N*(5*h)+j*(5*c),_+=M>>>13,M&=8191;let L=_+y*c+v*a+w*(5*m)+b*(5*g)+D*(5*f);_=L>>>13,L&=8191,L+=A*(5*p)+$*(5*d)+O*(5*u)+N*(5*l)+j*(5*h),_+=L>>>13,L&=8191;let z=_+y*h+v*c+w*a+b*(5*m)+D*(5*g);_=z>>>13,z&=8191,z+=A*(5*f)+$*(5*p)+O*(5*d)+N*(5*u)+j*(5*l),_+=z>>>13,z&=8191;let H=_+y*l+v*h+w*c+b*a+D*(5*m);_=H>>>13,H&=8191,H+=A*(5*g)+$*(5*f)+O*(5*p)+N*(5*d)+j*(5*u),_+=H>>>13,H&=8191;let F=_+y*u+v*l+w*h+b*c+D*a;_=F>>>13,F&=8191,F+=A*(5*m)+$*(5*g)+O*(5*f)+N*(5*p)+j*(5*d),_+=F>>>13,F&=8191;let V=_+y*d+v*u+w*l+b*h+D*c;_=V>>>13,V&=8191,V+=A*a+$*(5*m)+O*(5*g)+N*(5*f)+j*(5*p),_+=V>>>13,V&=8191;let X=_+y*p+v*d+w*u+b*l+D*h;_=X>>>13,X&=8191,X+=A*c+$*a+O*(5*m)+N*(5*g)+j*(5*f),_+=X>>>13,X&=8191;let ae=_+y*f+v*p+w*d+b*u+D*l;_=ae>>>13,ae&=8191,ae+=A*h+$*c+O*a+N*(5*m)+j*(5*g),_+=ae>>>13,ae&=8191;let ne=_+y*g+v*f+w*p+b*d+D*u;_=ne>>>13,ne&=8191,ne+=A*l+$*h+O*c+N*a+j*(5*m),_+=ne>>>13,ne&=8191;let re=_+y*m+v*g+w*f+b*p+D*d;_=re>>>13,re&=8191,re+=A*u+$*l+O*h+N*c+j*a,_+=re>>>13,re&=8191,_=(_<<2)+_|0,_=_+M|0,M=_&8191,_=_>>>13,L+=_,n[0]=M,n[1]=L,n[2]=z,n[3]=H,n[4]=F,n[5]=V,n[6]=X,n[7]=ae,n[8]=ne,n[9]=re}finalize(){const{h:e,pad:t}=this,i=new Uint16Array(10);let r=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=r,r=e[a]>>>13,e[a]&=8191;e[0]+=r*5,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,i[0]=e[0]+5,r=i[0]>>>13,i[0]&=8191;for(let a=1;a<10;a++)i[a]=e[a]+r,r=i[a]>>>13,i[a]&=8191;i[9]-=8192;let n=(r^1)-1;for(let a=0;a<10;a++)i[a]&=n;n=~n;for(let a=0;a<10;a++)e[a]=e[a]&n|i[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Ss(i)}update(e){_o(this),e=Kr(e),Ce(e);const{buffer:t,blockLen:i}=this,r=e.length;for(let n=0;n<r;){const o=Math.min(i-this.pos,r-n);if(o===i){for(;i<=r-n;n+=i)this.process(e,n);continue}t.set(e.subarray(n,n+o),this.pos),this.pos+=o,n+=o,this.pos===i&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Ss(this.h,this.r,this.buffer,this.pad)}digestInto(e){_o(this),lg(e,this),this.finished=!0;const{buffer:t,h:i}=this;let{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let n=0;for(let o=0;o<8;o++)e[n++]=i[o]>>>0,e[n++]=i[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const i=e.slice(0,t);return this.destroy(),i}}function _g(s){const e=(i,r)=>s(r).update(Kr(i)).digest(),t=s(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=i=>s(i),e}const $g=_g(s=>new Sg(s));function Ag(s,e,t,i,r,n=20){let o=s[0],a=s[1],c=s[2],h=s[3],l=e[0],u=e[1],d=e[2],p=e[3],f=e[4],g=e[5],m=e[6],x=e[7],E=r,S=t[0],T=t[1],I=t[2],R=o,B=a,C=c,y=h,v=l,w=u,b=d,D=p,A=f,$=g,O=m,N=x,j=E,_=S,M=T,L=I;for(let H=0;H<n;H+=2)R=R+v|0,j=W(j^R,16),A=A+j|0,v=W(v^A,12),R=R+v|0,j=W(j^R,8),A=A+j|0,v=W(v^A,7),B=B+w|0,_=W(_^B,16),$=$+_|0,w=W(w^$,12),B=B+w|0,_=W(_^B,8),$=$+_|0,w=W(w^$,7),C=C+b|0,M=W(M^C,16),O=O+M|0,b=W(b^O,12),C=C+b|0,M=W(M^C,8),O=O+M|0,b=W(b^O,7),y=y+D|0,L=W(L^y,16),N=N+L|0,D=W(D^N,12),y=y+D|0,L=W(L^y,8),N=N+L|0,D=W(D^N,7),R=R+w|0,L=W(L^R,16),O=O+L|0,w=W(w^O,12),R=R+w|0,L=W(L^R,8),O=O+L|0,w=W(w^O,7),B=B+b|0,j=W(j^B,16),N=N+j|0,b=W(b^N,12),B=B+b|0,j=W(j^B,8),N=N+j|0,b=W(b^N,7),C=C+D|0,_=W(_^C,16),A=A+_|0,D=W(D^A,12),C=C+D|0,_=W(_^C,8),A=A+_|0,D=W(D^A,7),y=y+v|0,M=W(M^y,16),$=$+M|0,v=W(v^$,12),y=y+v|0,M=W(M^y,8),$=$+M|0,v=W(v^$,7);let z=0;i[z++]=o+R|0,i[z++]=a+B|0,i[z++]=c+C|0,i[z++]=h+y|0,i[z++]=l+v|0,i[z++]=u+w|0,i[z++]=d+b|0,i[z++]=p+D|0,i[z++]=f+A|0,i[z++]=g+$|0,i[z++]=m+O|0,i[z++]=x+N|0,i[z++]=E+j|0,i[z++]=S+_|0,i[z++]=T+M|0,i[z++]=I+L|0}const Og=Pg(Ag,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Cg=new Uint8Array(16),Co=(s,e)=>{s.update(e);const t=e.length%16;t&&s.update(Cg.subarray(t))},Tg=new Uint8Array(32);function To(s,e,t,i,r){const n=s(e,t,Tg),o=$g.create(n);r&&Co(o,r),Co(o,i);const a=mg(i.length,r?r.length:0,!0);o.update(a);const c=o.digest();return Ss(n,a),c}const Rg=s=>(e,t,i)=>({encrypt(r,n){const o=r.length;n=$o(o+16,n,!1),n.set(r);const a=n.subarray(0,-16);s(e,t,a,a,1);const c=To(s,e,t,a,i);return n.set(c,o),Ss(c),n},decrypt(r,n){n=$o(r.length-16,n,!1);const o=r.subarray(0,-16),a=r.subarray(-16),c=To(s,e,t,o,i);if(!gg(a,c))throw new Error("invalid tag");return n.set(r.subarray(0,-16)),s(e,t,n,n,1),Ss(c),n}}),Wc=yg({blockSize:64,nonceLength:12,tagLength:16},Rg(Og));let Jc=class extends Yi{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,$n(e);const i=rt(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,n=new Uint8Array(r);n.set(i.length>r?e.create().update(i).digest():i);for(let o=0;o<n.length;o++)n[o]^=54;this.iHash.update(n),this.oHash=e.create();for(let o=0;o<n.length;o++)n[o]^=106;this.oHash.update(n),Ye(n)}update(e){return Mt(this),this.iHash.update(e),this}digestInto(e){Mt(this),Je(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:i,finished:r,destroyed:n,blockLen:o,outputLen:a}=this;return e=e,e.finished=r,e.destroyed=n,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=i._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const Qi=(s,e,t)=>new Jc(s,e).update(t).digest();Qi.create=(s,e)=>new Jc(s,e);function Ng(s,e,t){return $n(s),t===void 0&&(t=new Uint8Array(s.outputLen)),Qi(s,rt(t),rt(e))}const pr=Uint8Array.from([0]),Ro=Uint8Array.of();function Ug(s,e,t,i=32){$n(s),Pt(i);const r=s.outputLen;if(i>255*r)throw new Error("Length should be <= 255*HashLen");const n=Math.ceil(i/r);t===void 0&&(t=Ro);const o=new Uint8Array(n*r),a=Qi.create(s,e),c=a._cloneInto(),h=new Uint8Array(a.outputLen);for(let l=0;l<n;l++)pr[0]=l+1,c.update(l===0?Ro:h).update(t).update(pr).digestInto(h),o.set(h,r*l),a._cloneInto(c);return a.destroy(),c.destroy(),Ye(h,pr),o.slice(0,i)}const kg=(s,e,t,i,r)=>Ug(s,Ng(s,e,t),i,r),Xi=Zi,Rn=BigInt(0),Jr=BigInt(1);function Fi(s,e){if(typeof e!="boolean")throw new Error(s+" boolean expected, got "+e)}function Di(s){const e=s.toString(16);return e.length&1?"0"+e:e}function Yc(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);return s===""?Rn:BigInt("0x"+s)}function er(s){return Yc(ci(s))}function Hi(s){return Je(s),Yc(ci(Uint8Array.from(s).reverse()))}function Nn(s,e){return On(s.toString(16).padStart(e*2,"0"))}function Un(s,e){return Nn(s,e).reverse()}function Oe(s,e,t){let i;if(typeof e=="string")try{i=On(e)}catch(n){throw new Error(s+" must be hex string or Uint8Array, cause: "+n)}else if(_n(e))i=Uint8Array.from(e);else throw new Error(s+" must be hex string or Uint8Array");const r=i.length;if(typeof t=="number"&&r!==t)throw new Error(s+" of length "+t+" expected, got "+r);return i}const gr=s=>typeof s=="bigint"&&Rn<=s;function Bg(s,e,t){return gr(s)&&gr(e)&&gr(t)&&e<=s&&s<t}function Yr(s,e,t,i){if(!Bg(e,t,i))throw new Error("expected valid "+s+": "+t+" <= n < "+i+", got "+e)}function qg(s){let e;for(e=0;s>Rn;s>>=Jr,e+=1);return e}const tr=s=>(Jr<<BigInt(s))-Jr;function jg(s,e,t){if(typeof s!="number"||s<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const i=d=>new Uint8Array(d),r=d=>Uint8Array.of(d);let n=i(s),o=i(s),a=0;const c=()=>{n.fill(1),o.fill(0),a=0},h=(...d)=>t(o,n,...d),l=(d=i(0))=>{o=h(r(0),d),n=h(),d.length!==0&&(o=h(r(1),d),n=h())},u=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const p=[];for(;d<e;){n=h();const f=n.slice();p.push(f),d+=n.length}return Jt(...p)};return(d,p)=>{c(),l(d);let f;for(;!(f=p(u()));)l();return c(),f}}function sr(s,e,t={}){if(!s||typeof s!="object")throw new Error("expected valid options object");function i(r,n,o){const a=s[r];if(o&&a===void 0)return;const c=typeof a;if(c!==n||a===null)throw new Error(`param "${r}" is invalid: expected ${n}, got ${c}`)}Object.entries(e).forEach(([r,n])=>i(r,n,!1)),Object.entries(t).forEach(([r,n])=>i(r,n,!0))}function No(s){const e=new WeakMap;return(t,...i)=>{const r=e.get(t);if(r!==void 0)return r;const n=s(t,...i);return e.set(t,n),n}}const Re=BigInt(0),Pe=BigInt(1),Yt=BigInt(2),Lg=BigInt(3),Zc=BigInt(4),Qc=BigInt(5),Xc=BigInt(8);function Ge(s,e){const t=s%e;return t>=Re?t:e+t}function et(s,e,t){let i=s;for(;e-- >Re;)i*=i,i%=t;return i}function Uo(s,e){if(s===Re)throw new Error("invert: expected non-zero number");if(e<=Re)throw new Error("invert: expected positive modulus, got "+e);let t=Ge(s,e),i=e,r=Re,n=Pe;for(;t!==Re;){const o=i/t,a=i%t,c=r-n*o;i=t,t=a,r=n,n=c}if(i!==Pe)throw new Error("invert: does not exist");return Ge(r,e)}function eh(s,e){const t=(s.ORDER+Pe)/Zc,i=s.pow(e,t);if(!s.eql(s.sqr(i),e))throw new Error("Cannot find square root");return i}function Mg(s,e){const t=(s.ORDER-Qc)/Xc,i=s.mul(e,Yt),r=s.pow(i,t),n=s.mul(e,r),o=s.mul(s.mul(n,Yt),r),a=s.mul(n,s.sub(o,s.ONE));if(!s.eql(s.sqr(a),e))throw new Error("Cannot find square root");return a}function zg(s){if(s<BigInt(3))throw new Error("sqrt is not defined for small field");let e=s-Pe,t=0;for(;e%Yt===Re;)e/=Yt,t++;let i=Yt;const r=Ts(s);for(;ko(r,i)===1;)if(i++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return eh;let n=r.pow(i,e);const o=(e+Pe)/Yt;return function(a,c){if(a.is0(c))return c;if(ko(a,c)!==1)throw new Error("Cannot find square root");let h=t,l=a.mul(a.ONE,n),u=a.pow(c,e),d=a.pow(c,o);for(;!a.eql(u,a.ONE);){if(a.is0(u))return a.ZERO;let p=1,f=a.sqr(u);for(;!a.eql(f,a.ONE);)if(p++,f=a.sqr(f),p===h)throw new Error("Cannot find square root");const g=Pe<<BigInt(h-p-1),m=a.pow(l,g);h=p,l=a.sqr(m),u=a.mul(u,l),d=a.mul(d,m)}return d}}function Fg(s){return s%Zc===Lg?eh:s%Xc===Qc?Mg:zg(s)}const Hg=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Vg(s){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=Hg.reduce((i,r)=>(i[r]="function",i),e);return sr(s,t),s}function Kg(s,e,t){if(t<Re)throw new Error("invalid exponent, negatives unsupported");if(t===Re)return s.ONE;if(t===Pe)return e;let i=s.ONE,r=e;for(;t>Re;)t&Pe&&(i=s.mul(i,r)),r=s.sqr(r),t>>=Pe;return i}function th(s,e,t=!1){const i=new Array(e.length).fill(t?s.ZERO:void 0),r=e.reduce((o,a,c)=>s.is0(a)?o:(i[c]=o,s.mul(o,a)),s.ONE),n=s.inv(r);return e.reduceRight((o,a,c)=>s.is0(a)?o:(i[c]=s.mul(o,i[c]),s.mul(o,a)),n),i}function ko(s,e){const t=(s.ORDER-Pe)/Yt,i=s.pow(e,t),r=s.eql(i,s.ONE),n=s.eql(i,s.ZERO),o=s.eql(i,s.neg(s.ONE));if(!r&&!n&&!o)throw new Error("invalid Legendre symbol result");return r?1:n?0:-1}function Gg(s,e){e!==void 0&&Pt(e);const t=e!==void 0?e:s.toString(2).length,i=Math.ceil(t/8);return{nBitLength:t,nByteLength:i}}function Ts(s,e,t=!1,i={}){if(s<=Re)throw new Error("invalid field: expected ORDER > 0, got "+s);let r,n;if(typeof e=="object"&&e!=null){if(i.sqrt||t)throw new Error("cannot specify opts in two arguments");const l=e;l.BITS&&(r=l.BITS),l.sqrt&&(n=l.sqrt),typeof l.isLE=="boolean"&&(t=l.isLE)}else typeof e=="number"&&(r=e),i.sqrt&&(n=i.sqrt);const{nBitLength:o,nByteLength:a}=Gg(s,r);if(a>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let c;const h=Object.freeze({ORDER:s,isLE:t,BITS:o,BYTES:a,MASK:tr(o),ZERO:Re,ONE:Pe,create:l=>Ge(l,s),isValid:l=>{if(typeof l!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof l);return Re<=l&&l<s},is0:l=>l===Re,isValidNot0:l=>!h.is0(l)&&h.isValid(l),isOdd:l=>(l&Pe)===Pe,neg:l=>Ge(-l,s),eql:(l,u)=>l===u,sqr:l=>Ge(l*l,s),add:(l,u)=>Ge(l+u,s),sub:(l,u)=>Ge(l-u,s),mul:(l,u)=>Ge(l*u,s),pow:(l,u)=>Kg(h,l,u),div:(l,u)=>Ge(l*Uo(u,s),s),sqrN:l=>l*l,addN:(l,u)=>l+u,subN:(l,u)=>l-u,mulN:(l,u)=>l*u,inv:l=>Uo(l,s),sqrt:n||(l=>(c||(c=Fg(s)),c(h,l))),toBytes:l=>t?Un(l,a):Nn(l,a),fromBytes:l=>{if(l.length!==a)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+l.length);return t?Hi(l):er(l)},invertBatch:l=>th(h,l),cmov:(l,u,d)=>d?u:l});return Object.freeze(h)}function sh(s){if(typeof s!="bigint")throw new Error("field order must be bigint");const e=s.toString(2).length;return Math.ceil(e/8)}function ih(s){const e=sh(s);return e+Math.ceil(e/2)}function Wg(s,e,t=!1){const i=s.length,r=sh(e),n=ih(e);if(i<16||i<n||i>1024)throw new Error("expected "+n+"-1024 bytes of input, got "+i);const o=t?Hi(s):er(s),a=Ge(o,e-Pe)+Pe;return t?Un(a,r):Nn(a,r)}const _s=BigInt(0),Zt=BigInt(1);function Qs(s,e){const t=e.negate();return s?t:e}function Jg(s,e,t){const i=n=>n.pz,r=th(s.Fp,t.map(i));return t.map((n,o)=>n.toAffine(r[o])).map(s.fromAffine)}function rh(s,e){if(!Number.isSafeInteger(s)||s<=0||s>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+s)}function yr(s,e){rh(s,e);const t=Math.ceil(e/s)+1,i=2**(s-1),r=2**s,n=tr(s),o=BigInt(s);return{windows:t,windowSize:i,mask:n,maxNumber:r,shiftBy:o}}function Bo(s,e,t){const{windowSize:i,mask:r,maxNumber:n,shiftBy:o}=t;let a=Number(s&r),c=s>>o;a>i&&(a-=n,c+=Zt);const h=e*i,l=h+Math.abs(a)-1,u=a===0,d=a<0,p=e%2!==0;return{nextN:c,offset:l,isZero:u,isNeg:d,isNegF:p,offsetF:h}}function Yg(s,e){if(!Array.isArray(s))throw new Error("array expected");s.forEach((t,i)=>{if(!(t instanceof e))throw new Error("invalid point at index "+i)})}function Zg(s,e){if(!Array.isArray(s))throw new Error("array of scalars expected");s.forEach((t,i)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+i)})}const mr=new WeakMap,nh=new WeakMap;function wr(s){return nh.get(s)||1}function qo(s){if(s!==_s)throw new Error("invalid wNAF")}function Qg(s,e){return{constTimeNegate:Qs,hasPrecomputes(t){return wr(t)!==1},unsafeLadder(t,i,r=s.ZERO){let n=t;for(;i>_s;)i&Zt&&(r=r.add(n)),n=n.double(),i>>=Zt;return r},precomputeWindow(t,i){const{windows:r,windowSize:n}=yr(i,e),o=[];let a=t,c=a;for(let h=0;h<r;h++){c=a,o.push(c);for(let l=1;l<n;l++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,i,r){let n=s.ZERO,o=s.BASE;const a=yr(t,e);for(let c=0;c<a.windows;c++){const{nextN:h,offset:l,isZero:u,isNeg:d,isNegF:p,offsetF:f}=Bo(r,c,a);r=h,u?o=o.add(Qs(p,i[f])):n=n.add(Qs(d,i[l]))}return qo(r),{p:n,f:o}},wNAFUnsafe(t,i,r,n=s.ZERO){const o=yr(t,e);for(let a=0;a<o.windows&&r!==_s;a++){const{nextN:c,offset:h,isZero:l,isNeg:u}=Bo(r,a,o);if(r=c,!l){const d=i[h];n=n.add(u?d.negate():d)}}return qo(r),n},getPrecomputes(t,i,r){let n=mr.get(i);return n||(n=this.precomputeWindow(i,t),t!==1&&(typeof r=="function"&&(n=r(n)),mr.set(i,n))),n},wNAFCached(t,i,r){const n=wr(t);return this.wNAF(n,this.getPrecomputes(n,t,r),i)},wNAFCachedUnsafe(t,i,r,n){const o=wr(t);return o===1?this.unsafeLadder(t,i,n):this.wNAFUnsafe(o,this.getPrecomputes(o,t,r),i,n)},setWindowSize(t,i){rh(i,e),nh.set(t,i),mr.delete(t)}}}function Xg(s,e,t,i){let r=e,n=s.ZERO,o=s.ZERO;for(;t>_s||i>_s;)t&Zt&&(n=n.add(r)),i&Zt&&(o=o.add(r)),r=r.double(),t>>=Zt,i>>=Zt;return{p1:n,p2:o}}function ey(s,e,t,i){Yg(t,s),Zg(i,e);const r=t.length,n=i.length;if(r!==n)throw new Error("arrays of points and scalars must have equal length");const o=s.ZERO,a=qg(BigInt(r));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const h=tr(c),l=new Array(Number(h)+1).fill(o),u=Math.floor((e.BITS-1)/c)*c;let d=o;for(let p=u;p>=0;p-=c){l.fill(o);for(let g=0;g<n;g++){const m=i[g],x=Number(m>>BigInt(p)&h);l[x]=l[x].add(t[g])}let f=o;for(let g=l.length-1,m=o;g>0;g--)m=m.add(l[g]),f=f.add(m);if(d=d.add(f),p!==0)for(let g=0;g<c;g++)d=d.double()}return d}function jo(s,e){if(e){if(e.ORDER!==s)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Vg(e),e}else return Ts(s)}function ty(s,e,t={}){if(!e||typeof e!="object")throw new Error(`expected valid ${s} CURVE object`);for(const o of["p","n","h"]){const a=e[o];if(!(typeof a=="bigint"&&a>_s))throw new Error(`CURVE.${o} must be positive bigint`)}const i=jo(e.p,t.Fp),r=jo(e.n,t.Fn),n=["Gx","Gy","a","b"];for(const o of n)if(!i.isValid(e[o]))throw new Error(`CURVE.${o} must be valid field element of CURVE.Fp`);return{Fp:i,Fn:r}}BigInt(0),BigInt(1),BigInt(2),BigInt(8);const Ls=BigInt(0),as=BigInt(1),Pi=BigInt(2);function sy(s){return sr(s,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...s})}function iy(s){const e=sy(s),{P:t,type:i,adjustScalarBytes:r,powPminus2:n,randomBytes:o}=e,a=i==="x25519";if(!a&&i!=="x448")throw new Error("invalid type");const c=o||Cs,h=a?255:448,l=a?32:56,u=BigInt(a?9:5),d=BigInt(a?121665:39081),p=a?Pi**BigInt(254):Pi**BigInt(447),f=a?BigInt(8)*Pi**BigInt(251)-as:BigInt(4)*Pi**BigInt(445)-as,g=p+f+as,m=y=>Ge(y,t),x=E(u);function E(y){return Un(m(y),l)}function S(y){const v=Oe("u coordinate",y,l);return a&&(v[31]&=127),m(Hi(v))}function T(y){return Hi(r(Oe("scalar",y,l)))}function I(y,v){const w=C(S(v),T(y));if(w===Ls)throw new Error("invalid private or public key received");return E(w)}function R(y){return I(y,x)}function B(y,v,w){const b=m(y*(v-w));return v=m(v-b),w=m(w+b),{x_2:v,x_3:w}}function C(y,v){Yr("u",y,Ls,t),Yr("scalar",v,p,g);const w=v,b=y;let D=as,A=Ls,$=y,O=as,N=Ls;for(let _=BigInt(h-1);_>=Ls;_--){const M=w>>_&as;N^=M,{x_2:D,x_3:$}=B(N,D,$),{x_2:A,x_3:O}=B(N,A,O),N=M;const L=D+A,z=m(L*L),H=D-A,F=m(H*H),V=z-F,X=$+O,ae=$-O,ne=m(ae*L),re=m(X*H),Me=ne+re,yt=ne-re;$=m(Me*Me),O=m(b*m(yt*yt)),D=m(z*F),A=m(V*(z+m(d*V)))}({x_2:D,x_3:$}=B(N,D,$)),{x_2:A,x_3:O}=B(N,A,O);const j=n(A);return m(D*j)}return{scalarMult:I,scalarMultBase:R,getSharedSecret:(y,v)=>I(y,v),getPublicKey:y=>R(y),utils:{randomPrivateKey:()=>c(l)},GuBytes:x.slice()}}BigInt(0);const ry=BigInt(1),Lo=BigInt(2),ny=BigInt(3),oy=BigInt(5);BigInt(8);const oh={p:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function ay(s){const e=BigInt(10),t=BigInt(20),i=BigInt(40),r=BigInt(80),n=oh.p,o=s*s%n*s%n,a=et(o,Lo,n)*o%n,c=et(a,ry,n)*s%n,h=et(c,oy,n)*c%n,l=et(h,e,n)*h%n,u=et(l,t,n)*l%n,d=et(u,i,n)*u%n,p=et(d,r,n)*d%n,f=et(p,r,n)*d%n,g=et(f,e,n)*h%n;return{pow_p_5_8:et(g,Lo,n)*s%n,b2:o}}function cy(s){return s[0]&=248,s[31]&=127,s[31]|=64,s}const Zr=(()=>{const s=oh.p;return iy({P:s,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:i}=ay(e);return Ge(et(t,ny,s)*i,s)},adjustScalarBytes:cy})})();function Mo(s){s.lowS!==void 0&&Fi("lowS",s.lowS),s.prehash!==void 0&&Fi("prehash",s.prehash)}class hy extends Error{constructor(e=""){super(e)}}const It={Err:hy,_tlv:{encode:(s,e)=>{const{Err:t}=It;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const i=e.length/2,r=Di(i);if(r.length/2&128)throw new t("tlv.encode: long form length too big");const n=i>127?Di(r.length/2|128):"";return Di(s)+n+r+e},decode(s,e){const{Err:t}=It;let i=0;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[i++]!==s)throw new t("tlv.decode: wrong tlv");const r=e[i++],n=!!(r&128);let o=0;if(!n)o=r;else{const c=r&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const h=e.subarray(i,i+c);if(h.length!==c)throw new t("tlv.decode: length bytes not complete");if(h[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const l of h)o=o<<8|l;if(i+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(i,i+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(i+o)}}},_int:{encode(s){const{Err:e}=It;if(s<Xs)throw new e("integer: negative integers are not allowed");let t=Di(s);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(s){const{Err:e}=It;if(s[0]&128)throw new e("invalid signature integer: negative");if(s[0]===0&&!(s[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return er(s)}},toSig(s){const{Err:e,_int:t,_tlv:i}=It,r=Oe("signature",s),{v:n,l:o}=i.decode(48,r);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=i.decode(2,n),{v:h,l}=i.decode(2,c);if(l.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(h)}},hexFromSig(s){const{_tlv:e,_int:t}=It,i=e.encode(2,t.encode(s.r)),r=e.encode(2,t.encode(s.s)),n=i+r;return e.encode(48,n)}},Xs=BigInt(0),ei=BigInt(1),ly=BigInt(2),Si=BigInt(3),uy=BigInt(4);function dy(s,e,t){function i(r){const n=s.sqr(r),o=s.mul(n,r);return s.add(s.add(o,s.mul(r,e)),t)}return i}function ah(s,e,t){const{BYTES:i}=s;function r(n){let o;if(typeof n=="bigint")o=n;else{let a=Oe("private key",n);if(e){if(!e.includes(a.length*2))throw new Error("invalid private key");const c=new Uint8Array(i);c.set(a,c.length-a.length),a=c}try{o=s.fromBytes(a)}catch{throw new Error(`invalid private key: expected ui8a of size ${i}, got ${typeof n}`)}}if(t&&(o=s.create(o)),!s.isValidNot0(o))throw new Error("invalid private key: out of range [1..N-1]");return o}return r}function fy(s,e={}){const{Fp:t,Fn:i}=ty("weierstrass",s,e),{h:r,n}=s;sr(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:o}=e;if(o&&(!t.is0(s.a)||typeof o.beta!="bigint"||typeof o.splitScalar!="function"))throw new Error('invalid endo: expected "beta": bigint and "splitScalar": function');function a(){if(!t.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function c(C,y,v){const{x:w,y:b}=y.toAffine(),D=t.toBytes(w);if(Fi("isCompressed",v),v){a();const A=!t.isOdd(b);return Jt(ch(A),D)}else return Jt(Uint8Array.of(4),D,t.toBytes(b))}function h(C){Je(C);const y=t.BYTES,v=y+1,w=2*y+1,b=C.length,D=C[0],A=C.subarray(1);if(b===v&&(D===2||D===3)){const $=t.fromBytes(A);if(!t.isValid($))throw new Error("bad point: is not on curve, wrong x");const O=d($);let N;try{N=t.sqrt(O)}catch(_){const M=_ instanceof Error?": "+_.message:"";throw new Error("bad point: is not on curve, sqrt error"+M)}a();const j=t.isOdd(N);return(D&1)===1!==j&&(N=t.neg(N)),{x:$,y:N}}else if(b===w&&D===4){const $=t.fromBytes(A.subarray(y*0,y*1)),O=t.fromBytes(A.subarray(y*1,y*2));if(!p($,O))throw new Error("bad point: is not on curve");return{x:$,y:O}}else throw new Error(`bad point: got length ${b}, expected compressed=${v} or uncompressed=${w}`)}const l=e.toBytes||c,u=e.fromBytes||h,d=dy(t,s.a,s.b);function p(C,y){const v=t.sqr(y),w=d(C);return t.eql(v,w)}if(!p(s.Gx,s.Gy))throw new Error("bad curve params: generator point");const f=t.mul(t.pow(s.a,Si),uy),g=t.mul(t.sqr(s.b),BigInt(27));if(t.is0(t.add(f,g)))throw new Error("bad curve params: a or b");function m(C,y,v=!1){if(!t.isValid(y)||v&&t.is0(y))throw new Error(`bad point coordinate ${C}`);return y}function x(C){if(!(C instanceof I))throw new Error("ProjectivePoint expected")}const E=No((C,y)=>{const{px:v,py:w,pz:b}=C;if(t.eql(b,t.ONE))return{x:v,y:w};const D=C.is0();y==null&&(y=D?t.ONE:t.inv(b));const A=t.mul(v,y),$=t.mul(w,y),O=t.mul(b,y);if(D)return{x:t.ZERO,y:t.ZERO};if(!t.eql(O,t.ONE))throw new Error("invZ was invalid");return{x:A,y:$}}),S=No(C=>{if(C.is0()){if(e.allowInfinityPoint&&!t.is0(C.py))return;throw new Error("bad point: ZERO")}const{x:y,y:v}=C.toAffine();if(!t.isValid(y)||!t.isValid(v))throw new Error("bad point: x or y not field elements");if(!p(y,v))throw new Error("bad point: equation left != right");if(!C.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function T(C,y,v,w,b){return v=new I(t.mul(v.px,C),v.py,v.pz),y=Qs(w,y),v=Qs(b,v),y.add(v)}class I{constructor(y,v,w){this.px=m("x",y),this.py=m("y",v,!0),this.pz=m("z",w),Object.freeze(this)}static fromAffine(y){const{x:v,y:w}=y||{};if(!y||!t.isValid(v)||!t.isValid(w))throw new Error("invalid affine point");if(y instanceof I)throw new Error("projective point not allowed");return t.is0(v)&&t.is0(w)?I.ZERO:new I(v,w,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(y){return Jg(I,"pz",y)}static fromBytes(y){return Je(y),I.fromHex(y)}static fromHex(y){const v=I.fromAffine(u(Oe("pointHex",y)));return v.assertValidity(),v}static fromPrivateKey(y){const v=ah(i,e.allowedPrivateKeyLengths,e.wrapPrivateKey);return I.BASE.multiply(v(y))}static msm(y,v){return ey(I,i,y,v)}precompute(y=8,v=!0){return B.setWindowSize(this,y),v||this.multiply(Si),this}_setWindowSize(y){this.precompute(y)}assertValidity(){S(this)}hasEvenY(){const{y}=this.toAffine();if(!t.isOdd)throw new Error("Field doesn't support isOdd");return!t.isOdd(y)}equals(y){x(y);const{px:v,py:w,pz:b}=this,{px:D,py:A,pz:$}=y,O=t.eql(t.mul(v,$),t.mul(D,b)),N=t.eql(t.mul(w,$),t.mul(A,b));return O&&N}negate(){return new I(this.px,t.neg(this.py),this.pz)}double(){const{a:y,b:v}=s,w=t.mul(v,Si),{px:b,py:D,pz:A}=this;let $=t.ZERO,O=t.ZERO,N=t.ZERO,j=t.mul(b,b),_=t.mul(D,D),M=t.mul(A,A),L=t.mul(b,D);return L=t.add(L,L),N=t.mul(b,A),N=t.add(N,N),$=t.mul(y,N),O=t.mul(w,M),O=t.add($,O),$=t.sub(_,O),O=t.add(_,O),O=t.mul($,O),$=t.mul(L,$),N=t.mul(w,N),M=t.mul(y,M),L=t.sub(j,M),L=t.mul(y,L),L=t.add(L,N),N=t.add(j,j),j=t.add(N,j),j=t.add(j,M),j=t.mul(j,L),O=t.add(O,j),M=t.mul(D,A),M=t.add(M,M),j=t.mul(M,L),$=t.sub($,j),N=t.mul(M,_),N=t.add(N,N),N=t.add(N,N),new I($,O,N)}add(y){x(y);const{px:v,py:w,pz:b}=this,{px:D,py:A,pz:$}=y;let O=t.ZERO,N=t.ZERO,j=t.ZERO;const _=s.a,M=t.mul(s.b,Si);let L=t.mul(v,D),z=t.mul(w,A),H=t.mul(b,$),F=t.add(v,w),V=t.add(D,A);F=t.mul(F,V),V=t.add(L,z),F=t.sub(F,V),V=t.add(v,b);let X=t.add(D,$);return V=t.mul(V,X),X=t.add(L,H),V=t.sub(V,X),X=t.add(w,b),O=t.add(A,$),X=t.mul(X,O),O=t.add(z,H),X=t.sub(X,O),j=t.mul(_,V),O=t.mul(M,H),j=t.add(O,j),O=t.sub(z,j),j=t.add(z,j),N=t.mul(O,j),z=t.add(L,L),z=t.add(z,L),H=t.mul(_,H),V=t.mul(M,V),z=t.add(z,H),H=t.sub(L,H),H=t.mul(_,H),V=t.add(V,H),L=t.mul(z,V),N=t.add(N,L),L=t.mul(X,V),O=t.mul(F,O),O=t.sub(O,L),L=t.mul(F,z),j=t.mul(X,j),j=t.add(j,L),new I(O,N,j)}subtract(y){return this.add(y.negate())}is0(){return this.equals(I.ZERO)}multiply(y){const{endo:v}=e;if(!i.isValidNot0(y))throw new Error("invalid scalar: out of range");let w,b;const D=A=>B.wNAFCached(this,A,I.normalizeZ);if(v){const{k1neg:A,k1:$,k2neg:O,k2:N}=v.splitScalar(y),{p:j,f:_}=D($),{p:M,f:L}=D(N);b=_.add(L),w=T(v.beta,j,M,A,O)}else{const{p:A,f:$}=D(y);w=A,b=$}return I.normalizeZ([w,b])[0]}multiplyUnsafe(y){const{endo:v}=e,w=this;if(!i.isValid(y))throw new Error("invalid scalar: out of range");if(y===Xs||w.is0())return I.ZERO;if(y===ei)return w;if(B.hasPrecomputes(this))return this.multiply(y);if(v){const{k1neg:b,k1:D,k2neg:A,k2:$}=v.splitScalar(y),{p1:O,p2:N}=Xg(I,w,D,$);return T(v.beta,O,N,b,A)}else return B.wNAFCachedUnsafe(w,y)}multiplyAndAddUnsafe(y,v,w){const b=this.multiplyUnsafe(v).add(y.multiplyUnsafe(w));return b.is0()?void 0:b}toAffine(y){return E(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return r===ei?!0:y?y(I,this):B.wNAFCachedUnsafe(this,n).is0()}clearCofactor(){const{clearCofactor:y}=e;return r===ei?this:y?y(I,this):this.multiplyUnsafe(r)}toBytes(y=!0){return Fi("isCompressed",y),this.assertValidity(),l(I,this,y)}toRawBytes(y=!0){return this.toBytes(y)}toHex(y=!0){return ci(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}I.BASE=new I(s.Gx,s.Gy,t.ONE),I.ZERO=new I(t.ZERO,t.ONE,t.ZERO),I.Fp=t,I.Fn=i;const R=i.BITS,B=Qg(I,e.endo?Math.ceil(R/2):R);return I}function ch(s){return Uint8Array.of(s?2:3)}function py(s,e,t={}){sr(e,{hash:"function"},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const i=e.randomBytes||Cs,r=e.hmac||((w,...b)=>Qi(e.hash,w,Jt(...b))),{Fp:n,Fn:o}=s,{ORDER:a,BITS:c}=o;function h(w){const b=a>>ei;return w>b}function l(w){return h(w)?o.neg(w):w}function u(w,b){if(!o.isValidNot0(b))throw new Error(`invalid signature ${w}: out of range 1..CURVE.n`)}class d{constructor(b,D,A){u("r",b),u("s",D),this.r=b,this.s=D,A!=null&&(this.recovery=A),Object.freeze(this)}static fromCompact(b){const D=o.BYTES,A=Oe("compactSignature",b,D*2);return new d(o.fromBytes(A.subarray(0,D)),o.fromBytes(A.subarray(D,D*2)))}static fromDER(b){const{r:D,s:A}=It.toSig(Oe("DER",b));return new d(D,A)}assertValidity(){}addRecoveryBit(b){return new d(this.r,this.s,b)}recoverPublicKey(b){const D=n.ORDER,{r:A,s:$,recovery:O}=this;if(O==null||![0,1,2,3].includes(O))throw new Error("recovery id invalid");if(a*ly<D&&O>1)throw new Error("recovery id is ambiguous for h>1 curve");const N=O===2||O===3?A+a:A;if(!n.isValid(N))throw new Error("recovery id 2 or 3 invalid");const j=n.toBytes(N),_=s.fromHex(Jt(ch((O&1)===0),j)),M=o.inv(N),L=S(Oe("msgHash",b)),z=o.create(-L*M),H=o.create($*M),F=s.BASE.multiplyUnsafe(z).add(_.multiplyUnsafe(H));if(F.is0())throw new Error("point at infinify");return F.assertValidity(),F}hasHighS(){return h(this.s)}normalizeS(){return this.hasHighS()?new d(this.r,o.neg(this.s),this.recovery):this}toBytes(b){if(b==="compact")return Jt(o.toBytes(this.r),o.toBytes(this.s));if(b==="der")return On(It.hexFromSig(this));throw new Error("invalid format")}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return ci(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return ci(this.toBytes("compact"))}}const p=ah(o,t.allowedPrivateKeyLengths,t.wrapPrivateKey),f={isValidPrivateKey(w){try{return p(w),!0}catch{return!1}},normPrivateKeyToScalar:p,randomPrivateKey:()=>{const w=a;return Wg(i(ih(w)),w)},precompute(w=8,b=s.BASE){return b.precompute(w,!1)}};function g(w,b=!0){return s.fromPrivateKey(w).toBytes(b)}function m(w){if(typeof w=="bigint")return!1;if(w instanceof s)return!0;const b=Oe("key",w).length,D=n.BYTES,A=D+1,$=2*D+1;if(!(t.allowedPrivateKeyLengths||o.BYTES===A))return b===A||b===$}function x(w,b,D=!0){if(m(w)===!0)throw new Error("first arg must be private key");if(m(b)===!1)throw new Error("second arg must be public key");return s.fromHex(b).multiply(p(w)).toBytes(D)}const E=e.bits2int||function(w){if(w.length>8192)throw new Error("input is too large");const b=er(w),D=w.length*8-c;return D>0?b>>BigInt(D):b},S=e.bits2int_modN||function(w){return o.create(E(w))},T=tr(c);function I(w){return Yr("num < 2^"+c,w,Xs,T),o.toBytes(w)}function R(w,b,D=B){if(["recovered","canonical"].some(F=>F in D))throw new Error("sign() legacy options not supported");const{hash:A}=e;let{lowS:$,prehash:O,extraEntropy:N}=D;$==null&&($=!0),w=Oe("msgHash",w),Mo(D),O&&(w=Oe("prehashed msgHash",A(w)));const j=S(w),_=p(b),M=[I(_),I(j)];if(N!=null&&N!==!1){const F=N===!0?i(n.BYTES):N;M.push(Oe("extraEntropy",F))}const L=Jt(...M),z=j;function H(F){const V=E(F);if(!o.isValidNot0(V))return;const X=o.inv(V),ae=s.BASE.multiply(V).toAffine(),ne=o.create(ae.x);if(ne===Xs)return;const re=o.create(X*o.create(z+ne*_));if(re===Xs)return;let Me=(ae.x===ne?0:2)|Number(ae.y&ei),yt=re;return $&&h(re)&&(yt=l(re),Me^=1),new d(ne,yt,Me)}return{seed:L,k2sig:H}}const B={lowS:e.lowS,prehash:!1},C={lowS:e.lowS,prehash:!1};function y(w,b,D=B){const{seed:A,k2sig:$}=R(w,b,D);return jg(e.hash.outputLen,o.BYTES,r)(A,$)}s.BASE.precompute(8);function v(w,b,D,A=C){const $=w;b=Oe("msgHash",b),D=Oe("publicKey",D),Mo(A);const{lowS:O,prehash:N,format:j}=A;if("strict"in A)throw new Error("options.strict was renamed to lowS");if(j!==void 0&&!["compact","der","js"].includes(j))throw new Error('format must be "compact", "der" or "js"');const _=typeof $=="string"||_n($),M=!_&&!j&&typeof $=="object"&&$!==null&&typeof $.r=="bigint"&&typeof $.s=="bigint";if(!_&&!M)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let L,z;try{if(M)if(j===void 0||j==="js")L=new d($.r,$.s);else throw new Error("invalid format");if(_){try{j!=="compact"&&(L=d.fromDER($))}catch(Me){if(!(Me instanceof It.Err))throw Me}!L&&j!=="der"&&(L=d.fromCompact($))}z=s.fromHex(D)}catch{return!1}if(!L||O&&L.hasHighS())return!1;N&&(b=e.hash(b));const{r:H,s:F}=L,V=S(b),X=o.inv(F),ae=o.create(V*X),ne=o.create(H*X),re=s.BASE.multiplyUnsafe(ae).add(z.multiplyUnsafe(ne));return re.is0()?!1:o.create(re.x)===H}return Object.freeze({getPublicKey:g,getSharedSecret:x,sign:y,verify:v,utils:f,Point:s,Signature:d})}function gy(s){const e={a:s.a,b:s.b,p:s.Fp.ORDER,n:s.n,h:s.h,Gx:s.Gx,Gy:s.Gy},t=s.Fp,i=Ts(e.n,s.nBitLength),r={Fp:t,Fn:i,allowedPrivateKeyLengths:s.allowedPrivateKeyLengths,allowInfinityPoint:s.allowInfinityPoint,endo:s.endo,wrapPrivateKey:s.wrapPrivateKey,isTorsionFree:s.isTorsionFree,clearCofactor:s.clearCofactor,fromBytes:s.fromBytes,toBytes:s.toBytes};return{CURVE:e,curveOpts:r}}function yy(s){const{CURVE:e,curveOpts:t}=gy(s),i={hash:s.hash,hmac:s.hmac,randomBytes:s.randomBytes,lowS:s.lowS,bits2int:s.bits2int,bits2int_modN:s.bits2int_modN};return{CURVE:e,curveOpts:t,ecdsaOpts:i}}function my(s,e){return Object.assign({},e,{ProjectivePoint:e.Point,CURVE:s})}function wy(s){const{CURVE:e,curveOpts:t,ecdsaOpts:i}=yy(s),r=fy(e,t),n=py(r,i,t);return my(s,n)}function Qr(s,e){const t=i=>wy({...s,hash:i});return{...t(e),create:t}}const hh={p:BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff"),n:BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),h:BigInt(1),a:BigInt("0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc"),b:BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),Gx:BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),Gy:BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5")},lh={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000ffffffff"),n:BigInt("0xffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973"),h:BigInt(1),a:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffeffffffff0000000000000000fffffffc"),b:BigInt("0xb3312fa7e23ee7e4988e056be3f82d19181d9c6efe8141120314088f5013875ac656398d8a2ed19d2a85c8edd3ec2aef"),Gx:BigInt("0xaa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7"),Gy:BigInt("0x3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f")},uh={p:BigInt("0x1ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),n:BigInt("0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409"),h:BigInt(1),a:BigInt("0x1fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc"),b:BigInt("0x0051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00"),Gx:BigInt("0x00c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66"),Gy:BigInt("0x011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650")},by=Ts(hh.p),vy=Ts(lh.p),Ey=Ts(uh.p),Iy=Qr({...hh,Fp:by,lowS:!1},Zi);Qr({...lh,Fp:vy,lowS:!1},Op),Qr({...uh,Fp:Ey,lowS:!1,allowedPrivateKeyLengths:[130,131,132]},Ap);const xy=Iy,dh="base10",Se="base16",Te="base64pad",Bt="base64url",mi="utf8",fh=0,xt=1,wi=2,Dy=0,zo=1,ti=12,kn=32;function Py(){const s=Zr.utils.randomPrivateKey(),e=Zr.getPublicKey(s);return{privateKey:Ne(s,Se),publicKey:Ne(e,Se)}}function Xr(){const s=Cs(kn);return Ne(s,Se)}function Sy(s,e){const t=Zr.getSharedSecret(We(s,Se),We(e,Se)),i=kg(Xi,t,void 0,void 0,kn);return Ne(i,Se)}function Ri(s){const e=Xi(We(s,Se));return Ne(e,Se)}function Ke(s){const e=Xi(We(s,mi));return Ne(e,Se)}function ph(s){return We(`${s}`,dh)}function es(s){return Number(Ne(s,dh))}function gh(s){return s.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function yh(s){const e=s.replace(/-/g,"+").replace(/_/g,"/"),t=(4-e.length%4)%4;return e+"=".repeat(t)}function _y(s){const e=ph(typeof s.type<"u"?s.type:fh);if(es(e)===xt&&typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");const t=typeof s.senderPublicKey<"u"?We(s.senderPublicKey,Se):void 0,i=typeof s.iv<"u"?We(s.iv,Se):Cs(ti),r=We(s.symKey,Se),n=Wc(r,i).encrypt(We(s.message,mi)),o=mh({type:e,sealed:n,iv:i,senderPublicKey:t});return s.encoding===Bt?gh(o):o}function $y(s){const e=We(s.symKey,Se),{sealed:t,iv:i}=li({encoded:s.encoded,encoding:s.encoding}),r=Wc(e,i).decrypt(t);if(r===null)throw new Error("Failed to decrypt");return Ne(r,mi)}function Ay(s,e){const t=ph(wi),i=Cs(ti),r=We(s,mi),n=mh({type:t,sealed:r,iv:i});return e===Bt?gh(n):n}function Oy(s,e){const{sealed:t}=li({encoded:s,encoding:e});return Ne(t,mi)}function mh(s){if(es(s.type)===wi)return Ne(Zs([s.type,s.sealed]),Te);if(es(s.type)===xt){if(typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return Ne(Zs([s.type,s.senderPublicKey,s.iv,s.sealed]),Te)}return Ne(Zs([s.type,s.iv,s.sealed]),Te)}function li(s){const e=(s.encoding||Te)===Bt?yh(s.encoded):s.encoded,t=We(e,Te),i=t.slice(Dy,zo),r=zo;if(es(i)===xt){const c=r+kn,h=c+ti,l=t.slice(r,c),u=t.slice(c,h),d=t.slice(h);return{type:i,sealed:d,iv:u,senderPublicKey:l}}if(es(i)===wi){const c=t.slice(r),h=Cs(ti);return{type:i,sealed:c,iv:h}}const n=r+ti,o=t.slice(r,n),a=t.slice(n);return{type:i,sealed:a,iv:o}}function Cy(s,e){const t=li({encoded:s,encoding:e==null?void 0:e.encoding});return wh({type:es(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?Ne(t.senderPublicKey,Se):void 0,receiverPublicKey:e==null?void 0:e.receiverPublicKey})}function wh(s){const e=(s==null?void 0:s.type)||fh;if(e===xt){if(typeof(s==null?void 0:s.senderPublicKey)>"u")throw new Error("missing sender public key");if(typeof(s==null?void 0:s.receiverPublicKey)>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:s==null?void 0:s.senderPublicKey,receiverPublicKey:s==null?void 0:s.receiverPublicKey}}function Fo(s){return s.type===xt&&typeof s.senderPublicKey=="string"&&typeof s.receiverPublicKey=="string"}function Ho(s){return s.type===wi}function Ty(s){const e=Buffer.from(s.x,"base64"),t=Buffer.from(s.y,"base64");return Zs([new Uint8Array([4]),e,t])}function Ry(s,e){const[t,i,r]=s.split("."),n=Buffer.from(yh(r),"base64");if(n.length!==64)throw new Error("Invalid signature length");const o=n.slice(0,32),a=n.slice(32,64),c=`${t}.${i}`,h=Xi(c),l=Ty(e);if(!xy.verify(Zs([o,a]),h,l))throw new Error("Invalid signature");return Nr(s).payload}const Ny="irn";function Vi(s){return(s==null?void 0:s.relay)||{protocol:Ny}}function Es(s){const e=sl[s];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${s}`);return e}function Uy(s,e="-"){const t={},i="relay"+e;return Object.keys(s).forEach(r=>{if(r.startsWith(i)){const n=r.replace(i,""),o=s[r];t[n]=o}}),t}function Vo(s){if(!s.includes("wc:")){const h=Ac(s);h!=null&&h.includes("wc:")&&(s=h)}s=s.includes("wc://")?s.replace("wc://",""):s,s=s.includes("wc:")?s.replace("wc:",""):s;const e=s.indexOf(":"),t=s.indexOf("?")!==-1?s.indexOf("?"):void 0,i=s.substring(0,e),r=s.substring(e+1,t).split("@"),n=typeof t<"u"?s.substring(t):"",o=new URLSearchParams(n),a={};o.forEach((h,l)=>{a[l]=h});const c=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:i,topic:ky(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:Uy(a),methods:c,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function ky(s){return s.startsWith("//")?s.substring(2):s}function By(s,e="-"){const t="relay",i={};return Object.keys(s).forEach(r=>{const n=r,o=t+e+n;s[n]&&(i[o]=s[n])}),i}function Ko(s){const e=new URLSearchParams,t=By(s.relay);Object.keys(t).sort().forEach(r=>{e.set(r,t[r])}),e.set("symKey",s.symKey),s.expiryTimestamp&&e.set("expiryTimestamp",s.expiryTimestamp.toString()),s.methods&&e.set("methods",s.methods.join(","));const i=e.toString();return`${s.protocol}:${s.topic}@${s.version}?${i}`}function _i(s,e,t){return`${s}?wc_ev=${t}&topic=${e}`}var qy=Object.defineProperty,jy=Object.defineProperties,Ly=Object.getOwnPropertyDescriptors,Go=Object.getOwnPropertySymbols,My=Object.prototype.hasOwnProperty,zy=Object.prototype.propertyIsEnumerable,Wo=(s,e,t)=>e in s?qy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Fy=(s,e)=>{for(var t in e||(e={}))My.call(e,t)&&Wo(s,t,e[t]);if(Go)for(var t of Go(e))zy.call(e,t)&&Wo(s,t,e[t]);return s},Hy=(s,e)=>jy(s,Ly(e));function Rs(s){const e=[];return s.forEach(t=>{const[i,r]=t.split(":");e.push(`${i}:${r}`)}),e}function Vy(s){const e=[];return Object.values(s).forEach(t=>{e.push(...Rs(t.accounts))}),e}function Ky(s,e){const t=[];return Object.values(s).forEach(i=>{Rs(i.accounts).includes(e)&&t.push(...i.methods)}),t}function Gy(s,e){const t=[];return Object.values(s).forEach(i=>{Rs(i.accounts).includes(e)&&t.push(...i.events)}),t}function ir(s){return s.includes(":")}function Is(s){return ir(s)?s.split(":")[0]:s}function Jo(s){var e,t,i;const r={};if(!ft(s))return r;for(const[n,o]of Object.entries(s)){const a=ir(n)?[n]:o.chains,c=o.methods||[],h=o.events||[],l=Is(n);r[l]=Hy(Fy({},r[l]),{chains:dt(a,(e=r[l])==null?void 0:e.chains),methods:dt(c,(t=r[l])==null?void 0:t.methods),events:dt(h,(i=r[l])==null?void 0:i.events)})}return r}function Wy(s){const e={};return s==null||s.forEach(t=>{var i;const[r,n]=t.split(":");e[r]||(e[r]={accounts:[],chains:[],events:[],methods:[]}),e[r].accounts.push(t),(i=e[r].chains)==null||i.push(`${r}:${n}`)}),e}function Yo(s,e){e=e.map(i=>i.replace("did:pkh:",""));const t=Wy(e);for(const[i,r]of Object.entries(t))r.methods?r.methods=dt(r.methods,s):r.methods=s,r.events=["chainChanged","accountsChanged"];return t}function Jy(s,e){var t,i,r,n,o,a;const c=Jo(s),h=Jo(e),l={},u=Object.keys(c).concat(Object.keys(h));for(const d of u)l[d]={chains:dt((t=c[d])==null?void 0:t.chains,(i=h[d])==null?void 0:i.chains),methods:dt((r=c[d])==null?void 0:r.methods,(n=h[d])==null?void 0:n.methods),events:dt((o=c[d])==null?void 0:o.events,(a=h[d])==null?void 0:a.events)};return l}const Yy={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Zy={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function U(s,e){const{message:t,code:i}=Zy[s];return{message:e?`${t} ${e}`:t,code:i}}function ie(s,e){const{message:t,code:i}=Yy[s];return{message:e?`${t} ${e}`:t,code:i}}function Dt(s,e){return!!Array.isArray(s)}function ft(s){return Object.getPrototypeOf(s)===Object.prototype&&Object.keys(s).length}function de(s){return typeof s>"u"}function le(s,e){return e&&de(s)?!0:typeof s=="string"&&!!s.trim().length}function Bn(s,e){return e&&de(s)?!0:typeof s=="number"&&!isNaN(s)}function Qy(s,e){const{requiredNamespaces:t}=e,i=Object.keys(s.namespaces),r=Object.keys(t);let n=!0;return Wt(r,i)?(i.forEach(o=>{const{accounts:a,methods:c,events:h}=s.namespaces[o],l=Rs(a),u=t[o];(!Wt(Dc(o,u),l)||!Wt(u.methods,c)||!Wt(u.events,h))&&(n=!1)}),n):!1}function Ki(s){return le(s,!1)&&s.includes(":")?s.split(":").length===2:!1}function Xy(s){if(le(s,!1)&&s.includes(":")){const e=s.split(":");if(e.length===3){const t=e[0]+":"+e[1];return!!e[2]&&Ki(t)}}return!1}function em(s){function e(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(le(s,!1)){if(e(s))return!0;const t=Ac(s);return e(t)}}catch{}return!1}function tm(s){var e;return(e=s==null?void 0:s.proposer)==null?void 0:e.publicKey}function sm(s){return s==null?void 0:s.topic}function im(s,e){let t=null;return le(s==null?void 0:s.publicKey,!1)||(t=U("MISSING_OR_INVALID",`${e} controller public key should be a string`)),t}function Zo(s){let e=!0;return Dt(s)?s.length&&(e=s.every(t=>le(t,!1))):e=!1,e}function rm(s,e,t){let i=null;return Dt(e)&&e.length?e.forEach(r=>{i||Ki(r)||(i=ie("UNSUPPORTED_CHAINS",`${t}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):Ki(s)||(i=ie("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),i}function nm(s,e,t){let i=null;return Object.entries(s).forEach(([r,n])=>{if(i)return;const o=rm(r,Dc(r,n),`${e} ${t}`);o&&(i=o)}),i}function om(s,e){let t=null;return Dt(s)?s.forEach(i=>{t||Xy(i)||(t=ie("UNSUPPORTED_ACCOUNTS",`${e}, account ${i} should be a string and conform to "namespace:chainId:address" format`))}):t=ie("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function am(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;const r=om(i==null?void 0:i.accounts,`${e} namespace`);r&&(t=r)}),t}function cm(s,e){let t=null;return Zo(s==null?void 0:s.methods)?Zo(s==null?void 0:s.events)||(t=ie("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):t=ie("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),t}function bh(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;const r=cm(i,`${e}, namespace`);r&&(t=r)}),t}function hm(s,e,t){let i=null;if(s&&ft(s)){const r=bh(s,e);r&&(i=r);const n=nm(s,e,t);n&&(i=n)}else i=U("MISSING_OR_INVALID",`${e}, ${t} should be an object with data`);return i}function br(s,e){let t=null;if(s&&ft(s)){const i=bh(s,e);i&&(t=i);const r=am(s,e);r&&(t=r)}else t=U("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return t}function vh(s){return le(s.protocol,!0)}function lm(s,e){let t=!1;return s?s&&Dt(s)&&s.length&&s.forEach(i=>{t=vh(i)}):t=!0,t}function um(s){return typeof s=="number"}function Ae(s){return typeof s<"u"&&typeof s!==null}function dm(s){return!(!s||typeof s!="object"||!s.code||!Bn(s.code,!1)||!s.message||!le(s.message,!1))}function fm(s){return!(de(s)||!le(s.method,!1))}function pm(s){return!(de(s)||de(s.result)&&de(s.error)||!Bn(s.id,!1)||!le(s.jsonrpc,!1))}function gm(s){return!(de(s)||!le(s.name,!1))}function Qo(s,e){return!(!Ki(e)||!Vy(s).includes(e))}function ym(s,e,t){return le(t,!1)?Ky(s,e).includes(t):!1}function mm(s,e,t){return le(t,!1)?Gy(s,e).includes(t):!1}function Xo(s,e,t){let i=null;const r=wm(s),n=bm(e),o=Object.keys(r),a=Object.keys(n),c=ea(Object.keys(s)),h=ea(Object.keys(e)),l=c.filter(u=>!h.includes(u));return l.length&&(i=U("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${l.toString()}
      Received: ${Object.keys(e).toString()}`)),Wt(o,a)||(i=U("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${o.toString()}
      Approved: ${a.toString()}`)),Object.keys(e).forEach(u=>{if(!u.includes(":")||i)return;const d=Rs(e[u].accounts);d.includes(u)||(i=U("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${u}
        Required: ${u}
        Approved: ${d.toString()}`))}),o.forEach(u=>{i||(Wt(r[u].methods,n[u].methods)?Wt(r[u].events,n[u].events)||(i=U("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${u}`)):i=U("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${u}`))}),i}function wm(s){const e={};return Object.keys(s).forEach(t=>{var i;t.includes(":")?e[t]=s[t]:(i=s[t].chains)==null||i.forEach(r=>{e[r]={methods:s[t].methods,events:s[t].events}})}),e}function ea(s){return[...new Set(s.map(e=>e.includes(":")?e.split(":")[0]:e))]}function bm(s){const e={};return Object.keys(s).forEach(t=>{if(t.includes(":"))e[t]=s[t];else{const i=Rs(s[t].accounts);i==null||i.forEach(r=>{e[r]={accounts:s[t].accounts.filter(n=>n.includes(`${r}:`)),methods:s[t].methods,events:s[t].events}})}}),e}function vm(s,e){return Bn(s,!1)&&s<=e.max&&s>=e.min}function ta(){const s=gi();return new Promise(e=>{switch(s){case je.browser:e(Em());break;case je.reactNative:e(Im());break;case je.node:e(xm());break;default:e(!0)}})}function Em(){return Os()&&(navigator==null?void 0:navigator.onLine)}async function Im(){if(zt()&&typeof global<"u"&&global!=null&&global.NetInfo){const s=await(global==null?void 0:global.NetInfo.fetch());return s==null?void 0:s.isConnected}return!0}function xm(){return!0}function Dm(s){switch(gi()){case je.browser:Pm(s);break;case je.reactNative:Sm(s);break}}function Pm(s){!zt()&&Os()&&(window.addEventListener("online",()=>s(!0)),window.addEventListener("offline",()=>s(!1)))}function Sm(s){zt()&&typeof global<"u"&&global!=null&&global.NetInfo&&(global==null||global.NetInfo.addEventListener(e=>s(e==null?void 0:e.isConnected)))}function _m(){var s;return Os()&&Ps()?((s=Ps())==null?void 0:s.visibilityState)==="visible":!0}const vr={};class Ms{static get(e){return vr[e]}static set(e,t){vr[e]=t}static delete(e){delete vr[e]}}function $m(s){const e=fi.decode(s);if(e.length<33)throw new Error("Too short to contain a public key");return e.slice(1,33)}function Am({publicKey:s,signature:e,payload:t}){var i;const r=en(t.method),n=128|parseInt(((i=t.version)==null?void 0:i.toString())||"4"),o=Tm(t.address),a=t.era==="00"?new Uint8Array([0]):en(t.era);if(a.length!==1&&a.length!==2)throw new Error("Invalid era length");const c=parseInt(t.nonce,16),h=new Uint8Array([c&255,c>>8&255]),l=BigInt(`0x${Cm(t.tip)}`),u=Nm(l),d=new Uint8Array([0,...s,o,...e,...a,...h,...u,...r]),p=Rm(d.length+1);return new Uint8Array([...p,n,...d])}function Om(s){const e=en(s),t=ol.blake2b(e,void 0,32);return"0x"+Buffer.from(t).toString("hex")}function en(s){return new Uint8Array(s.replace(/^0x/,"").match(/.{1,2}/g).map(e=>parseInt(e,16)))}function Cm(s){return s.startsWith("0x")?s.slice(2):s}function Tm(s){const e=fi.decode(s)[0];return e===42?0:e===60?2:1}function Rm(s){if(s<64)return new Uint8Array([s<<2]);if(s<16384){const e=s<<2|1;return new Uint8Array([e&255,e>>8&255])}else if(s<1<<30){const e=s<<2|2;return new Uint8Array([e&255,e>>8&255,e>>16&255,e>>24&255])}else throw new Error("Compact encoding > 2^30 not supported")}function Nm(s){if(s<BigInt(1)<<BigInt(6))return new Uint8Array([Number(s<<BigInt(2))]);if(s<BigInt(1)<<BigInt(14)){const e=s<<BigInt(2)|BigInt(1);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255))])}else if(s<BigInt(1)<<BigInt(30)){const e=s<<BigInt(2)|BigInt(2);return new Uint8Array([Number(e&BigInt(255)),Number(e>>BigInt(8)&BigInt(255)),Number(e>>BigInt(16)&BigInt(255)),Number(e>>BigInt(24)&BigInt(255))])}else throw new Error("BigInt compact encoding not supported > 2^30")}function Um(s){const e=Uint8Array.from(Buffer.from(s.signature,"hex")),t=$m(s.transaction.address),i=Am({publicKey:t,signature:e,payload:s.transaction}),r=Buffer.from(i).toString("hex");return Om(r)}class Ze extends al{constructor(e){super(e),this.events=new gt.EventEmitter,this.hasRegisteredEventListeners=!1,this.connection=this.setConnection(e),this.connection.connected&&this.registerEventListeners()}async connect(e=this.connection){await this.open(e)}async disconnect(){await this.close()}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async request(e,t){return this.requestStrict(it(e.method,e.params||[],e.id||qt().toString()),t)}async requestStrict(e,t){return new Promise(async(i,r)=>{if(!this.connection.connected)try{await this.open()}catch(n){r(n)}this.events.on(`${e.id}`,n=>{st(n)?r(n.error):i(n.result)});try{await this.connection.send(e,t)}catch(n){r(n)}})}setConnection(e=this.connection){return e}onPayload(e){this.events.emit("payload",e),Gi(e)?this.events.emit(`${e.id}`,e):this.events.emit("message",{type:e.method,data:e.params})}onClose(e){e&&e.code===3e3&&this.events.emit("error",new Error(`WebSocket connection closed abnormally with code: ${e.code} ${e.reason?`(${e.reason})`:""}`)),this.events.emit("disconnect")}async open(e=this.connection){this.connection===e&&this.connection.connected||(this.connection.connected&&this.close(),typeof e=="string"&&(await this.connection.open(e),e=this.connection),this.connection=this.setConnection(e),await this.connection.open(),this.registerEventListeners(),this.events.emit("connect"))}async close(){await this.connection.close()}registerEventListeners(){this.hasRegisteredEventListeners||(this.connection.on("payload",e=>this.onPayload(e)),this.connection.on("close",e=>this.onClose(e)),this.connection.on("error",e=>this.events.emit("error",e)),this.connection.on("register_error",e=>this.onClose()),this.hasRegisteredEventListeners=!0)}}const km=()=>typeof WebSocket<"u"?WebSocket:typeof global<"u"&&typeof global.WebSocket<"u"?global.WebSocket:typeof window<"u"&&typeof window.WebSocket<"u"?window.WebSocket:typeof self<"u"&&typeof self.WebSocket<"u"?self.WebSocket:require("ws"),Bm=()=>typeof WebSocket<"u"||typeof global<"u"&&typeof global.WebSocket<"u"||typeof window<"u"&&typeof window.WebSocket<"u"||typeof self<"u"&&typeof self.WebSocket<"u",sa=s=>s.split("?")[0],ia=10,qm=km();let jm=class{constructor(e){if(this.url=e,this.events=new gt.EventEmitter,this.registering=!1,!Fn(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);this.url=e}get connected(){return typeof this.socket<"u"}get connecting(){return this.registering}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async open(e=this.url){await this.register(e)}async close(){return new Promise((e,t)=>{if(typeof this.socket>"u"){t(new Error("Connection already closed"));return}this.socket.onclose=i=>{this.onClose(i),e()},this.socket.close()})}async send(e){typeof this.socket>"u"&&(this.socket=await this.register());try{this.socket.send(ki(e))}catch(t){this.onError(e.id,t)}}register(e=this.url){if(!Fn(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);if(this.registering){const t=this.events.getMaxListeners();return(this.events.listenerCount("register_error")>=t||this.events.listenerCount("open")>=t)&&this.events.setMaxListeners(t+1),new Promise((i,r)=>{this.events.once("register_error",n=>{this.resetMaxListeners(),r(n)}),this.events.once("open",()=>{if(this.resetMaxListeners(),typeof this.socket>"u")return r(new Error("WebSocket connection is missing or invalid"));i(this.socket)})})}return this.url=e,this.registering=!0,new Promise((t,i)=>{const r=cl.isReactNative()?void 0:{rejectUnauthorized:!hl(e)},n=new qm(e,[],r);Bm()?n.onerror=o=>{const a=o;i(this.emitError(a.error))}:n.on("error",o=>{i(this.emitError(o))}),n.onopen=()=>{this.onOpen(n),t(n)}})}onOpen(e){e.onmessage=t=>this.onPayload(t),e.onclose=t=>this.onClose(t),this.socket=e,this.registering=!1,this.events.emit("open")}onClose(e){this.socket=void 0,this.registering=!1,this.events.emit("close",e)}onPayload(e){if(typeof e.data>"u")return;const t=typeof e.data=="string"?Ur(e.data):e.data;this.events.emit("payload",t)}onError(e,t){const i=this.parseError(t),r=i.message||i.toString(),n=mn(e,r);this.events.emit("payload",n)}parseError(e,t=this.url){return ll(e,sa(t),"WS")}resetMaxListeners(){this.events.getMaxListeners()>ia&&this.events.setMaxListeners(ia)}emitError(e){const t=this.parseError(new Error((e==null?void 0:e.message)||`WebSocket connection failed for host: ${sa(this.url)}`));return this.events.emit("register_error",t),t}};var Lm={};const Eh="wc",Ih=2,tn="core",pt=`${Eh}@2:${tn}:`,Mm={logger:"error"},zm={database:":memory:"},Fm="crypto",ra="client_ed25519_seed",Hm=k.ONE_DAY,Vm="keychain",Km="0.3",Gm="messages",Wm="0.3",Jm=k.SIX_HOURS,Ym="publisher",xh="irn",Zm="error",Dh="wss://relay.walletconnect.org",Qm="relayer",oe={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Xm="_subscription",ze={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},ew=.1,sn="2.21.8",se={link_mode:"link_mode",relay:"relay"},Ni={inbound:"inbound",outbound:"outbound"},tw="0.3",sw="WALLETCONNECT_CLIENT_ID",na="WALLETCONNECT_LINK_MODE_APPS",Be={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},iw="subscription",rw="0.3",nw="pairing",ow="0.3",zs={wc_pairingDelete:{req:{ttl:k.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:k.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:k.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:k.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:k.ONE_DAY,prompt:!1,tag:0},res:{ttl:k.ONE_DAY,prompt:!1,tag:0}}},Kt={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},Xe={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},aw="history",cw="0.3",hw="expirer",Ve={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},lw="0.3",uw="verify-api",dw="https://verify.walletconnect.com",Ph="https://verify.walletconnect.org",si=Ph,fw=`${si}/v3`,pw=[dw,Ph],gw="echo",yw="https://echo.walletconnect.com",ht={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},Et={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},Rt={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},Fs={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},Ft={authenticated_session_approve_started:"authenticated_session_approve_started",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve"},Hs={no_internet_connection:"no_internet_connection",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},mw=.1,ww="event-client",bw=86400,vw="https://pulse.walletconnect.org/batch";function Ew(s,e){if(s.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var r=0;r<s.length;r++){var n=s.charAt(r),o=n.charCodeAt(0);if(t[o]!==255)throw new TypeError(n+" is ambiguous");t[o]=r}var a=s.length,c=s.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,m=0,x=0,E=f.length;x!==E&&f[x]===0;)x++,g++;for(var S=(E-x)*l+1>>>0,T=new Uint8Array(S);x!==E;){for(var I=f[x],R=0,B=S-1;(I!==0||R<m)&&B!==-1;B--,R++)I+=256*T[B]>>>0,T[B]=I%a>>>0,I=I/a>>>0;if(I!==0)throw new Error("Non-zero carry");m=R,x++}for(var C=S-m;C!==S&&T[C]===0;)C++;for(var y=c.repeat(g);C<S;++C)y+=s.charAt(T[C]);return y}function d(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var m=0,x=0;f[g]===c;)m++,g++;for(var E=(f.length-g)*h+1>>>0,S=new Uint8Array(E);f[g];){var T=t[f.charCodeAt(g)];if(T===255)return;for(var I=0,R=E-1;(T!==0||I<x)&&R!==-1;R--,I++)T+=a*S[R]>>>0,S[R]=T%256>>>0,T=T/256>>>0;if(T!==0)throw new Error("Non-zero carry");x=I,g++}if(f[g]!==" "){for(var B=E-x;B!==E&&S[B]===0;)B++;for(var C=new Uint8Array(m+(E-B)),y=m;B!==E;)C[y++]=S[B++];return C}}}function p(f){var g=d(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:d,decode:p}}var Iw=Ew,xw=Iw;const Sh=s=>{if(s instanceof Uint8Array&&s.constructor.name==="Uint8Array")return s;if(s instanceof ArrayBuffer)return new Uint8Array(s);if(ArrayBuffer.isView(s))return new Uint8Array(s.buffer,s.byteOffset,s.byteLength);throw new Error("Unknown type, must be binary type")},Dw=s=>new TextEncoder().encode(s),Pw=s=>new TextDecoder().decode(s);class Sw{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class _w{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return _h(this,e)}}class $w{constructor(e){this.decoders=e}or(e){return _h(this,e)}decode(e){const t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const _h=(s,e)=>new $w({...s.decoders||{[s.prefix]:s},...e.decoders||{[e.prefix]:e}});class Aw{constructor(e,t,i,r){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=r,this.encoder=new Sw(e,t,i),this.decoder=new _w(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const rr=({name:s,prefix:e,encode:t,decode:i})=>new Aw(s,e,t,i),bi=({prefix:s,name:e,alphabet:t})=>{const{encode:i,decode:r}=xw(t,e);return rr({prefix:s,name:e,encode:i,decode:n=>Sh(r(n))})},Ow=(s,e,t,i)=>{const r={};for(let l=0;l<e.length;++l)r[e[l]]=l;let n=s.length;for(;s[n-1]==="=";)--n;const o=new Uint8Array(n*t/8|0);let a=0,c=0,h=0;for(let l=0;l<n;++l){const u=r[s[l]];if(u===void 0)throw new SyntaxError(`Non-${i} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Cw=(s,e,t)=>{const i=e[e.length-1]==="=",r=(1<<t)-1;let n="",o=0,a=0;for(let c=0;c<s.length;++c)for(a=a<<8|s[c],o+=8;o>t;)o-=t,n+=e[r&a>>o];if(o&&(n+=e[r&a<<t-o]),i)for(;n.length*t&7;)n+="=";return n},be=({name:s,prefix:e,bitsPerChar:t,alphabet:i})=>rr({prefix:e,name:s,encode(r){return Cw(r,i,t)},decode(r){return Ow(r,i,t,s)}}),Tw=rr({prefix:"\0",name:"identity",encode:s=>Pw(s),decode:s=>Dw(s)});var Rw=Object.freeze({__proto__:null,identity:Tw});const Nw=be({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Uw=Object.freeze({__proto__:null,base2:Nw});const kw=be({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Bw=Object.freeze({__proto__:null,base8:kw});const qw=bi({prefix:"9",name:"base10",alphabet:"0123456789"});var jw=Object.freeze({__proto__:null,base10:qw});const Lw=be({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Mw=be({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var zw=Object.freeze({__proto__:null,base16:Lw,base16upper:Mw});const Fw=be({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Hw=be({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Vw=be({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Kw=be({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Gw=be({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Ww=be({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Jw=be({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Yw=be({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Zw=be({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Qw=Object.freeze({__proto__:null,base32:Fw,base32upper:Hw,base32pad:Vw,base32padupper:Kw,base32hex:Gw,base32hexupper:Ww,base32hexpad:Jw,base32hexpadupper:Yw,base32z:Zw});const Xw=bi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),eb=bi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var tb=Object.freeze({__proto__:null,base36:Xw,base36upper:eb});const sb=bi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ib=bi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var rb=Object.freeze({__proto__:null,base58btc:sb,base58flickr:ib});const nb=be({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ob=be({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ab=be({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),cb=be({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var hb=Object.freeze({__proto__:null,base64:nb,base64pad:ob,base64url:ab,base64urlpad:cb});const $h=Array.from(""),lb=$h.reduce((s,e,t)=>(s[t]=e,s),[]),ub=$h.reduce((s,e,t)=>(s[e.codePointAt(0)]=t,s),[]);function db(s){return s.reduce((e,t)=>(e+=lb[t],e),"")}function fb(s){const e=[];for(const t of s){const i=ub[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const pb=rr({prefix:"",name:"base256emoji",encode:db,decode:fb});var gb=Object.freeze({__proto__:null,base256emoji:pb}),yb=Ah,oa=128,mb=-128,wb=Math.pow(2,31);function Ah(s,e,t){e=e||[],t=t||0;for(var i=t;s>=wb;)e[t++]=s&255|oa,s/=128;for(;s&mb;)e[t++]=s&255|oa,s>>>=7;return e[t]=s|0,Ah.bytes=t-i+1,e}var bb=rn,vb=128,aa=127;function rn(s,i){var t=0,i=i||0,r=0,n=i,o,a=s.length;do{if(n>=a)throw rn.bytes=0,new RangeError("Could not decode varint");o=s[n++],t+=r<28?(o&aa)<<r:(o&aa)*Math.pow(2,r),r+=7}while(o>=vb);return rn.bytes=n-i,t}var Eb=Math.pow(2,7),Ib=Math.pow(2,14),xb=Math.pow(2,21),Db=Math.pow(2,28),Pb=Math.pow(2,35),Sb=Math.pow(2,42),_b=Math.pow(2,49),$b=Math.pow(2,56),Ab=Math.pow(2,63),Ob=function(s){return s<Eb?1:s<Ib?2:s<xb?3:s<Db?4:s<Pb?5:s<Sb?6:s<_b?7:s<$b?8:s<Ab?9:10},Cb={encode:yb,decode:bb,encodingLength:Ob},Oh=Cb;const ca=(s,e,t=0)=>(Oh.encode(s,e,t),e),ha=s=>Oh.encodingLength(s),nn=(s,e)=>{const t=e.byteLength,i=ha(s),r=i+ha(t),n=new Uint8Array(r+t);return ca(s,n,0),ca(t,n,i),n.set(e,r),new Tb(s,t,e,n)};class Tb{constructor(e,t,i,r){this.code=e,this.size=t,this.digest=i,this.bytes=r}}const Ch=({name:s,code:e,encode:t})=>new Rb(s,e,t);class Rb{constructor(e,t,i){this.name=e,this.code=t,this.encode=i}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?nn(this.code,t):t.then(i=>nn(this.code,i))}else throw Error("Unknown type, must be binary type")}}const Th=s=>async e=>new Uint8Array(await crypto.subtle.digest(s,e)),Nb=Ch({name:"sha2-256",code:18,encode:Th("SHA-256")}),Ub=Ch({name:"sha2-512",code:19,encode:Th("SHA-512")});var kb=Object.freeze({__proto__:null,sha256:Nb,sha512:Ub});const Rh=0,Bb="identity",Nh=Sh,qb=s=>nn(Rh,Nh(s)),jb={code:Rh,name:Bb,encode:Nh,digest:qb};var Lb=Object.freeze({__proto__:null,identity:jb});new TextEncoder,new TextDecoder;const la={...Rw,...Uw,...Bw,...jw,...zw,...Qw,...tb,...rb,...hb,...gb};({...kb,...Lb});function Uh(s){return globalThis.Buffer!=null?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):s}function Mb(s=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?Uh(globalThis.Buffer.allocUnsafe(s)):new Uint8Array(s)}function kh(s,e,t,i){return{name:s,prefix:e,encoder:{name:s,prefix:e,encode:t},decoder:{decode:i}}}const ua=kh("utf8","u",s=>"u"+new TextDecoder("utf8").decode(s),s=>new TextEncoder().encode(s.substring(1))),Er=kh("ascii","a",s=>{let e="a";for(let t=0;t<s.length;t++)e+=String.fromCharCode(s[t]);return e},s=>{s=s.substring(1);const e=Mb(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}),zb={utf8:ua,"utf-8":ua,hex:la.base16,latin1:Er,ascii:Er,binary:Er,...la};function Fb(s,e="utf8"){const t=zb[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Uh(globalThis.Buffer.from(s,"utf-8")):t.decoder.decode(`${t.prefix}${s}`)}var Hb=Object.defineProperty,Vb=(s,e,t)=>e in s?Hb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,at=(s,e,t)=>Vb(s,typeof e!="symbol"?e+"":e,t);class Kb{constructor(e,t){this.core=e,this.logger=t,at(this,"keychain",new Map),at(this,"name",Vm),at(this,"version",Km),at(this,"initialized",!1),at(this,"storagePrefix",pt),at(this,"init",async()=>{if(!this.initialized){const i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}}),at(this,"has",i=>(this.isInitialized(),this.keychain.has(i))),at(this,"set",async(i,r)=>{this.isInitialized(),this.keychain.set(i,r),await this.persist()}),at(this,"get",i=>{this.isInitialized();const r=this.keychain.get(i);if(typeof r>"u"){const{message:n}=U("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(n)}return r}),at(this,"del",async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()}),this.core=e,this.logger=_e(t,this.name)}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,zr(e))}async getKeyChain(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Fr(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}}var Gb=Object.defineProperty,Wb=(s,e,t)=>e in s?Gb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ge=(s,e,t)=>Wb(s,typeof e!="symbol"?e+"":e,t);class Jb{constructor(e,t,i){this.core=e,this.logger=t,ge(this,"name",Fm),ge(this,"keychain"),ge(this,"randomSessionIdentifier",Xr()),ge(this,"initialized",!1),ge(this,"init",async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)}),ge(this,"hasKeys",r=>(this.isInitialized(),this.keychain.has(r))),ge(this,"getClientId",async()=>{this.isInitialized();const r=await this.getClientSeed(),n=Hn(r);return dl(n.publicKey)}),ge(this,"generateKeyPair",()=>{this.isInitialized();const r=Py();return this.setPrivateKey(r.publicKey,r.privateKey)}),ge(this,"signJWT",async r=>{this.isInitialized();const n=await this.getClientSeed(),o=Hn(n),a=this.randomSessionIdentifier;return await fl(a,r,Hm,o)}),ge(this,"generateSharedKey",(r,n,o)=>{this.isInitialized();const a=this.getPrivateKey(r),c=Sy(a,n);return this.setSymKey(c,o)}),ge(this,"setSymKey",async(r,n)=>{this.isInitialized();const o=n||Ri(r);return await this.keychain.set(o,r),o}),ge(this,"deleteKeyPair",async r=>{this.isInitialized(),await this.keychain.del(r)}),ge(this,"deleteSymKey",async r=>{this.isInitialized(),await this.keychain.del(r)}),ge(this,"encode",async(r,n,o)=>{this.isInitialized();const a=wh(o),c=ki(n);if(Ho(a))return Ay(c,o==null?void 0:o.encoding);if(Fo(a)){const d=a.senderPublicKey,p=a.receiverPublicKey;r=await this.generateSharedKey(d,p)}const h=this.getSymKey(r),{type:l,senderPublicKey:u}=a;return _y({type:l,symKey:h,message:c,senderPublicKey:u,encoding:o==null?void 0:o.encoding})}),ge(this,"decode",async(r,n,o)=>{this.isInitialized();const a=Cy(n,o);if(Ho(a)){const c=Oy(n,o==null?void 0:o.encoding);return Ur(c)}if(Fo(a)){const c=a.receiverPublicKey,h=a.senderPublicKey;r=await this.generateSharedKey(c,h)}try{const c=this.getSymKey(r),h=$y({symKey:c,encoded:n,encoding:o==null?void 0:o.encoding});return Ur(h)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}}),ge(this,"getPayloadType",(r,n=Te)=>{const o=li({encoded:r,encoding:n});return es(o.type)}),ge(this,"getPayloadSenderPublicKey",(r,n=Te)=>{const o=li({encoded:r,encoding:n});return o.senderPublicKey?Ne(o.senderPublicKey,Se):void 0}),this.core=e,this.logger=_e(t,this.name),this.keychain=i||new Kb(this.core,this.logger)}get context(){return Ue(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(ra)}catch{e=Xr(),await this.keychain.set(ra,e)}return Fb(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}}var Yb=Object.defineProperty,Zb=Object.defineProperties,Qb=Object.getOwnPropertyDescriptors,da=Object.getOwnPropertySymbols,Xb=Object.prototype.hasOwnProperty,e0=Object.prototype.propertyIsEnumerable,on=(s,e,t)=>e in s?Yb(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,t0=(s,e)=>{for(var t in e||(e={}))Xb.call(e,t)&&on(s,t,e[t]);if(da)for(var t of da(e))e0.call(e,t)&&on(s,t,e[t]);return s},s0=(s,e)=>Zb(s,Qb(e)),ke=(s,e,t)=>on(s,typeof e!="symbol"?e+"":e,t);class i0 extends ql{constructor(e,t){super(e,t),this.logger=e,this.core=t,ke(this,"messages",new Map),ke(this,"messagesWithoutClientAck",new Map),ke(this,"name",Gm),ke(this,"version",Wm),ke(this,"initialized",!1),ke(this,"storagePrefix",pt),ke(this,"init",async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i);const r=await this.getRelayerMessagesWithoutClientAck();typeof r<"u"&&(this.messagesWithoutClientAck=r),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}}),ke(this,"set",async(i,r,n)=>{this.isInitialized();const o=Ke(r);let a=this.messages.get(i);if(typeof a>"u"&&(a={}),typeof a[o]<"u")return o;if(a[o]=r,this.messages.set(i,a),n===Ni.inbound){const c=this.messagesWithoutClientAck.get(i)||{};this.messagesWithoutClientAck.set(i,s0(t0({},c),{[o]:r}))}return await this.persist(),o}),ke(this,"get",i=>{this.isInitialized();let r=this.messages.get(i);return typeof r>"u"&&(r={}),r}),ke(this,"getWithoutAck",i=>{this.isInitialized();const r={};for(const n of i){const o=this.messagesWithoutClientAck.get(n)||{};r[n]=Object.values(o)}return r}),ke(this,"has",(i,r)=>{this.isInitialized();const n=this.get(i),o=Ke(r);return typeof n[o]<"u"}),ke(this,"ack",async(i,r)=>{this.isInitialized();const n=this.messagesWithoutClientAck.get(i);if(typeof n>"u")return;const o=Ke(r);delete n[o],Object.keys(n).length===0?this.messagesWithoutClientAck.delete(i):this.messagesWithoutClientAck.set(i,n),await this.persist()}),ke(this,"del",async i=>{this.isInitialized(),this.messages.delete(i),this.messagesWithoutClientAck.delete(i),await this.persist()}),this.logger=_e(e,this.name),this.core=t}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get storageKeyWithoutClientAck(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name+"_withoutClientAck"}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,zr(e))}async setRelayerMessagesWithoutClientAck(e){await this.core.storage.setItem(this.storageKeyWithoutClientAck,zr(e))}async getRelayerMessages(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Fr(e):void 0}async getRelayerMessagesWithoutClientAck(){const e=await this.core.storage.getItem(this.storageKeyWithoutClientAck);return typeof e<"u"?Fr(e):void 0}async persist(){await this.setRelayerMessages(this.messages),await this.setRelayerMessagesWithoutClientAck(this.messagesWithoutClientAck)}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}}var r0=Object.defineProperty,n0=Object.defineProperties,o0=Object.getOwnPropertyDescriptors,fa=Object.getOwnPropertySymbols,a0=Object.prototype.hasOwnProperty,c0=Object.prototype.propertyIsEnumerable,an=(s,e,t)=>e in s?r0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,cs=(s,e)=>{for(var t in e||(e={}))a0.call(e,t)&&an(s,t,e[t]);if(fa)for(var t of fa(e))c0.call(e,t)&&an(s,t,e[t]);return s},pa=(s,e)=>n0(s,o0(e)),Fe=(s,e,t)=>an(s,typeof e!="symbol"?e+"":e,t);class h0 extends jl{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,Fe(this,"events",new gt.EventEmitter),Fe(this,"name",Ym),Fe(this,"queue",new Map),Fe(this,"publishTimeout",k.toMiliseconds(k.ONE_MINUTE)),Fe(this,"initialPublishTimeout",k.toMiliseconds(k.ONE_SECOND*15)),Fe(this,"needsTransportRestart",!1),Fe(this,"publish",async(i,r,n)=>{var o,a,c,h,l;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:r,opts:n}});const u=(n==null?void 0:n.ttl)||Jm,d=(n==null?void 0:n.prompt)||!1,p=(n==null?void 0:n.tag)||0,f=(n==null?void 0:n.id)||qt().toString(),g=Es(Vi().protocol),m={id:f,method:(n==null?void 0:n.publishMethod)||g.publish,params:cs({topic:i,message:r,ttl:u,prompt:d,tag:p,attestation:n==null?void 0:n.attestation},(n==null?void 0:n.tvf)&&{tvf:n.tvf})},x=`Failed to publish payload, please try again. id:${f} tag:${p}`;try{de((o=m.params)==null?void 0:o.prompt)&&((a=m.params)==null||delete a.prompt),de((c=m.params)==null?void 0:c.tag)&&((h=m.params)==null||delete h.tag);const E=new Promise(async S=>{const T=({id:R})=>{var B;((B=m.id)==null?void 0:B.toString())===R.toString()&&(this.removeRequestFromQueue(R),this.relayer.events.removeListener(oe.publish,T),S())};this.relayer.events.on(oe.publish,T);const I=ut(new Promise((R,B)=>{this.rpcPublish(m,n).then(R).catch(C=>{this.logger.warn(C,C==null?void 0:C.message),B(C)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${f} tag:${p}`);try{await I,this.events.removeListener(oe.publish,T)}catch(R){this.queue.set(f,{request:m,opts:n,attempt:1}),this.logger.warn(R,R==null?void 0:R.message)}});this.logger.trace({type:"method",method:"publish",params:{id:f,topic:i,message:r,opts:n}}),await ut(E,this.publishTimeout,x)}catch(E){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(E),(l=n==null?void 0:n.internal)!=null&&l.throwOnFailedPublish)throw E}finally{this.queue.delete(f)}}),Fe(this,"publishCustom",async i=>{var r,n,o,a,c;this.logger.debug("Publishing custom payload"),this.logger.trace({type:"method",method:"publishCustom",params:i});const{payload:h,opts:l={}}=i,{attestation:u,tvf:d,publishMethod:p,prompt:f,tag:g,ttl:m=k.FIVE_MINUTES}=l,x=l.id||qt().toString(),E=Es(Vi().protocol),S=p||E.publish,T={id:x,method:S,params:cs(pa(cs({},h),{ttl:m,prompt:f,tag:g,attestation:u}),d)},I=`Failed to publish custom payload, please try again. id:${x} tag:${g}`;try{de((r=T.params)==null?void 0:r.prompt)&&((n=T.params)==null||delete n.prompt),de((o=T.params)==null?void 0:o.tag)&&((a=T.params)==null||delete a.tag);const R=new Promise(async B=>{const C=({id:v})=>{var w;((w=T.id)==null?void 0:w.toString())===v.toString()&&(this.removeRequestFromQueue(v),this.relayer.events.removeListener(oe.publish,C),B())};this.relayer.events.on(oe.publish,C);const y=ut(new Promise((v,w)=>{this.rpcPublish(T,l).then(v).catch(b=>{this.logger.warn(b,b==null?void 0:b.message),w(b)})}),this.initialPublishTimeout,`Failed initial custom payload publish, retrying.... method:${S} id:${x} tag:${g}`);try{await y,this.events.removeListener(oe.publish,C)}catch(v){this.queue.set(x,{request:T,opts:l,attempt:1}),this.logger.warn(v,v==null?void 0:v.message)}});this.logger.trace({type:"method",method:"publish",params:{id:x,payload:h,opts:l}}),await ut(R,this.publishTimeout,I)}catch(R){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(R),(c=l==null?void 0:l.internal)!=null&&c.throwOnFailedPublish)throw R}finally{this.queue.delete(x)}}),Fe(this,"on",(i,r)=>{this.events.on(i,r)}),Fe(this,"once",(i,r)=>{this.events.once(i,r)}),Fe(this,"off",(i,r)=>{this.events.off(i,r)}),Fe(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.relayer=e,this.logger=_e(t,this.name),this.registerEventListeners()}get context(){return Ue(this.logger)}async rpcPublish(e,t){this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:e});const i=await this.relayer.request(e);return this.relayer.events.emit(oe.publish,cs(cs({},e),t)),this.logger.debug("Successfully Published Payload"),i}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async(e,t)=>{var i;const r=e.attempt+1;this.queue.set(t,pa(cs({},e),{attempt:r})),this.logger.warn({},`Publisher: queue->publishing: ${e.request.id}, tag: ${(i=e.request.params)==null?void 0:i.tag}, attempt: ${r}`),await this.rpcPublish(e.request,e.opts),this.logger.warn({},`Publisher: queue->published: ${e.request.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(ss.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(oe.connection_stalled);return}this.checkQueue()}),this.relayer.on(oe.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}}var l0=Object.defineProperty,u0=(s,e,t)=>e in s?l0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,hs=(s,e,t)=>u0(s,typeof e!="symbol"?e+"":e,t);class d0{constructor(){hs(this,"map",new Map),hs(this,"set",(e,t)=>{const i=this.get(e);this.exists(e,t)||this.map.set(e,[...i,t])}),hs(this,"get",e=>this.map.get(e)||[]),hs(this,"exists",(e,t)=>this.get(e).includes(t)),hs(this,"delete",(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const i=this.get(e);if(!this.exists(e,t))return;const r=i.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)}),hs(this,"clear",()=>{this.map.clear()})}get topics(){return Array.from(this.map.keys())}}var f0=Object.defineProperty,p0=Object.defineProperties,g0=Object.getOwnPropertyDescriptors,ga=Object.getOwnPropertySymbols,y0=Object.prototype.hasOwnProperty,m0=Object.prototype.propertyIsEnumerable,cn=(s,e,t)=>e in s?f0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Vs=(s,e)=>{for(var t in e||(e={}))y0.call(e,t)&&cn(s,t,e[t]);if(ga)for(var t of ga(e))m0.call(e,t)&&cn(s,t,e[t]);return s},Ir=(s,e)=>p0(s,g0(e)),ee=(s,e,t)=>cn(s,typeof e!="symbol"?e+"":e,t);class w0 extends zl{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,ee(this,"subscriptions",new Map),ee(this,"topicMap",new d0),ee(this,"events",new gt.EventEmitter),ee(this,"name",iw),ee(this,"version",rw),ee(this,"pending",new Map),ee(this,"cached",[]),ee(this,"initialized",!1),ee(this,"storagePrefix",pt),ee(this,"subscribeTimeout",k.toMiliseconds(k.ONE_MINUTE)),ee(this,"initialSubscribeTimeout",k.toMiliseconds(k.ONE_SECOND*15)),ee(this,"clientId"),ee(this,"batchSubscribeTopicsLimit",500),ee(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),await this.restore()),this.initialized=!0}),ee(this,"subscribe",async(i,r)=>{var n;this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}});try{const o=Vi(r),a={topic:i,relay:o,transportType:r==null?void 0:r.transportType};(n=r==null?void 0:r.internal)!=null&&n.skipSubscribe||this.pending.set(i,a);const c=await this.rpcSubscribe(i,o,r);return typeof c=="string"&&(this.onSubscribe(c,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}})),c}catch(o){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(o),o}}),ee(this,"unsubscribe",async(i,r)=>{this.isInitialized(),typeof(r==null?void 0:r.id)<"u"?await this.unsubscribeById(i,r.id,r):await this.unsubscribeByTopic(i,r)}),ee(this,"isSubscribed",i=>new Promise(r=>{r(this.topicMap.topics.includes(i))})),ee(this,"isKnownTopic",i=>new Promise(r=>{r(this.topicMap.topics.includes(i)||this.pending.has(i)||this.cached.some(n=>n.topic===i))})),ee(this,"on",(i,r)=>{this.events.on(i,r)}),ee(this,"once",(i,r)=>{this.events.once(i,r)}),ee(this,"off",(i,r)=>{this.events.off(i,r)}),ee(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),ee(this,"start",async()=>{await this.onConnect()}),ee(this,"stop",async()=>{await this.onDisconnect()}),ee(this,"restart",async()=>{await this.restore(),await this.onRestart()}),ee(this,"checkPending",async()=>{if(this.pending.size===0&&(!this.initialized||!this.relayer.connected))return;const i=[];this.pending.forEach(r=>{i.push(r)}),await this.batchSubscribe(i)}),ee(this,"registerEventListeners",()=>{this.relayer.core.heartbeat.on(ss.pulse,async()=>{await this.checkPending()}),this.events.on(Be.created,async i=>{const r=Be.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()}),this.events.on(Be.deleted,async i=>{const r=Be.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()})}),this.relayer=e,this.logger=_e(t,this.name),this.clientId=""}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}get hasAnyTopics(){return this.topicMap.topics.length>0||this.pending.size>0||this.cached.length>0||this.subscriptions.size>0}hasSubscription(e,t){let i=!1;try{i=this.getSubscription(e).topic===t}catch{}return i}reset(){this.cached=[],this.initialized=!0}onDisable(){this.values.length>0&&(this.cached=this.values),this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){const i=this.topicMap.get(e);await Promise.all(i.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}});try{const r=Vi(i);await this.restartToComplete({topic:e,id:t,relay:r}),await this.rpcUnsubscribe(e,t,r);const n=ie("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t,i){var r,n;const o=await this.getSubscriptionId(e);if((r=i==null?void 0:i.internal)!=null&&r.skipSubscribe)return o;(!i||(i==null?void 0:i.transportType)===se.relay)&&await this.restartToComplete({topic:e,id:e,relay:t});const a={method:Es(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:a});const c=(n=i==null?void 0:i.internal)==null?void 0:n.throwOnFailedPublish;try{if((i==null?void 0:i.transportType)===se.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(a).catch(u=>this.logger.warn(u))},k.toMiliseconds(k.ONE_SECOND)),o;const h=new Promise(async u=>{const d=p=>{p.topic===e&&(this.events.removeListener(Be.created,d),u(p.id))};this.events.on(Be.created,d);try{const p=await ut(new Promise((f,g)=>{this.relayer.request(a).catch(m=>{this.logger.warn(m,m==null?void 0:m.message),g(m)}).then(f)}),this.initialSubscribeTimeout,`Subscribing to ${e} failed, please try again`);this.events.removeListener(Be.created,d),u(p)}catch{}}),l=await ut(h,this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!l&&c)throw new Error(`Subscribing to ${e} failed, please try again`);return l?o:null}catch(h){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(oe.connection_stalled),c)throw h}return null}async rpcBatchSubscribe(e){if(!e.length)return;const t=e[0].relay,i={method:Es(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await ut(new Promise(r=>{this.relayer.request(i).catch(n=>this.logger.warn(n)).then(r)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit(oe.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;const t=e[0].relay,i={method:Es(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});let r;try{r=await await ut(new Promise((n,o)=>{this.relayer.request(i).catch(a=>{this.logger.warn(a),o(a)}).then(n)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit(oe.connection_stalled)}return r}rpcUnsubscribe(e,t,i){const r={method:Es(i.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,Ir(Vs({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,Vs({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,i){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,Vs({},t)),this.topicMap.set(t.topic,e),this.events.emit(Be.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const t=this.subscriptions.get(e);if(!t){const{message:i}=U("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});const i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(Be.deleted,Ir(Vs({},i),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(Be.sync)}async onRestart(){if(this.cached.length){const e=[...this.cached],t=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let i=0;i<t;i++){const r=e.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(r)}}this.events.emit(Be.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size&&!e.every(t=>{var i;return t.topic===((i=this.subscriptions.get(t.id))==null?void 0:i.topic)})){const{message:t}=U("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){e.length&&(await this.rpcBatchSubscribe(e),this.onBatchSubscribe(await Promise.all(e.map(async t=>Ir(Vs({},t),{id:await this.getSubscriptionId(t.topic)})))))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);const t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(await Gf(k.toMiliseconds(k.ONE_SECOND)),await this.relayer.handleBatchMessageEvents(t.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(e){!this.relayer.connected&&!this.relayer.connecting&&(this.cached.push(e),await this.relayer.transportOpen())}async getClientId(){return this.clientId||(this.clientId=await this.relayer.core.crypto.getClientId()),this.clientId}async getSubscriptionId(e){return Ke(e+await this.getClientId())}}var b0=Object.defineProperty,ya=Object.getOwnPropertySymbols,v0=Object.prototype.hasOwnProperty,E0=Object.prototype.propertyIsEnumerable,hn=(s,e,t)=>e in s?b0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ma=(s,e)=>{for(var t in e||(e={}))v0.call(e,t)&&hn(s,t,e[t]);if(ya)for(var t of ya(e))E0.call(e,t)&&hn(s,t,e[t]);return s},J=(s,e,t)=>hn(s,typeof e!="symbol"?e+"":e,t);class I0 extends Ll{constructor(e){super(e),J(this,"protocol","wc"),J(this,"version",2),J(this,"core"),J(this,"logger"),J(this,"events",new gt.EventEmitter),J(this,"provider"),J(this,"messages"),J(this,"subscriber"),J(this,"publisher"),J(this,"name",Qm),J(this,"transportExplicitlyClosed",!1),J(this,"initialized",!1),J(this,"connectionAttemptInProgress",!1),J(this,"relayUrl"),J(this,"projectId"),J(this,"packageName"),J(this,"bundleId"),J(this,"hasExperiencedNetworkDisruption",!1),J(this,"pingTimeout"),J(this,"heartBeatTimeout",k.toMiliseconds(k.THIRTY_SECONDS+k.FIVE_SECONDS)),J(this,"reconnectTimeout"),J(this,"connectPromise"),J(this,"reconnectInProgress",!1),J(this,"requestsInFlight",[]),J(this,"connectTimeout",k.toMiliseconds(k.ONE_SECOND*15)),J(this,"request",async t=>{var i,r;this.logger.debug("Publishing Request Payload");const n=t.id||qt().toString();await this.toEstablishConnection();try{this.logger.trace({id:n,method:t.method,topic:(i=t.params)==null?void 0:i.topic},"relayer.request - publishing...");const o=`${n}:${((r=t.params)==null?void 0:r.tag)||""}`;this.requestsInFlight.push(o);const a=await this.provider.request(t);return this.requestsInFlight=this.requestsInFlight.filter(c=>c!==o),a}catch(o){throw this.logger.debug(`Failed to Publish Request: ${n}`),o}}),J(this,"resetPingTimeout",()=>{Mi()&&(clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var t,i,r,n;try{this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),(n=(r=(i=(t=this.provider)==null?void 0:t.connection)==null?void 0:i.socket)==null?void 0:r.terminate)==null||n.call(r)}catch(o){this.logger.warn(o,o==null?void 0:o.message)}},this.heartBeatTimeout))}),J(this,"onPayloadHandler",t=>{this.onProviderPayload(t),this.resetPingTimeout()}),J(this,"onConnectHandler",()=>{this.logger.warn({},"Relayer connected "),this.startPingTimeout(),this.events.emit(oe.connect)}),J(this,"onDisconnectHandler",()=>{this.logger.warn({},"Relayer disconnected "),this.requestsInFlight=[],this.onProviderDisconnect()}),J(this,"onProviderErrorHandler",t=>{this.logger.fatal(`Fatal socket error: ${t.message}`),this.events.emit(oe.error,t),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()}),J(this,"registerProviderListeners",()=>{this.provider.on(ze.payload,this.onPayloadHandler),this.provider.on(ze.connect,this.onConnectHandler),this.provider.on(ze.disconnect,this.onDisconnectHandler),this.provider.on(ze.error,this.onProviderErrorHandler)}),this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?_e(e.logger,this.name):ui(Wi({level:e.logger||Zm})),this.messages=new i0(this.logger,e.core),this.subscriber=new w0(this,this.logger),this.publisher=new h0(this,this.logger),this.projectId=e==null?void 0:e.projectId,this.relayUrl=(e==null?void 0:e.relayUrl)||Dh,Cf()?this.packageName=lo():Tf()&&(this.bundleId=lo()),this.provider={}}async init(){this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.transportOpen().catch(e=>this.logger.warn(e,e==null?void 0:e.message))}get context(){return Ue(this.logger)}get connected(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===1||!1}get connecting(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===0||this.connectPromise!==void 0||!1}async publish(e,t,i){this.isInitialized(),await this.publisher.publish(e,t,i),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:se.relay},Ni.outbound)}async publishCustom(e){this.isInitialized(),await this.publisher.publishCustom(e)}async subscribe(e,t){var i,r,n;this.isInitialized(),(!(t!=null&&t.transportType)||(t==null?void 0:t.transportType)==="relay")&&await this.toEstablishConnection();const o=typeof((i=t==null?void 0:t.internal)==null?void 0:i.throwOnFailedPublish)>"u"?!0:(r=t==null?void 0:t.internal)==null?void 0:r.throwOnFailedPublish;let a=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c;const h=l=>{l.topic===e&&(this.subscriber.off(Be.created,h),c())};return await Promise.all([new Promise(l=>{c=l,this.subscriber.on(Be.created,h)}),new Promise(async(l,u)=>{a=await this.subscriber.subscribe(e,ma({internal:{throwOnFailedPublish:o}},t)).catch(d=>{o&&u(d)})||a,l()})]),a}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await ut(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){if(!this.subscriber.hasAnyTopics){this.logger.info("Starting WS connection skipped because the client has no topics to work with.");return}if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(t,i)=>{await this.connect(e).then(t).catch(i).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw new Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(e){this.logger.debug({},"Restarting transport..."),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await ta())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if((e==null?void 0:e.length)===0){this.logger.trace("Batch message events is empty. Ignoring...");return}const t=e.sort((i,r)=>i.publishedAt-r.publishedAt);this.logger.debug(`Batch of ${t.length} message events sorted`);for(const i of t)try{await this.onMessageEvent(i)}catch(r){this.logger.warn(r,"Error while processing batch message event: "+(r==null?void 0:r.message))}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){const{topic:i}=e;if(!t.sessionExists){const r=he(k.FIVE_MINUTES),n={topic:i,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(i,n)}this.events.emit(oe.message,e),await this.recordMessageEvent(e,Ni.inbound)}async connect(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let t=1;for(;t<6;){try{if(this.transportExplicitlyClosed)break;this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${t}...`),await this.createProvider(),await new Promise(async(i,r)=>{const n=()=>{r(new Error("Connection interrupted while trying to connect"))};this.provider.once(ze.disconnect,n),await ut(new Promise((o,a)=>{this.provider.connect().then(o).catch(a)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(o=>{r(o)}).finally(()=>{this.provider.off(ze.disconnect,n),clearTimeout(this.reconnectTimeout)}),await new Promise(async(o,a)=>{const c=()=>{r(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(ze.disconnect,c),await this.subscriber.start().then(o).catch(a).finally(()=>{this.provider.off(ze.disconnect,c)})}),this.hasExperiencedNetworkDisruption=!1,i()})}catch(i){await this.subscriber.stop();const r=i;this.logger.warn({},r.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${t}`);break}await new Promise(i=>setTimeout(i,k.toMiliseconds(t*1))),t++}}startPingTimeout(){var e,t,i,r,n;if(Mi())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(r=(i=this.provider)==null?void 0:i.connection)==null?void 0:r.socket)==null||n.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(o){this.logger.warn(o,o==null?void 0:o.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Ze(new jm(Bf({sdkVersion:sn,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(e,t){const{topic:i,message:r}=e;await this.messages.set(i,r,t)}async shouldIgnoreMessageEvent(e){const{topic:t,message:i}=e;if(!i||i.length===0)return this.logger.warn(`Ignoring invalid/empty message: ${i}`),!0;if(!await this.subscriber.isKnownTopic(t))return this.logger.warn(`Ignoring message for unknown topic ${t}`),!0;const r=this.messages.has(t,i);return r&&this.logger.warn(`Ignoring duplicate message: ${i}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),wn(e)){if(!e.method.endsWith(Xm))return;const t=e.params,{topic:i,message:r,publishedAt:n,attestation:o}=t.data,a={topic:i,message:r,publishedAt:n,transportType:se.relay,attestation:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(ma({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else Gi(e)&&this.events.emit(oe.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(await this.recordMessageEvent(e,Ni.inbound),this.events.emit(oe.message,e))}async acknowledgePayload(e){const t=ri(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(ze.payload,this.onPayloadHandler),this.provider.off(ze.connect,this.onConnectHandler),this.provider.off(ze.disconnect,this.onDisconnectHandler),this.provider.off(ze.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await ta();Dm(async t=>{e!==t&&(e=t,t?await this.transportOpen().catch(i=>this.logger.error(i,i==null?void 0:i.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))}),this.core.heartbeat.on(ss.pulse,async()=>{if(!this.transportExplicitlyClosed&&!this.connected&&_m())try{await this.confirmOnlineStateOrThrow(),await this.transportOpen()}catch(t){this.logger.warn(t,t==null?void 0:t.message)}})}async onProviderDisconnect(){clearTimeout(this.pingTimeout),this.events.emit(oe.disconnect),this.connectionAttemptInProgress=!1,!this.reconnectInProgress&&(this.reconnectInProgress=!0,await this.subscriber.stop(),this.subscriber.hasAnyTopics&&(this.transportExplicitlyClosed||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e,e==null?void 0:e.message)),this.reconnectTimeout=void 0,this.reconnectInProgress=!1},k.toMiliseconds(ew)))))}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectPromise){await this.connectPromise;return}await this.connect()}}}function x0(s,e){return s===e||Number.isNaN(s)&&Number.isNaN(e)}function wa(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function ba(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}const D0="[object RegExp]",P0="[object String]",S0="[object Number]",_0="[object Boolean]",va="[object Arguments]",$0="[object Symbol]",A0="[object Date]",O0="[object Map]",C0="[object Set]",T0="[object Array]",R0="[object Function]",N0="[object ArrayBuffer]",xr="[object Object]",U0="[object Error]",k0="[object DataView]",B0="[object Uint8Array]",q0="[object Uint8ClampedArray]",j0="[object Uint16Array]",L0="[object Uint32Array]",M0="[object BigUint64Array]",z0="[object Int8Array]",F0="[object Int16Array]",H0="[object Int32Array]",V0="[object BigInt64Array]",K0="[object Float32Array]",G0="[object Float64Array]";function W0(){}function Ea(s){if(!s||typeof s!="object")return!1;const e=Object.getPrototypeOf(s);return e===null||e===Object.prototype||Object.getPrototypeOf(e)===null?Object.prototype.toString.call(s)==="[object Object]":!1}function J0(s,e,t){return Js(s,e,void 0,void 0,void 0,void 0,t)}function Js(s,e,t,i,r,n,o){const a=o(s,e,t,i,r,n);if(a!==void 0)return a;if(typeof s==typeof e)switch(typeof s){case"bigint":case"string":case"boolean":case"symbol":case"undefined":return s===e;case"number":return s===e||Object.is(s,e);case"function":return s===e;case"object":return ii(s,e,n,o)}return ii(s,e,n,o)}function ii(s,e,t,i){if(Object.is(s,e))return!0;let r=ba(s),n=ba(e);if(r===va&&(r=xr),n===va&&(n=xr),r!==n)return!1;switch(r){case P0:return s.toString()===e.toString();case S0:{const c=s.valueOf(),h=e.valueOf();return x0(c,h)}case _0:case A0:case $0:return Object.is(s.valueOf(),e.valueOf());case D0:return s.source===e.source&&s.flags===e.flags;case R0:return s===e}t=t??new Map;const o=t.get(s),a=t.get(e);if(o!=null&&a!=null)return o===e;t.set(s,e),t.set(e,s);try{switch(r){case O0:{if(s.size!==e.size)return!1;for(const[c,h]of s.entries())if(!e.has(c)||!Js(h,e.get(c),c,s,e,t,i))return!1;return!0}case C0:{if(s.size!==e.size)return!1;const c=Array.from(s.values()),h=Array.from(e.values());for(let l=0;l<c.length;l++){const u=c[l],d=h.findIndex(p=>Js(u,p,void 0,s,e,t,i));if(d===-1)return!1;h.splice(d,1)}return!0}case T0:case B0:case q0:case j0:case L0:case M0:case z0:case F0:case H0:case V0:case K0:case G0:{if(typeof Buffer<"u"&&Buffer.isBuffer(s)!==Buffer.isBuffer(e)||s.length!==e.length)return!1;for(let c=0;c<s.length;c++)if(!Js(s[c],e[c],c,s,e,t,i))return!1;return!0}case N0:return s.byteLength!==e.byteLength?!1:ii(new Uint8Array(s),new Uint8Array(e),t,i);case k0:return s.byteLength!==e.byteLength||s.byteOffset!==e.byteOffset?!1:ii(new Uint8Array(s),new Uint8Array(e),t,i);case U0:return s.name===e.name&&s.message===e.message;case xr:{if(!(ii(s.constructor,e.constructor,t,i)||Ea(s)&&Ea(e)))return!1;const c=[...Object.keys(s),...wa(s)],h=[...Object.keys(e),...wa(e)];if(c.length!==h.length)return!1;for(let l=0;l<c.length;l++){const u=c[l],d=s[u];if(!Object.hasOwn(e,u))return!1;const p=e[u];if(!Js(d,p,u,s,e,t,i))return!1}return!0}default:return!1}}finally{t.delete(s),t.delete(e)}}function Y0(s,e){return J0(s,e,W0)}var Z0=Object.defineProperty,Ia=Object.getOwnPropertySymbols,Q0=Object.prototype.hasOwnProperty,X0=Object.prototype.propertyIsEnumerable,ln=(s,e,t)=>e in s?Z0(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xa=(s,e)=>{for(var t in e||(e={}))Q0.call(e,t)&&ln(s,t,e[t]);if(Ia)for(var t of Ia(e))X0.call(e,t)&&ln(s,t,e[t]);return s},$e=(s,e,t)=>ln(s,typeof e!="symbol"?e+"":e,t);class is extends Ml{constructor(e,t,i,r=pt,n=void 0){super(e,t,i,r),this.core=e,this.logger=t,this.name=i,$e(this,"map",new Map),$e(this,"version",tw),$e(this,"cached",[]),$e(this,"initialized",!1),$e(this,"getKey"),$e(this,"storagePrefix",pt),$e(this,"recentlyDeleted",[]),$e(this,"recentlyDeletedLimit",200),$e(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(o=>{this.getKey&&o!==null&&!de(o)?this.map.set(this.getKey(o),o):tm(o)?this.map.set(o.id,o):sm(o)&&this.map.set(o.topic,o)}),this.cached=[],this.initialized=!0)}),$e(this,"set",async(o,a)=>{this.isInitialized(),this.map.has(o)?await this.update(o,a):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:o,value:a}),this.map.set(o,a),await this.persist())}),$e(this,"get",o=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:o}),this.getData(o))),$e(this,"getAll",o=>(this.isInitialized(),o?this.values.filter(a=>Object.keys(o).every(c=>Y0(a[c],o[c]))):this.values)),$e(this,"update",async(o,a)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:o,update:a});const c=xa(xa({},this.getData(o)),a);this.map.set(o,c),await this.persist()}),$e(this,"delete",async(o,a)=>{this.isInitialized(),this.map.has(o)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:o,reason:a}),this.map.delete(o),this.addToRecentlyDeleted(o),await this.persist())}),this.logger=_e(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){const{message:r}=U("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}const{message:i}=U("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:t}=U("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}}var ev=Object.defineProperty,tv=(s,e,t)=>e in s?ev(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,K=(s,e,t)=>tv(s,typeof e!="symbol"?e+"":e,t);class sv{constructor(e,t){this.core=e,this.logger=t,K(this,"name",nw),K(this,"version",ow),K(this,"events",new bn),K(this,"pairings"),K(this,"initialized",!1),K(this,"storagePrefix",pt),K(this,"ignoredPayloadTypes",[xt]),K(this,"registeredMethods",[]),K(this,"init",async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))}),K(this,"register",({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]}),K(this,"create",async i=>{this.isInitialized();const r=Xr(),n=await this.core.crypto.setSymKey(r),o=he(k.FIVE_MINUTES),a={protocol:xh},c={topic:n,expiry:o,relay:a,active:!1,methods:i==null?void 0:i.methods},h=Ko({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:a,expiryTimestamp:o,methods:i==null?void 0:i.methods});return this.events.emit(Kt.create,c),this.core.expirer.set(n,o),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:i==null?void 0:i.transportType,internal:i==null?void 0:i.internal}),{topic:n,uri:h}}),K(this,"pair",async i=>{this.isInitialized();const r=this.core.eventClient.createEvent({properties:{topic:i==null?void 0:i.uri,trace:[ht.pairing_started]}});this.isValidPair(i,r);const{topic:n,symKey:o,relay:a,expiryTimestamp:c,methods:h}=Vo(i.uri);r.props.properties.topic=n,r.addTrace(ht.pairing_uri_validation_success),r.addTrace(ht.pairing_uri_not_expired);let l;if(this.pairings.keys.includes(n)){if(l=this.pairings.get(n),r.addTrace(ht.existing_pairing),l.active)throw r.setError(Et.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(ht.pairing_not_expired)}const u=c||he(k.FIVE_MINUTES),d={topic:n,relay:a,expiry:u,active:!1,methods:h};this.core.expirer.set(n,u),await this.pairings.set(n,d),r.addTrace(ht.store_new_pairing),i.activatePairing&&await this.activate({topic:n}),this.events.emit(Kt.create,d),r.addTrace(ht.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(o,n),r.addTrace(ht.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(Et.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:a})}catch(p){throw r.setError(Et.subscribe_pairing_topic_failure),p}return r.addTrace(ht.subscribe_pairing_topic_success),d}),K(this,"activate",async({topic:i})=>{this.isInitialized();const r=he(k.FIVE_MINUTES);this.core.expirer.set(i,r),await this.pairings.update(i,{active:!0,expiry:r})}),K(this,"ping",async i=>{this.isInitialized(),await this.isValidPing(i),this.logger.warn("ping() is deprecated and will be removed in the next major release.");const{topic:r}=i;if(this.pairings.keys.includes(r)){const n=await this.sendRequest(r,"wc_pairingPing",{}),{done:o,resolve:a,reject:c}=Vt();this.events.once(Z("pairing_ping",n),({error:h})=>{h?c(h):a()}),await o()}}),K(this,"updateExpiry",async({topic:i,expiry:r})=>{this.isInitialized(),await this.pairings.update(i,{expiry:r})}),K(this,"updateMetadata",async({topic:i,metadata:r})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:r})}),K(this,"getPairings",()=>(this.isInitialized(),this.pairings.values)),K(this,"disconnect",async i=>{this.isInitialized(),await this.isValidDisconnect(i);const{topic:r}=i;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",ie("USER_DISCONNECTED")),await this.deletePairing(r))}),K(this,"formatUriFromPairing",i=>{this.isInitialized();const{topic:r,relay:n,expiry:o,methods:a}=i,c=this.core.crypto.keychain.get(r);return Ko({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:o,methods:a})}),K(this,"sendRequest",async(i,r,n)=>{const o=it(r,n),a=await this.core.crypto.encode(i,o),c=zs[r].req;return this.core.history.set(i,o),this.core.relayer.publish(i,a,c),o.id}),K(this,"sendResult",async(i,r,n)=>{const o=ri(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,h=zs[c].res;await this.core.relayer.publish(r,a,h),await this.core.history.resolve(o)}),K(this,"sendError",async(i,r,n)=>{const o=mn(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,h=zs[c]?zs[c].res:zs.unregistered_method.res;await this.core.relayer.publish(r,a,h),await this.core.history.resolve(o)}),K(this,"deletePairing",async(i,r)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,ie("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),r?Promise.resolve():this.core.expirer.del(i)])}),K(this,"cleanup",async()=>{const i=this.pairings.getAll().filter(r=>lt(r.expiry));await Promise.all(i.map(r=>this.deletePairing(r.topic)))}),K(this,"onRelayEventRequest",async i=>{const{topic:r,payload:n}=i;switch(n.method){case"wc_pairingPing":return await this.onPairingPingRequest(r,n);case"wc_pairingDelete":return await this.onPairingDeleteRequest(r,n);default:return await this.onUnknownRpcMethodRequest(r,n)}}),K(this,"onRelayEventResponse",async i=>{const{topic:r,payload:n}=i,o=(await this.core.history.get(r,n.id)).request.method;switch(o){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(o)}}),K(this,"onPairingPingRequest",async(i,r)=>{const{id:n}=r;try{this.isValidPing({topic:i}),await this.sendResult(n,i,!0),this.events.emit(Kt.ping,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),K(this,"onPairingPingResponse",(i,r)=>{const{id:n}=r;setTimeout(()=>{bt(r)?this.events.emit(Z("pairing_ping",n),{}):st(r)&&this.events.emit(Z("pairing_ping",n),{error:r.error})},500)}),K(this,"onPairingDeleteRequest",async(i,r)=>{const{id:n}=r;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit(Kt.delete,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),K(this,"onUnknownRpcMethodRequest",async(i,r)=>{const{id:n,method:o}=r;try{if(this.registeredMethods.includes(o))return;const a=ie("WC_METHOD_UNSUPPORTED",o);await this.sendError(n,i,a),this.logger.error(a)}catch(a){await this.sendError(n,i,a),this.logger.error(a)}}),K(this,"onUnknownRpcMethodResponse",i=>{this.registeredMethods.includes(i)||this.logger.error(ie("WC_METHOD_UNSUPPORTED",i))}),K(this,"isValidPair",(i,r)=>{var n;if(!Ae(i)){const{message:a}=U("MISSING_OR_INVALID",`pair() params: ${i}`);throw r.setError(Et.malformed_pairing_uri),new Error(a)}if(!em(i.uri)){const{message:a}=U("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw r.setError(Et.malformed_pairing_uri),new Error(a)}const o=Vo(i==null?void 0:i.uri);if(!((n=o==null?void 0:o.relay)!=null&&n.protocol)){const{message:a}=U("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(Et.malformed_pairing_uri),new Error(a)}if(!(o!=null&&o.symKey)){const{message:a}=U("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(Et.malformed_pairing_uri),new Error(a)}if(o!=null&&o.expiryTimestamp&&k.toMiliseconds(o==null?void 0:o.expiryTimestamp)<Date.now()){r.setError(Et.pairing_expired);const{message:a}=U("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(a)}}),K(this,"isValidPing",async i=>{if(!Ae(i)){const{message:n}=U("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(n)}const{topic:r}=i;await this.isValidPairingTopic(r)}),K(this,"isValidDisconnect",async i=>{if(!Ae(i)){const{message:n}=U("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(n)}const{topic:r}=i;await this.isValidPairingTopic(r)}),K(this,"isValidPairingTopic",async i=>{if(!le(i,!1)){const{message:r}=U("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(r)}if(!this.pairings.keys.includes(i)){const{message:r}=U("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(r)}if(lt(this.pairings.get(i).expiry)){await this.deletePairing(i);const{message:r}=U("EXPIRED",`pairing topic: ${i}`);throw new Error(r)}}),this.core=e,this.logger=_e(t,this.name),this.pairings=new is(this.core,this.logger,this.name,this.storagePrefix)}get context(){return Ue(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(oe.message,async e=>{const{topic:t,message:i,transportType:r}=e;if(this.pairings.keys.includes(t)&&r!==se.link_mode&&!this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))try{const n=await this.core.crypto.decode(t,i);wn(n)?(this.core.history.set(t,n),await this.onRelayEventRequest({topic:t,payload:n})):Gi(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id)),await this.core.relayer.messages.ack(t,i)}catch(n){this.logger.error(n)}})}registerExpirerEvents(){this.core.expirer.on(Ve.expired,async e=>{const{topic:t}=$c(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(Kt.expire,{topic:t}))})}}var iv=Object.defineProperty,rv=(s,e,t)=>e in s?iv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ye=(s,e,t)=>rv(s,typeof e!="symbol"?e+"":e,t);class nv extends Bl{constructor(e,t){super(e,t),this.core=e,this.logger=t,ye(this,"records",new Map),ye(this,"events",new gt.EventEmitter),ye(this,"name",aw),ye(this,"version",cw),ye(this,"cached",[]),ye(this,"initialized",!1),ye(this,"storagePrefix",pt),ye(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),ye(this,"set",(i,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:r,chainId:n}),this.records.has(r.id))return;const o={id:r.id,topic:i,request:{method:r.method,params:r.params||null},chainId:n,expiry:he(k.THIRTY_DAYS)};this.records.set(o.id,o),this.persist(),this.events.emit(Xe.created,o)}),ye(this,"resolve",async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;const r=await this.getRecord(i.id);typeof r.response>"u"&&(r.response=st(i)?{error:i.error}:{result:i.result},this.records.set(r.id,r),this.persist(),this.events.emit(Xe.updated,r))}),ye(this,"get",async(i,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:r}),await this.getRecord(r))),ye(this,"delete",(i,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===i){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(Xe.deleted,n)}}),this.persist()}),ye(this,"exists",async(i,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===i:!1)),ye(this,"on",(i,r)=>{this.events.on(i,r)}),ye(this,"once",(i,r)=>{this.events.once(i,r)}),ye(this,"off",(i,r)=>{this.events.off(i,r)}),ye(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=_e(t,this.name)}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;const i={topic:t.topic,request:it(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const t=this.records.get(e);if(!t){const{message:i}=U("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(Xe.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:t}=U("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(Xe.created,e=>{const t=Xe.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(Xe.updated,e=>{const t=Xe.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(Xe.deleted,e=>{const t=Xe.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(ss.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{k.toMiliseconds(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(Xe.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}}var ov=Object.defineProperty,av=(s,e,t)=>e in s?ov(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xe=(s,e,t)=>av(s,typeof e!="symbol"?e+"":e,t);class cv extends Fl{constructor(e,t){super(e,t),this.core=e,this.logger=t,xe(this,"expirations",new Map),xe(this,"events",new gt.EventEmitter),xe(this,"name",hw),xe(this,"version",lw),xe(this,"cached",[]),xe(this,"initialized",!1),xe(this,"storagePrefix",pt),xe(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),xe(this,"has",i=>{try{const r=this.formatTarget(i);return typeof this.getExpiration(r)<"u"}catch{return!1}}),xe(this,"set",(i,r)=>{this.isInitialized();const n=this.formatTarget(i),o={target:n,expiry:r};this.expirations.set(n,o),this.checkExpiry(n,o),this.events.emit(Ve.created,{target:n,expiration:o})}),xe(this,"get",i=>{this.isInitialized();const r=this.formatTarget(i);return this.getExpiration(r)}),xe(this,"del",i=>{if(this.isInitialized(),this.has(i)){const r=this.formatTarget(i),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(Ve.deleted,{target:r,expiration:n})}}),xe(this,"on",(i,r)=>{this.events.on(i,r)}),xe(this,"once",(i,r)=>{this.events.once(i,r)}),xe(this,"off",(i,r)=>{this.events.off(i,r)}),xe(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=_e(t,this.name)}get context(){return Ue(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return qf(e);if(typeof e=="number")return jf(e);const{message:t}=U("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(Ve.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:t}=U("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const t=this.expirations.get(e);if(!t){const{message:i}=U("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(i),new Error(i)}return t}checkExpiry(e,t){const{expiry:i}=t;k.toMiliseconds(i)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(Ve.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(ss.pulse,()=>this.checkExpirations()),this.events.on(Ve.created,e=>{const t=Ve.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Ve.expired,e=>{const t=Ve.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Ve.deleted,e=>{const t=Ve.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}}var hv=Object.defineProperty,lv=(s,e,t)=>e in s?hv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ce=(s,e,t)=>lv(s,typeof e!="symbol"?e+"":e,t);class uv extends Hl{constructor(e,t,i){super(e,t,i),this.core=e,this.logger=t,this.store=i,ce(this,"name",uw),ce(this,"abortController"),ce(this,"isDevEnv"),ce(this,"verifyUrlV3",fw),ce(this,"storagePrefix",pt),ce(this,"version",Ih),ce(this,"publicKey"),ce(this,"fetchPromise"),ce(this,"init",async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&k.toMiliseconds((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))}),ce(this,"register",async r=>{if(!Os()||this.isDevEnv)return;const n=window.location.origin,{id:o,decryptedId:a}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${o}&decryptedId=${a}`;try{const h=Ps(),l=this.startAbortTimer(k.ONE_SECOND*5),u=await new Promise((d,p)=>{const f=()=>{window.removeEventListener("message",m),h.body.removeChild(g),p("attestation aborted")};this.abortController.signal.addEventListener("abort",f);const g=h.createElement("iframe");g.src=c,g.style.display="none",g.addEventListener("error",f,{signal:this.abortController.signal});const m=x=>{if(x.data&&typeof x.data=="string")try{const E=JSON.parse(x.data);if(E.type==="verify_attestation"){if(Nr(E.attestation).payload.id!==o)return;clearInterval(l),h.body.removeChild(g),this.abortController.signal.removeEventListener("abort",f),window.removeEventListener("message",m),d(E.attestation===null?"":E.attestation)}}catch(E){this.logger.warn(E)}};h.body.appendChild(g),window.addEventListener("message",m,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",u),u}catch(h){this.logger.warn(h)}return""}),ce(this,"resolve",async r=>{if(this.isDevEnv)return"";const{attestationId:n,hash:o,encryptedId:a}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(Nr(n).payload.id!==a)return;const h=await this.isValidJwtAttestation(n);if(h){if(!h.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return h}}if(!o)return;const c=this.getVerifyUrl(r==null?void 0:r.verifyUrl);return this.fetchAttestation(o,c)}),ce(this,"fetchAttestation",async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);const o=this.startAbortTimer(k.ONE_SECOND*5),a=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(o),a.status===200?await a.json():void 0}),ce(this,"getVerifyUrl",r=>{let n=r||si;return pw.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${si}`),n=si),n}),ce(this,"fetchPublicKey",async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);const r=this.startAbortTimer(k.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}}),ce(this,"persistPublicKey",async r=>{this.logger.debug("persisting public key to local storage",r),await this.store.setItem(this.storeKey,r),this.publicKey=r}),ce(this,"removePublicKey",async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0}),ce(this,"isValidJwtAttestation",async r=>{const n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}const o=await this.fetchAndPersistPublicKey();try{if(o)return this.validateAttestation(r,o)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}}),ce(this,"getPublicKey",async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey()),ce(this,"fetchAndPersistPublicKey",async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{const o=await this.fetchPublicKey();o&&(await this.persistPublicKey(o),n(o))});const r=await this.fetchPromise;return this.fetchPromise=void 0,r}),ce(this,"validateAttestation",(r,n)=>{const o=Ry(r,n.publicKey),a={hasExpired:k.toMiliseconds(o.exp)<Date.now(),payload:o};if(a.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:a.payload.origin,isScam:a.payload.isScam,isVerified:a.payload.isVerified}}),this.logger=_e(t,this.name),this.abortController=new AbortController,this.isDevEnv=Dn(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return Ue(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),k.toMiliseconds(e))}}var dv=Object.defineProperty,fv=(s,e,t)=>e in s?dv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Da=(s,e,t)=>fv(s,typeof e!="symbol"?e+"":e,t);class pv extends Vl{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,Da(this,"context",gw),Da(this,"registerDeviceToken",async i=>{const{clientId:r,token:n,notificationType:o,enableEncrypted:a=!1}=i,c=`${yw}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:o,token:n,always_raw:a})})}),this.logger=_e(t,this.context)}}var gv=Object.defineProperty,Pa=Object.getOwnPropertySymbols,yv=Object.prototype.hasOwnProperty,mv=Object.prototype.propertyIsEnumerable,un=(s,e,t)=>e in s?gv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ks=(s,e)=>{for(var t in e||(e={}))yv.call(e,t)&&un(s,t,e[t]);if(Pa)for(var t of Pa(e))mv.call(e,t)&&un(s,t,e[t]);return s},fe=(s,e,t)=>un(s,typeof e!="symbol"?e+"":e,t);class wv extends Kl{constructor(e,t,i=!0){super(e,t,i),this.core=e,this.logger=t,fe(this,"context",ww),fe(this,"storagePrefix",pt),fe(this,"storageVersion",mw),fe(this,"events",new Map),fe(this,"shouldPersist",!1),fe(this,"init",async()=>{if(!Dn())try{const r={eventId:fo(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:Sc(this.core.relayer.protocol,this.core.relayer.version,sn)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}}),fe(this,"createEvent",r=>{const{event:n="ERROR",type:o="",properties:{topic:a,trace:c}}=r,h=fo(),l=this.core.projectId||"",u=Date.now(),d=Ks({eventId:h,timestamp:u,props:{event:n,type:o,properties:{topic:a,trace:c}},bundleId:l,domain:this.getAppDomain()},this.setMethods(h));return this.telemetryEnabled&&(this.events.set(h,d),this.shouldPersist=!0),d}),fe(this,"getEvent",r=>{const{eventId:n,topic:o}=r;if(n)return this.events.get(n);const a=Array.from(this.events.values()).find(c=>c.props.properties.topic===o);if(a)return Ks(Ks({},a),this.setMethods(a.eventId))}),fe(this,"deleteEvent",r=>{const{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0}),fe(this,"setEventListeners",()=>{this.core.heartbeat.on(ss.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{k.fromMiliseconds(Date.now())-k.fromMiliseconds(r.timestamp)>bw&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})}),fe(this,"setMethods",r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)})),fe(this,"addTrace",(r,n)=>{const o=this.events.get(r);o&&(o.props.properties.trace.push(n),this.events.set(r,o),this.shouldPersist=!0)}),fe(this,"setError",(r,n)=>{const o=this.events.get(r);o&&(o.props.type=n,o.timestamp=Date.now(),this.events.set(r,o),this.shouldPersist=!0)}),fe(this,"persist",async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1}),fe(this,"restore",async()=>{try{const r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,Ks(Ks({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}}),fe(this,"submit",async()=>{if(!this.telemetryEnabled||this.events.size===0)return;const r=[];for(const[n,o]of this.events)o.props.type&&r.push(o);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(const n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}}),fe(this,"sendEvent",async r=>{const n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${vw}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${sn}${n}`,{method:"POST",body:JSON.stringify(r)})}),fe(this,"getAppDomain",()=>Pc().url),this.logger=_e(t,this.context),this.telemetryEnabled=i,i?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}}var bv=Object.defineProperty,Sa=Object.getOwnPropertySymbols,vv=Object.prototype.hasOwnProperty,Ev=Object.prototype.propertyIsEnumerable,dn=(s,e,t)=>e in s?bv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,_a=(s,e)=>{for(var t in e||(e={}))vv.call(e,t)&&dn(s,t,e[t]);if(Sa)for(var t of Sa(e))Ev.call(e,t)&&dn(s,t,e[t]);return s},te=(s,e,t)=>dn(s,typeof e!="symbol"?e+"":e,t);let Iv=class Bh extends Rl{constructor(e){var t;super(e),te(this,"protocol",Eh),te(this,"version",Ih),te(this,"name",tn),te(this,"relayUrl"),te(this,"projectId"),te(this,"customStoragePrefix"),te(this,"events",new gt.EventEmitter),te(this,"logger"),te(this,"heartbeat"),te(this,"relayer"),te(this,"crypto"),te(this,"storage"),te(this,"history"),te(this,"expirer"),te(this,"pairing"),te(this,"verify"),te(this,"echoClient"),te(this,"linkModeSupportedApps"),te(this,"eventClient"),te(this,"initialized",!1),te(this,"logChunkController"),te(this,"on",(a,c)=>this.events.on(a,c)),te(this,"once",(a,c)=>this.events.once(a,c)),te(this,"off",(a,c)=>this.events.off(a,c)),te(this,"removeListener",(a,c)=>this.events.removeListener(a,c)),te(this,"dispatchEnvelope",({topic:a,message:c,sessionExists:h})=>{if(!a||!c)return;const l={topic:a,message:c,publishedAt:Date.now(),transportType:se.link_mode};this.relayer.onLinkMessageEvent(l,{sessionExists:h})});const i=this.getGlobalCore(e==null?void 0:e.customStoragePrefix);if(i)try{return this.customStoragePrefix=i.customStoragePrefix,this.logger=i.logger,this.heartbeat=i.heartbeat,this.crypto=i.crypto,this.history=i.history,this.expirer=i.expirer,this.storage=i.storage,this.relayer=i.relayer,this.pairing=i.pairing,this.verify=i.verify,this.echoClient=i.echoClient,this.linkModeSupportedApps=i.linkModeSupportedApps,this.eventClient=i.eventClient,this.initialized=i.initialized,this.logChunkController=i.logChunkController,i}catch(a){console.warn("Failed to copy global core",a)}this.projectId=e==null?void 0:e.projectId,this.relayUrl=(e==null?void 0:e.relayUrl)||Dh,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";const r=Wi({level:typeof(e==null?void 0:e.logger)=="string"&&e.logger?e.logger:Mm.logger,name:tn}),{logger:n,chunkLoggerController:o}=Ol({opts:r,maxSizeInBytes:e==null?void 0:e.maxLogBlobSizeInBytes,loggerOverride:e==null?void 0:e.logger});this.logChunkController=o,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,c;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((c=this.logChunkController)==null||c.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=_e(n,this.name),this.heartbeat=new gl,this.crypto=new Jb(this,this.logger,e==null?void 0:e.keychain),this.history=new nv(this,this.logger),this.expirer=new cv(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new ul(_a(_a({},zm),e==null?void 0:e.storageOptions)),this.relayer=new I0({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new sv(this,this.logger),this.verify=new uv(this,this.logger,this.storage),this.echoClient=new pv(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new wv(this,this.logger,e==null?void 0:e.telemetryEnabled),this.setGlobalCore(this)}static async init(e){const t=new Bh(e);await t.initialize();const i=await t.crypto.getClientId();return await t.storage.setItem(sw,i),t}get context(){return Ue(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(na,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(na)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}getGlobalCore(e=""){try{if(this.isGlobalCoreDisabled())return;const t=`_walletConnectCore_${e}`,i=`${t}_count`;return globalThis[i]=(globalThis[i]||0)+1,globalThis[i]>1&&console.warn(`WalletConnect Core is already initialized. This is probably a mistake and can lead to unexpected behavior. Init() was called ${globalThis[i]} times.`),globalThis[t]}catch(t){console.warn("Failed to get global WalletConnect core",t);return}}setGlobalCore(e){var t;try{if(this.isGlobalCoreDisabled())return;const i=`_walletConnectCore_${((t=e.opts)==null?void 0:t.customStoragePrefix)||""}`;globalThis[i]=e}catch(i){console.warn("Failed to set global WalletConnect core",i)}}isGlobalCoreDisabled(){try{return typeof process<"u"&&Lm.DISABLE_GLOBAL_CORE==="true"}catch{return!0}}};const xv=Iv,qh="wc",jh=2,Lh="client",qn=`${qh}@${jh}:${Lh}:`,Dr={name:Lh,logger:"error"},$a="WALLETCONNECT_DEEPLINK_CHOICE",Dv="proposal",Aa="Proposal expired",Pv="session",ls=k.SEVEN_DAYS,Sv="engine",me={wc_sessionPropose:{req:{ttl:k.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:k.ONE_DAY,prompt:!1,tag:1104},res:{ttl:k.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:k.ONE_DAY,prompt:!1,tag:1106},res:{ttl:k.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:k.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:k.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:k.ONE_DAY,prompt:!1,tag:1112},res:{ttl:k.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:k.ONE_DAY,prompt:!1,tag:1114},res:{ttl:k.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:k.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:k.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:k.FIVE_MINUTES,prompt:!1,tag:1119}}},Pr={min:k.FIVE_MINUTES,max:k.SEVEN_DAYS},ct={idle:"IDLE",active:"ACTIVE"},_v={eth_sendTransaction:{key:""},eth_sendRawTransaction:{key:""},wallet_sendCalls:{key:""},solana_signTransaction:{key:"signature"},solana_signAllTransactions:{key:"transactions"},solana_signAndSendTransaction:{key:"signature"},sui_signAndExecuteTransaction:{key:"digest"},sui_signTransaction:{key:""},hedera_signAndExecuteTransaction:{key:"transactionId"},hedera_executeTransaction:{key:"transactionId"},near_signTransaction:{key:""},near_signTransactions:{key:""},tron_signTransaction:{key:"txID"},xrpl_signTransaction:{key:""},xrpl_signTransactionFor:{key:""},algo_signTxn:{key:""},sendTransfer:{key:"txid"},stacks_stxTransfer:{key:"txId"},polkadot_signTransaction:{key:""},cosmos_signDirect:{key:""}},$v="request",Av=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],Ov="wc",Cv="auth",Tv="authKeys",Rv="pairingTopics",Nv="requests",nr=`${Ov}@${1.5}:${Cv}:`,Ui=`${nr}:PUB_KEY`;var Uv=Object.defineProperty,kv=Object.defineProperties,Bv=Object.getOwnPropertyDescriptors,Oa=Object.getOwnPropertySymbols,qv=Object.prototype.hasOwnProperty,jv=Object.prototype.propertyIsEnumerable,fn=(s,e,t)=>e in s?Uv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Q=(s,e)=>{for(var t in e||(e={}))qv.call(e,t)&&fn(s,t,e[t]);if(Oa)for(var t of Oa(e))jv.call(e,t)&&fn(s,t,e[t]);return s},De=(s,e)=>kv(s,Bv(e)),P=(s,e,t)=>fn(s,typeof e!="symbol"?e+"":e,t);let Lv=class extends Yl{constructor(e){super(e),P(this,"name",Sv),P(this,"events",new bn),P(this,"initialized",!1),P(this,"requestQueue",{state:ct.idle,queue:[]}),P(this,"sessionRequestQueue",{state:ct.idle,queue:[]}),P(this,"emittedSessionRequests",new Wf({limit:500})),P(this,"requestQueueDelay",k.ONE_SECOND),P(this,"expectedPairingMethodMap",new Map),P(this,"recentlyDeletedMap",new Map),P(this,"recentlyDeletedLimit",200),P(this,"relayMessageCache",[]),P(this,"pendingSessions",new Map),P(this,"init",async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(me)}),this.initialized=!0,setTimeout(async()=>{await this.processPendingMessageEvents(),this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},k.toMiliseconds(this.requestQueueDelay)))}),P(this,"connect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();const i=De(Q({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(i),i.optionalNamespaces=Jy(i.requiredNamespaces,i.optionalNamespaces),i.requiredNamespaces={};const{pairingTopic:r,requiredNamespaces:n,optionalNamespaces:o,sessionProperties:a,scopedProperties:c,relays:h}=i;let l=r,u,d=!1;try{if(l){const R=this.client.core.pairing.pairings.get(l);this.client.logger.warn("connect() with existing pairing topic is deprecated and will be removed in the next major release."),d=R.active}}catch(R){throw this.client.logger.error(`connect() -> pairing.get(${l}) failed`),R}if(!l||!d){const{topic:R,uri:B}=await this.client.core.pairing.create({internal:{skipSubscribe:!0}});l=R,u=B}if(!l){const{message:R}=U("NO_MATCHING_KEY",`connect() pairing topic: ${l}`);throw new Error(R)}const p=await this.client.core.crypto.generateKeyPair(),f=me.wc_sessionPropose.req.ttl||k.FIVE_MINUTES,g=he(f),m=De(Q(Q({requiredNamespaces:n,optionalNamespaces:o,relays:h??[{protocol:xh}],proposer:{publicKey:p,metadata:this.client.metadata},expiryTimestamp:g,pairingTopic:l},a&&{sessionProperties:a}),c&&{scopedProperties:c}),{id:St()}),x=Z("session_connect",m.id),{reject:E,resolve:S,done:T}=Vt(f,Aa),I=({id:R})=>{R===m.id&&(this.client.events.off("proposal_expire",I),this.pendingSessions.delete(m.id),this.events.emit(x,{error:{message:Aa,code:0}}))};return this.client.events.on("proposal_expire",I),this.events.once(x,({error:R,session:B})=>{this.client.events.off("proposal_expire",I),R?E(R):B&&S(B)}),await this.sendProposeSession({proposal:m,publishOpts:{internal:{throwOnFailedPublish:!0},tvf:{correlationId:m.id}}}),await this.setProposal(m.id,m),{uri:u,approval:T}}),P(this,"pair",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(t)}catch(i){throw this.client.logger.error("pair() failed"),i}}),P(this,"approve",async t=>{var i,r,n;const o=this.client.core.eventClient.createEvent({properties:{topic:(i=t==null?void 0:t.id)==null?void 0:i.toString(),trace:[Rt.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(y){throw o.setError(Fs.no_internet_connection),y}try{await this.isValidProposalId(t==null?void 0:t.id)}catch(y){throw this.client.logger.error(`approve() -> proposal.get(${t==null?void 0:t.id}) failed`),o.setError(Fs.proposal_not_found),y}try{await this.isValidApprove(t)}catch(y){throw this.client.logger.error("approve() -> isValidApprove() failed"),o.setError(Fs.session_approve_namespace_validation_failure),y}const{id:a,relayProtocol:c,namespaces:h,sessionProperties:l,scopedProperties:u,sessionConfig:d}=t,p=this.client.proposal.get(a);this.client.core.eventClient.deleteEvent({eventId:o.eventId});const{pairingTopic:f,proposer:g,requiredNamespaces:m,optionalNamespaces:x}=p;let E=(r=this.client.core.eventClient)==null?void 0:r.getEvent({topic:f});E||(E=(n=this.client.core.eventClient)==null?void 0:n.createEvent({type:Rt.session_approve_started,properties:{topic:f,trace:[Rt.session_approve_started,Rt.session_namespaces_validation_success]}}));const S=await this.client.core.crypto.generateKeyPair(),T=g.publicKey,I=await this.client.core.crypto.generateSharedKey(S,T),R=Q(Q(Q({relay:{protocol:c??"irn"},namespaces:h,controller:{publicKey:S,metadata:this.client.metadata},expiry:he(ls)},l&&{sessionProperties:l}),u&&{scopedProperties:u}),d&&{sessionConfig:d}),B=se.relay;E.addTrace(Rt.subscribing_session_topic);try{await this.client.core.relayer.subscribe(I,{transportType:B,internal:{skipSubscribe:!0}})}catch(y){throw E.setError(Fs.subscribe_session_topic_failure),y}E.addTrace(Rt.subscribe_session_topic_success);const C=De(Q({},R),{topic:I,requiredNamespaces:m,optionalNamespaces:x,pairingTopic:f,acknowledged:!1,self:R.controller,peer:{publicKey:g.publicKey,metadata:g.metadata},controller:S,transportType:se.relay});await this.client.session.set(I,C),E.addTrace(Rt.store_session);try{await this.sendApproveSession({sessionTopic:I,proposal:p,pairingProposalResponse:{relay:{protocol:c??"irn"},responderPublicKey:S},sessionSettleRequest:R,publishOpts:{internal:{throwOnFailedPublish:!0},tvf:{correlationId:a}}}),E.addTrace(Rt.session_approve_publish_success)}catch(y){throw this.client.logger.error(y),this.client.session.delete(I,ie("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(I),y}return this.client.core.eventClient.deleteEvent({eventId:E.eventId}),await this.client.core.pairing.updateMetadata({topic:f,metadata:g.metadata}),await this.deleteProposal(a),await this.client.core.pairing.activate({topic:f}),await this.setExpiry(I,he(ls)),{topic:I,acknowledged:()=>Promise.resolve(this.client.session.get(I))}}),P(this,"reject",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(t)}catch(o){throw this.client.logger.error("reject() -> isValidReject() failed"),o}const{id:i,reason:r}=t;let n;try{n=this.client.proposal.get(i).pairingTopic}catch(o){throw this.client.logger.error(`reject() -> proposal.get(${i}) failed`),o}n&&await this.sendError({id:i,topic:n,error:r,rpcOpts:me.wc_sessionPropose.reject}),await this.deleteProposal(i)}),P(this,"update",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(t)}catch(u){throw this.client.logger.error("update() -> isValidUpdate() failed"),u}const{topic:i,namespaces:r}=t,{done:n,resolve:o,reject:a}=Vt(),c=St(),h=qt().toString(),l=this.client.session.get(i).namespaces;return this.events.once(Z("session_update",c),({error:u})=>{u?a(u):o()}),await this.client.session.update(i,{namespaces:r}),await this.sendRequest({topic:i,method:"wc_sessionUpdate",params:{namespaces:r},throwOnFailedPublish:!0,clientRpcId:c,relayRpcId:h}).catch(u=>{this.client.logger.error(u),this.client.session.update(i,{namespaces:l}),a(u)}),{acknowledged:n}}),P(this,"extend",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(t)}catch(c){throw this.client.logger.error("extend() -> isValidExtend() failed"),c}const{topic:i}=t,r=St(),{done:n,resolve:o,reject:a}=Vt();return this.events.once(Z("session_extend",r),({error:c})=>{c?a(c):o()}),await this.setExpiry(i,he(ls)),this.sendRequest({topic:i,method:"wc_sessionExtend",params:{},clientRpcId:r,throwOnFailedPublish:!0}).catch(c=>{a(c)}),{acknowledged:n}}),P(this,"request",async t=>{this.isInitialized();try{await this.isValidRequest(t)}catch(m){throw this.client.logger.error("request() -> isValidRequest() failed"),m}const{chainId:i,request:r,topic:n,expiry:o=me.wc_sessionRequest.req.ttl}=t,a=this.client.session.get(n);(a==null?void 0:a.transportType)===se.relay&&await this.confirmOnlineStateOrThrow();const c=St(),h=qt().toString(),{done:l,resolve:u,reject:d}=Vt(o,"Request expired. Please try again.");this.events.once(Z("session_request",c),({error:m,result:x})=>{m?d(m):u(x)});const p="wc_sessionRequest",f=this.getAppLinkIfEnabled(a.peer.metadata,a.transportType);if(f)return await this.sendRequest({clientRpcId:c,relayRpcId:h,topic:n,method:p,params:{request:De(Q({},r),{expiryTimestamp:he(o)}),chainId:i},expiry:o,throwOnFailedPublish:!0,appLink:f}).catch(m=>d(m)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),await l();const g={request:De(Q({},r),{expiryTimestamp:he(o)}),chainId:i};return await Promise.all([new Promise(async m=>{await this.sendRequest({clientRpcId:c,relayRpcId:h,topic:n,method:p,params:g,expiry:o,throwOnFailedPublish:!0,tvf:this.getTVFParams(c,g)}).catch(x=>d(x)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),m()}),new Promise(async m=>{var x;if(!((x=a.sessionConfig)!=null&&x.disableDeepLink)){const E=await Ff(this.client.core.storage,$a);await Lf({id:c,topic:n,wcDeepLink:E})}m()}),l()]).then(m=>m[2])}),P(this,"respond",async t=>{this.isInitialized(),await this.isValidRespond(t);const{topic:i,response:r}=t,{id:n}=r,o=this.client.session.get(i);o.transportType===se.relay&&await this.confirmOnlineStateOrThrow();const a=this.getAppLinkIfEnabled(o.peer.metadata,o.transportType);bt(r)?await this.sendResult({id:n,topic:i,result:r.result,throwOnFailedPublish:!0,appLink:a}):st(r)&&await this.sendError({id:n,topic:i,error:r.error,appLink:a}),this.cleanupAfterResponse(t)}),P(this,"ping",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(t)}catch(r){throw this.client.logger.error("ping() -> isValidPing() failed"),r}const{topic:i}=t;if(this.client.session.keys.includes(i)){const r=St(),n=qt().toString(),{done:o,resolve:a,reject:c}=Vt();this.events.once(Z("session_ping",r),({error:h})=>{h?c(h):a()}),await Promise.all([this.sendRequest({topic:i,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:r,relayRpcId:n}),o()])}else this.client.core.pairing.pairings.keys.includes(i)&&(this.client.logger.warn("ping() on pairing topic is deprecated and will be removed in the next major release."),await this.client.core.pairing.ping({topic:i}))}),P(this,"emit",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(t);const{topic:i,event:r,chainId:n}=t,o=qt().toString(),a=St();await this.sendRequest({topic:i,method:"wc_sessionEvent",params:{event:r,chainId:n},throwOnFailedPublish:!0,relayRpcId:o,clientRpcId:a})}),P(this,"disconnect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(t);const{topic:i}=t;if(this.client.session.keys.includes(i))await this.sendRequest({topic:i,method:"wc_sessionDelete",params:ie("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:i,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(i))await this.client.core.pairing.disconnect({topic:i});else{const{message:r}=U("MISMATCHED_TOPIC",`Session or pairing topic not found: ${i}`);throw new Error(r)}}),P(this,"find",t=>(this.isInitialized(),this.client.session.getAll().filter(i=>Qy(i,t)))),P(this,"getPendingSessionRequests",()=>this.client.pendingRequest.getAll()),P(this,"authenticate",async(t,i)=>{var r;this.isInitialized(),this.isValidAuthenticate(t);const n=i&&this.client.core.linkModeSupportedApps.includes(i)&&((r=this.client.metadata.redirect)==null?void 0:r.linkMode),o=n?se.link_mode:se.relay;o===se.relay&&await this.confirmOnlineStateOrThrow();const{chains:a,statement:c="",uri:h,domain:l,nonce:u,type:d,exp:p,nbf:f,methods:g=[],expiry:m}=t,x=[...t.resources||[]],{topic:E,uri:S}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:o});this.client.logger.info({message:"Generated new pairing",pairing:{topic:E,uri:S}});const T=await this.client.core.crypto.generateKeyPair(),I=Ri(T);if(await Promise.all([this.client.auth.authKeys.set(Ui,{responseTopic:I,publicKey:T}),this.client.auth.pairingTopics.set(I,{topic:I,pairingTopic:E})]),await this.client.core.relayer.subscribe(I,{transportType:o}),this.client.logger.info(`sending request to new pairing topic: ${E}`),g.length>0){const{namespace:_}=jt(a[0]);let M=ng(_,"request",g);Ti(x)&&(M=ag(M,x.pop())),x.push(M)}const R=m&&m>me.wc_sessionAuthenticate.req.ttl?m:me.wc_sessionAuthenticate.req.ttl,B={authPayload:{type:d??"caip122",chains:a,statement:c,aud:h,domain:l,version:"1",nonce:u,iat:new Date().toISOString(),exp:p,nbf:f,resources:x},requester:{publicKey:T,metadata:this.client.metadata},expiryTimestamp:he(R)},C={eip155:{chains:a,methods:[...new Set(["personal_sign",...g])],events:["chainChanged","accountsChanged"]}},y={requiredNamespaces:{},optionalNamespaces:C,relays:[{protocol:"irn"}],pairingTopic:E,proposer:{publicKey:T,metadata:this.client.metadata},expiryTimestamp:he(me.wc_sessionPropose.req.ttl),id:St()},{done:v,resolve:w,reject:b}=Vt(R,"Request expired"),D=St(),A=Z("session_connect",y.id),$=Z("session_request",D),O=async({error:_,session:M})=>{this.events.off($,N),_?b(_):M&&w({session:M})},N=async _=>{var M,L,z;if(await this.deletePendingAuthRequest(D,{message:"fulfilled",code:0}),_.error){const re=ie("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return _.error.code===re.code?void 0:(this.events.off(A,O),b(_.error.message))}await this.deleteProposal(y.id),this.events.off(A,O);const{cacaos:H,responder:F}=_.result,V=[],X=[];for(const re of H){await Do({cacao:re,projectId:this.client.core.projectId})||(this.client.logger.error(re,"Signature verification failed"),b(ie("SESSION_SETTLEMENT_FAILED","Signature verification failed")));const{p:Me}=re,yt=Ti(Me.resources),zn=[Hr(Me.iss)],Qh=zi(Me.iss);if(yt){const ar=Po(yt),Xh=So(yt);V.push(...ar),zn.push(...Xh)}for(const ar of zn)X.push(`${ar}:${Qh}`)}const ae=await this.client.core.crypto.generateSharedKey(T,F.publicKey);let ne;V.length>0&&(ne={topic:ae,acknowledged:!0,self:{publicKey:T,metadata:this.client.metadata},peer:F,controller:F.publicKey,expiry:he(ls),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:E,namespaces:Yo([...new Set(V)],[...new Set(X)]),transportType:o},await this.client.core.relayer.subscribe(ae,{transportType:o}),await this.client.session.set(ae,ne),E&&await this.client.core.pairing.updateMetadata({topic:E,metadata:F.metadata}),ne=this.client.session.get(ae)),(M=this.client.metadata.redirect)!=null&&M.linkMode&&(L=F.metadata.redirect)!=null&&L.linkMode&&(z=F.metadata.redirect)!=null&&z.universal&&i&&(this.client.core.addLinkModeSupportedApp(F.metadata.redirect.universal),this.client.session.update(ae,{transportType:se.link_mode})),w({auths:H,session:ne})};this.events.once(A,O),this.events.once($,N);let j;try{if(n){const _=it("wc_sessionAuthenticate",B,D);this.client.core.history.set(E,_);const M=await this.client.core.crypto.encode("",_,{type:wi,encoding:Bt});j=_i(i,E,M)}else await Promise.all([this.sendRequest({topic:E,method:"wc_sessionAuthenticate",params:B,expiry:t.expiry,throwOnFailedPublish:!0,clientRpcId:D}),this.sendRequest({topic:E,method:"wc_sessionPropose",params:y,expiry:me.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:y.id})])}catch(_){throw this.events.off(A,O),this.events.off($,N),_}return await this.setProposal(y.id,y),await this.setAuthRequest(D,{request:De(Q({},B),{verifyContext:{}}),pairingTopic:E,transportType:o}),{uri:j??S,response:v}}),P(this,"approveSessionAuthenticate",async t=>{const{id:i,auths:r}=t,n=this.client.core.eventClient.createEvent({properties:{topic:i.toString(),trace:[Ft.authenticated_session_approve_started]}});try{this.isInitialized()}catch(m){throw n.setError(Hs.no_internet_connection),m}const o=this.getPendingAuthRequest(i);if(!o)throw n.setError(Hs.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${i}`);const a=o.transportType||se.relay;a===se.relay&&await this.confirmOnlineStateOrThrow();const c=o.requester.publicKey,h=await this.client.core.crypto.generateKeyPair(),l=Ri(c),u={type:xt,receiverPublicKey:c,senderPublicKey:h},d=[],p=[];for(const m of r){if(!await Do({cacao:m,projectId:this.client.core.projectId})){n.setError(Hs.invalid_cacao);const I=ie("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:i,topic:l,error:I,encodeOpts:u}),new Error(I.message)}n.addTrace(Ft.cacaos_verified);const{p:x}=m,E=Ti(x.resources),S=[Hr(x.iss)],T=zi(x.iss);if(E){const I=Po(E),R=So(E);d.push(...I),S.push(...R)}for(const I of S)p.push(`${I}:${T}`)}const f=await this.client.core.crypto.generateSharedKey(h,c);n.addTrace(Ft.create_authenticated_session_topic);let g;if((d==null?void 0:d.length)>0){g={topic:f,acknowledged:!0,self:{publicKey:h,metadata:this.client.metadata},peer:{publicKey:c,metadata:o.requester.metadata},controller:c,expiry:he(ls),authentication:r,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:o.pairingTopic,namespaces:Yo([...new Set(d)],[...new Set(p)]),transportType:a},n.addTrace(Ft.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(f,{transportType:a})}catch(m){throw n.setError(Hs.subscribe_authenticated_session_topic_failure),m}n.addTrace(Ft.subscribe_authenticated_session_topic_success),await this.client.session.set(f,g),n.addTrace(Ft.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:o.pairingTopic,metadata:o.requester.metadata})}n.addTrace(Ft.publishing_authenticated_session_approve);try{await this.sendResult({topic:l,id:i,result:{cacaos:r,responder:{publicKey:h,metadata:this.client.metadata}},encodeOpts:u,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(o.requester.metadata,a)})}catch(m){throw n.setError(Hs.authenticated_session_approve_publish_failure),m}return await this.client.auth.requests.delete(i,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:o.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:n.eventId}),{session:g}}),P(this,"rejectSessionAuthenticate",async t=>{this.isInitialized();const{id:i,reason:r}=t,n=this.getPendingAuthRequest(i);if(!n)throw new Error(`Could not find pending auth request with id ${i}`);n.transportType===se.relay&&await this.confirmOnlineStateOrThrow();const o=n.requester.publicKey,a=await this.client.core.crypto.generateKeyPair(),c=Ri(o),h={type:xt,receiverPublicKey:o,senderPublicKey:a};await this.sendError({id:i,topic:c,error:r,encodeOpts:h,rpcOpts:me.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(n.requester.metadata,n.transportType)}),await this.client.auth.requests.delete(i,{message:"rejected",code:0}),await this.deleteProposal(i)}),P(this,"formatAuthMessage",t=>{this.isInitialized();const{request:i,iss:r}=t;return Fc(i,r)}),P(this,"processRelayMessageCache",()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{const t=this.relayMessageCache.shift();t&&await this.onRelayMessage(t)}catch(t){this.client.logger.error(t)}},50)}),P(this,"cleanupDuplicatePairings",async t=>{if(t.pairingTopic)try{const i=this.client.core.pairing.pairings.get(t.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var o,a;return((o=n.peerMetadata)==null?void 0:o.url)&&((a=n.peerMetadata)==null?void 0:a.url)===t.peer.metadata.url&&n.topic&&n.topic!==i.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(i){this.client.logger.error(i)}}),P(this,"deleteSession",async t=>{var i;const{topic:r,expirerHasDeleted:n=!1,emitEvent:o=!0,id:a=0}=t,{self:c}=this.client.session.get(r);await this.client.core.relayer.unsubscribe(r),await this.client.session.delete(r,ie("USER_DISCONNECTED")),this.addToRecentlyDeleted(r,"session"),this.client.core.crypto.keychain.has(c.publicKey)&&await this.client.core.crypto.deleteKeyPair(c.publicKey),this.client.core.crypto.keychain.has(r)&&await this.client.core.crypto.deleteSymKey(r),n||this.client.core.expirer.del(r),this.client.core.storage.removeItem($a).catch(h=>this.client.logger.warn(h)),this.getPendingSessionRequests().forEach(h=>{h.topic===r&&this.deletePendingSessionRequest(h.id,ie("USER_DISCONNECTED"))}),r===((i=this.sessionRequestQueue.queue[0])==null?void 0:i.topic)&&(this.sessionRequestQueue.state=ct.idle),o&&this.client.events.emit("session_delete",{id:a,topic:r})}),P(this,"deleteProposal",async(t,i)=>{if(i)try{const r=this.client.proposal.get(t),n=this.client.core.eventClient.getEvent({topic:r.pairingTopic});n==null||n.setError(Fs.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(t,ie("USER_DISCONNECTED")),i?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"proposal")}),P(this,"deletePendingSessionRequest",async(t,i,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(n=>n.id!==t),r&&(this.sessionRequestQueue.state=ct.idle,this.client.events.emit("session_request_expire",{id:t}))}),P(this,"deletePendingAuthRequest",async(t,i,r=!1)=>{await Promise.all([this.client.auth.requests.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)])}),P(this,"setExpiry",async(t,i)=>{this.client.session.keys.includes(t)&&(this.client.core.expirer.set(t,i),await this.client.session.update(t,{expiry:i}))}),P(this,"setProposal",async(t,i)=>{this.client.core.expirer.set(t,he(me.wc_sessionPropose.req.ttl)),await this.client.proposal.set(t,i)}),P(this,"setAuthRequest",async(t,i)=>{const{request:r,pairingTopic:n,transportType:o=se.relay}=i;this.client.core.expirer.set(t,r.expiryTimestamp),await this.client.auth.requests.set(t,{authPayload:r.authPayload,requester:r.requester,expiryTimestamp:r.expiryTimestamp,id:t,pairingTopic:n,verifyContext:r.verifyContext,transportType:o})}),P(this,"setPendingSessionRequest",async t=>{const{id:i,topic:r,params:n,verifyContext:o}=t,a=n.request.expiryTimestamp||he(me.wc_sessionRequest.req.ttl);this.client.core.expirer.set(i,a),await this.client.pendingRequest.set(i,{id:i,topic:r,params:n,verifyContext:o})}),P(this,"sendRequest",async t=>{const{topic:i,method:r,params:n,expiry:o,relayRpcId:a,clientRpcId:c,throwOnFailedPublish:h,appLink:l,tvf:u,publishOpts:d={}}=t,p=it(r,n,c);let f;const g=!!l;try{const E=g?Bt:Te;f=await this.client.core.crypto.encode(i,p,{encoding:E})}catch(E){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${i} failed`),E}let m;if(Av.includes(r)){const E=Ke(JSON.stringify(p)),S=Ke(f);m=await this.client.core.verify.register({id:S,decryptedId:E})}const x=Q(Q({},me[r].req),d);if(x.attestation=m,o&&(x.ttl=o),a&&(x.id=a),this.client.core.history.set(i,p),g){const E=_i(l,i,f);await global.Linking.openURL(E,this.client.name)}else x.tvf=De(Q({},u),{correlationId:p.id}),h?(x.internal=De(Q({},x.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(i,f,x)):this.client.core.relayer.publish(i,f,x).catch(E=>this.client.logger.error(E));return p.id}),P(this,"sendProposeSession",async t=>{const{proposal:i,publishOpts:r}=t,n=it("wc_sessionPropose",i,i.id);this.client.core.history.set(i.pairingTopic,n);const o=await this.client.core.crypto.encode(i.pairingTopic,n,{encoding:Te}),a=Ke(JSON.stringify(n)),c=Ke(o),h=await this.client.core.verify.register({id:c,decryptedId:a});await this.client.core.relayer.publishCustom({payload:{pairingTopic:i.pairingTopic,sessionProposal:o},opts:De(Q({},r),{publishMethod:"wc_proposeSession",attestation:h})})}),P(this,"sendApproveSession",async t=>{const{sessionTopic:i,pairingProposalResponse:r,proposal:n,sessionSettleRequest:o,publishOpts:a}=t,c=ri(n.id,r),h=await this.client.core.crypto.encode(n.pairingTopic,c,{encoding:Te}),l=it("wc_sessionSettle",o,a==null?void 0:a.id),u=await this.client.core.crypto.encode(i,l,{encoding:Te});this.client.core.history.set(i,l),await this.client.core.relayer.publishCustom({payload:{sessionTopic:i,pairingTopic:n.pairingTopic,sessionProposalResponse:h,sessionSettlementRequest:u},opts:De(Q({},a),{publishMethod:"wc_approveSession"})})}),P(this,"sendResult",async t=>{const{id:i,topic:r,result:n,throwOnFailedPublish:o,encodeOpts:a,appLink:c}=t,h=ri(i,n);let l;const u=c&&typeof(global==null?void 0:global.Linking)<"u";try{const f=u?Bt:Te;l=await this.client.core.crypto.encode(r,h,De(Q({},a||{}),{encoding:f}))}catch(f){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${r} failed`),f}let d,p;try{d=await this.client.core.history.get(r,i);const f=d.request;try{p=this.getTVFParams(i,f.params,n)}catch(g){this.client.logger.warn(`sendResult() -> getTVFParams() failed: ${g==null?void 0:g.message}`)}}catch(f){throw this.client.logger.error(`sendResult() -> history.get(${r}, ${i}) failed`),f}if(u){const f=_i(c,r,l);await global.Linking.openURL(f,this.client.name)}else{const f=d.request.method,g=me[f].res;g.tvf=De(Q({},p),{correlationId:i}),o?(g.internal=De(Q({},g.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(r,l,g)):this.client.core.relayer.publish(r,l,g).catch(m=>this.client.logger.error(m))}await this.client.core.history.resolve(h)}),P(this,"sendError",async t=>{const{id:i,topic:r,error:n,encodeOpts:o,rpcOpts:a,appLink:c}=t,h=mn(i,n);let l;const u=c&&typeof(global==null?void 0:global.Linking)<"u";try{const p=u?Bt:Te;l=await this.client.core.crypto.encode(r,h,De(Q({},o||{}),{encoding:p}))}catch(p){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${r} failed`),p}let d;try{d=await this.client.core.history.get(r,i)}catch(p){throw this.client.logger.error(`sendError() -> history.get(${r}, ${i}) failed`),p}if(u){const p=_i(c,r,l);await global.Linking.openURL(p,this.client.name)}else{const p=d.request.method,f=a||me[p].res;this.client.core.relayer.publish(r,l,f)}await this.client.core.history.resolve(h)}),P(this,"cleanup",async()=>{const t=[],i=[];this.client.session.getAll().forEach(r=>{let n=!1;lt(r.expiry)&&(n=!0),this.client.core.crypto.keychain.has(r.topic)||(n=!0),n&&t.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{lt(r.expiryTimestamp)&&i.push(r.id)}),await Promise.all([...t.map(r=>this.deleteSession({topic:r})),...i.map(r=>this.deleteProposal(r))])}),P(this,"onProviderMessageEvent",async t=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(t):await this.onRelayMessage(t)}),P(this,"onRelayEventRequest",async t=>{this.requestQueue.queue.push(t),await this.processRequestsQueue()}),P(this,"processRequestsQueue",async()=>{if(this.requestQueue.state===ct.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=ct.active;const t=this.requestQueue.queue.shift();if(t)try{await this.processRequest(t)}catch(i){this.client.logger.warn(i)}}this.requestQueue.state=ct.idle}),P(this,"processRequest",async t=>{const{topic:i,payload:r,attestation:n,transportType:o,encryptedId:a}=t,c=r.method;if(!this.shouldIgnorePairingRequest({topic:i,requestMethod:c}))switch(c){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:i,payload:r,attestation:n,encryptedId:a});case"wc_sessionSettle":return await this.onSessionSettleRequest(i,r);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(i,r);case"wc_sessionExtend":return await this.onSessionExtendRequest(i,r);case"wc_sessionPing":return await this.onSessionPingRequest(i,r);case"wc_sessionDelete":return await this.onSessionDeleteRequest(i,r);case"wc_sessionRequest":return await this.onSessionRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});case"wc_sessionEvent":return await this.onSessionEventRequest(i,r);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});default:return this.client.logger.info(`Unsupported request method ${c}`)}}),P(this,"onRelayEventResponse",async t=>{const{topic:i,payload:r,transportType:n}=t,o=(await this.client.core.history.get(i,r.id)).request.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeResponse(i,r,n);case"wc_sessionSettle":return this.onSessionSettleResponse(i,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(i,r);case"wc_sessionExtend":return this.onSessionExtendResponse(i,r);case"wc_sessionPing":return this.onSessionPingResponse(i,r);case"wc_sessionRequest":return this.onSessionRequestResponse(i,r);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(i,r);default:return this.client.logger.info(`Unsupported response method ${o}`)}}),P(this,"onRelayEventUnknownPayload",t=>{const{topic:i}=t,{message:r}=U("MISSING_OR_INVALID",`Decoded payload on topic ${i} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)}),P(this,"shouldIgnorePairingRequest",t=>{const{topic:i,requestMethod:r}=t,n=this.expectedPairingMethodMap.get(i);return!n||n.includes(r)?!1:!!(n.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)}),P(this,"onSessionProposeRequest",async t=>{const{topic:i,payload:r,attestation:n,encryptedId:o}=t,{params:a,id:c}=r;try{const h=this.client.core.eventClient.getEvent({topic:i});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),h==null||h.setError(Et.proposal_listener_not_found)),this.isValidConnect(Q({},r.params));const l=a.expiryTimestamp||he(me.wc_sessionPropose.req.ttl),u=Q({id:c,pairingTopic:i,expiryTimestamp:l,attestation:n,encryptedId:o},a);await this.setProposal(c,u);const d=await this.getVerifyContext({attestationId:n,hash:Ke(JSON.stringify(r)),encryptedId:o,metadata:u.proposer.metadata});h==null||h.addTrace(ht.emit_session_proposal),this.client.events.emit("session_proposal",{id:c,params:u,verifyContext:d})}catch(h){await this.sendError({id:c,topic:i,error:h,rpcOpts:me.wc_sessionPropose.autoReject}),this.client.logger.error(h)}}),P(this,"onSessionProposeResponse",async(t,i,r)=>{const{id:n}=i;if(bt(i)){const{result:o}=i;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:o});const a=this.client.proposal.get(n);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});const c=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});const h=o.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:h});const l=await this.client.core.crypto.generateSharedKey(c,h);this.pendingSessions.set(n,{sessionTopic:l,pairingTopic:t,proposalId:n,publicKey:c});const u=await this.client.core.relayer.subscribe(l,{transportType:r});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:u}),await this.client.core.pairing.activate({topic:t})}else if(st(i)){await this.deleteProposal(n);const o=Z("session_connect",n);if(this.events.listenerCount(o)===0)throw new Error(`emitting ${o} without any listeners, 954`);this.events.emit(o,{error:i.error})}}),P(this,"onSessionSettleRequest",async(t,i)=>{const{id:r,params:n}=i;try{this.isValidSessionSettleRequest(n);const{relay:o,controller:a,expiry:c,namespaces:h,sessionProperties:l,scopedProperties:u,sessionConfig:d}=i.params,p=[...this.pendingSessions.values()].find(m=>m.sessionTopic===t);if(!p)return this.client.logger.error(`Pending session not found for topic ${t}`);const f=this.client.proposal.get(p.proposalId),g=De(Q(Q(Q({topic:t,relay:o,expiry:c,namespaces:h,acknowledged:!0,pairingTopic:p.pairingTopic,requiredNamespaces:f.requiredNamespaces,optionalNamespaces:f.optionalNamespaces,controller:a.publicKey,self:{publicKey:p.publicKey,metadata:this.client.metadata},peer:{publicKey:a.publicKey,metadata:a.metadata}},l&&{sessionProperties:l}),u&&{scopedProperties:u}),d&&{sessionConfig:d}),{transportType:se.relay});await this.client.session.set(g.topic,g),await this.setExpiry(g.topic,g.expiry),await this.client.core.pairing.updateMetadata({topic:p.pairingTopic,metadata:g.peer.metadata}),this.client.events.emit("session_connect",{session:g}),this.events.emit(Z("session_connect",p.proposalId),{session:g}),this.pendingSessions.delete(p.proposalId),this.deleteProposal(p.proposalId,!1),this.cleanupDuplicatePairings(g),await this.sendResult({id:i.id,topic:t,result:!0})}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),P(this,"onSessionSettleResponse",async(t,i)=>{const{id:r}=i;bt(i)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(Z("session_approve",r),{})):st(i)&&(await this.client.session.delete(t,ie("USER_DISCONNECTED")),this.events.emit(Z("session_approve",r),{error:i.error}))}),P(this,"onSessionUpdateRequest",async(t,i)=>{const{params:r,id:n}=i;try{const o=`${t}_session_update`,a=Ms.get(o);if(a&&this.isRequestOutOfSync(a,n)){this.client.logger.warn(`Discarding out of sync request - ${n}`),this.sendError({id:n,topic:t,error:ie("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(Q({topic:t},r));try{Ms.set(o,n),await this.client.session.update(t,{namespaces:r.namespaces}),await this.sendResult({id:n,topic:t,result:!0})}catch(c){throw Ms.delete(o),c}this.client.events.emit("session_update",{id:n,topic:t,params:r})}catch(o){await this.sendError({id:n,topic:t,error:o}),this.client.logger.error(o)}}),P(this,"isRequestOutOfSync",(t,i)=>i.toString().slice(0,-3)<t.toString().slice(0,-3)),P(this,"onSessionUpdateResponse",(t,i)=>{const{id:r}=i,n=Z("session_update",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);bt(i)?this.events.emit(Z("session_update",r),{}):st(i)&&this.events.emit(Z("session_update",r),{error:i.error})}),P(this,"onSessionExtendRequest",async(t,i)=>{const{id:r}=i;try{this.isValidExtend({topic:t}),await this.setExpiry(t,he(ls)),await this.sendResult({id:r,topic:t,result:!0}),this.client.events.emit("session_extend",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),P(this,"onSessionExtendResponse",(t,i)=>{const{id:r}=i,n=Z("session_extend",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);bt(i)?this.events.emit(Z("session_extend",r),{}):st(i)&&this.events.emit(Z("session_extend",r),{error:i.error})}),P(this,"onSessionPingRequest",async(t,i)=>{const{id:r}=i;try{this.isValidPing({topic:t}),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),P(this,"onSessionPingResponse",(t,i)=>{const{id:r}=i,n=Z("session_ping",r);setTimeout(()=>{if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners 2176`);bt(i)?this.events.emit(Z("session_ping",r),{}):st(i)&&this.events.emit(Z("session_ping",r),{error:i.error})},500)}),P(this,"onSessionDeleteRequest",async(t,i)=>{const{id:r}=i;try{this.isValidDisconnect({topic:t,reason:i.params}),await Promise.all([new Promise(n=>{this.client.core.relayer.once(oe.publish,async()=>{n(await this.deleteSession({topic:t,id:r}))})}),this.sendResult({id:r,topic:t,result:!0}),this.cleanupPendingSentRequestsForTopic({topic:t,error:ie("USER_DISCONNECTED")})]).catch(n=>this.client.logger.error(n))}catch(n){this.client.logger.error(n)}}),P(this,"onSessionRequest",async t=>{var i,r,n;const{topic:o,payload:a,attestation:c,encryptedId:h,transportType:l}=t,{id:u,params:d}=a;try{await this.isValidRequest(Q({topic:o},d));const p=this.client.session.get(o),f=await this.getVerifyContext({attestationId:c,hash:Ke(JSON.stringify(it("wc_sessionRequest",d,u))),encryptedId:h,metadata:p.peer.metadata,transportType:l}),g={id:u,topic:o,params:d,verifyContext:f};await this.setPendingSessionRequest(g),l===se.link_mode&&(i=p.peer.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp((r=p.peer.metadata.redirect)==null?void 0:r.universal),(n=this.client.signConfig)!=null&&n.disableRequestQueue?this.emitSessionRequest(g):(this.addSessionRequestToSessionRequestQueue(g),this.processSessionRequestQueue())}catch(p){await this.sendError({id:u,topic:o,error:p}),this.client.logger.error(p)}}),P(this,"onSessionRequestResponse",(t,i)=>{const{id:r}=i,n=Z("session_request",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);bt(i)?this.events.emit(Z("session_request",r),{result:i.result}):st(i)&&this.events.emit(Z("session_request",r),{error:i.error})}),P(this,"onSessionEventRequest",async(t,i)=>{const{id:r,params:n}=i;try{const o=`${t}_session_event_${n.event.name}`,a=Ms.get(o);if(a&&this.isRequestOutOfSync(a,r)){this.client.logger.info(`Discarding out of sync request - ${r}`);return}this.isValidEmit(Q({topic:t},n)),this.client.events.emit("session_event",{id:r,topic:t,params:n}),Ms.set(o,r)}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),P(this,"onSessionAuthenticateResponse",(t,i)=>{const{id:r}=i;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:t,payload:i}),bt(i)?this.events.emit(Z("session_request",r),{result:i.result}):st(i)&&this.events.emit(Z("session_request",r),{error:i.error})}),P(this,"onSessionAuthenticateRequest",async t=>{var i;const{topic:r,payload:n,attestation:o,encryptedId:a,transportType:c}=t;try{const{requester:h,authPayload:l,expiryTimestamp:u}=n.params,d=await this.getVerifyContext({attestationId:o,hash:Ke(JSON.stringify(n)),encryptedId:a,metadata:h.metadata,transportType:c}),p={requester:h,pairingTopic:r,id:n.id,authPayload:l,verifyContext:d,expiryTimestamp:u};await this.setAuthRequest(n.id,{request:p,pairingTopic:r,transportType:c}),c===se.link_mode&&(i=h.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp(h.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:r,params:n.params,id:n.id,verifyContext:d})}catch(h){this.client.logger.error(h);const l=n.params.requester.publicKey,u=await this.client.core.crypto.generateKeyPair(),d=this.getAppLinkIfEnabled(n.params.requester.metadata,c),p={type:xt,receiverPublicKey:l,senderPublicKey:u};await this.sendError({id:n.id,topic:r,error:h,encodeOpts:p,rpcOpts:me.wc_sessionAuthenticate.autoReject,appLink:d})}}),P(this,"addSessionRequestToSessionRequestQueue",t=>{this.sessionRequestQueue.queue.push(t)}),P(this,"cleanupAfterResponse",t=>{this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=ct.idle,this.processSessionRequestQueue()},k.toMiliseconds(this.requestQueueDelay))}),P(this,"cleanupPendingSentRequestsForTopic",({topic:t,error:i})=>{const r=this.client.core.history.pending;r.length>0&&r.filter(n=>n.topic===t&&n.request.method==="wc_sessionRequest").forEach(n=>{const o=n.request.id,a=Z("session_request",o);if(this.events.listenerCount(a)===0)throw new Error(`emitting ${a} without any listeners`);this.events.emit(Z("session_request",n.request.id),{error:i})})}),P(this,"processSessionRequestQueue",()=>{if(this.sessionRequestQueue.state===ct.active){this.client.logger.info("session request queue is already active.");return}const t=this.sessionRequestQueue.queue[0];if(!t){this.client.logger.info("session request queue is empty.");return}try{this.emitSessionRequest(t)}catch(i){this.client.logger.error(i)}}),P(this,"emitSessionRequest",t=>{if(this.emittedSessionRequests.has(t.id)){this.client.logger.warn({id:t.id},`Skipping emitting \`session_request\` event for duplicate request. id: ${t.id}`);return}this.sessionRequestQueue.state=ct.active,this.emittedSessionRequests.add(t.id),this.client.events.emit("session_request",t)}),P(this,"onPairingCreated",t=>{if(t.methods&&this.expectedPairingMethodMap.set(t.topic,t.methods),t.active)return;const i=this.client.proposal.getAll().find(r=>r.pairingTopic===t.topic);i&&this.onSessionProposeRequest({topic:t.topic,payload:it("wc_sessionPropose",De(Q({},i),{requiredNamespaces:i.requiredNamespaces,optionalNamespaces:i.optionalNamespaces,relays:i.relays,proposer:i.proposer,sessionProperties:i.sessionProperties,scopedProperties:i.scopedProperties}),i.id),attestation:i.attestation,encryptedId:i.encryptedId})}),P(this,"isValidConnect",async t=>{if(!Ae(t)){const{message:h}=U("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(h)}const{pairingTopic:i,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:o,scopedProperties:a,relays:c}=t;if(de(i)||await this.isValidPairingTopic(i),!lm(c)){const{message:h}=U("MISSING_OR_INVALID",`connect() relays: ${c}`);throw new Error(h)}if(!de(r)&&ft(r)!==0){const h="requiredNamespaces are deprecated and are automatically assigned to optionalNamespaces";["fatal","error","silent"].includes(this.client.logger.level)?console.warn(h):this.client.logger.warn(h),this.validateNamespaces(r,"requiredNamespaces")}if(!de(n)&&ft(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),de(o)||this.validateSessionProps(o,"sessionProperties"),!de(a)){this.validateSessionProps(a,"scopedProperties");const h=Object.keys(r||{}).concat(Object.keys(n||{}));if(!Object.keys(a).every(l=>h.includes(l.split(":")[0])))throw new Error(`Scoped properties must be a subset of required/optional namespaces, received: ${JSON.stringify(a)}, required/optional namespaces: ${JSON.stringify(h)}`)}}),P(this,"validateNamespaces",(t,i)=>{const r=hm(t,"connect()",i);if(r)throw new Error(r.message)}),P(this,"isValidApprove",async t=>{if(!Ae(t))throw new Error(U("MISSING_OR_INVALID",`approve() params: ${t}`).message);const{id:i,namespaces:r,relayProtocol:n,sessionProperties:o,scopedProperties:a}=t;this.checkRecentlyDeleted(i),await this.isValidProposalId(i);const c=this.client.proposal.get(i),h=br(r,"approve()");if(h)throw new Error(h.message);const l=Xo(c.requiredNamespaces,r,"approve()");if(l)throw new Error(l.message);if(!le(n,!0)){const{message:u}=U("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(u)}if(de(o)||this.validateSessionProps(o,"sessionProperties"),!de(a)){this.validateSessionProps(a,"scopedProperties");const u=new Set(Object.keys(r));if(!Object.keys(a).every(d=>u.has(d.split(":")[0])))throw new Error(`Scoped properties must be a subset of approved namespaces, received: ${JSON.stringify(a)}, approved namespaces: ${Array.from(u).join(", ")}`)}}),P(this,"isValidReject",async t=>{if(!Ae(t)){const{message:n}=U("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(n)}const{id:i,reason:r}=t;if(this.checkRecentlyDeleted(i),await this.isValidProposalId(i),!dm(r)){const{message:n}=U("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}}),P(this,"isValidSessionSettleRequest",t=>{if(!Ae(t)){const{message:h}=U("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(h)}const{relay:i,controller:r,namespaces:n,expiry:o}=t;if(!vh(i)){const{message:h}=U("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(h)}const a=im(r,"onSessionSettleRequest()");if(a)throw new Error(a.message);const c=br(n,"onSessionSettleRequest()");if(c)throw new Error(c.message);if(lt(o)){const{message:h}=U("EXPIRED","onSessionSettleRequest()");throw new Error(h)}}),P(this,"isValidUpdate",async t=>{if(!Ae(t)){const{message:c}=U("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(c)}const{topic:i,namespaces:r}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);const n=this.client.session.get(i),o=br(r,"update()");if(o)throw new Error(o.message);const a=Xo(n.requiredNamespaces,r,"update()");if(a)throw new Error(a.message)}),P(this,"isValidExtend",async t=>{if(!Ae(t)){const{message:r}=U("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(r)}const{topic:i}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i)}),P(this,"isValidRequest",async t=>{if(!Ae(t)){const{message:c}=U("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(c)}const{topic:i,request:r,chainId:n,expiry:o}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);const{namespaces:a}=this.client.session.get(i);if(!Qo(a,n)){const{message:c}=U("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(c)}if(!fm(r)){const{message:c}=U("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(c)}if(!ym(a,n,r.method)){const{message:c}=U("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(c)}if(o&&!vm(o,Pr)){const{message:c}=U("MISSING_OR_INVALID",`request() expiry: ${o}. Expiry must be a number (in seconds) between ${Pr.min} and ${Pr.max}`);throw new Error(c)}}),P(this,"isValidRespond",async t=>{var i;if(!Ae(t)){const{message:o}=U("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(o)}const{topic:r,response:n}=t;try{await this.isValidSessionTopic(r)}catch(o){throw(i=t==null?void 0:t.response)!=null&&i.id&&this.cleanupAfterResponse(t),o}if(!pm(n)){const{message:o}=U("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(n)}`);throw new Error(o)}}),P(this,"isValidPing",async t=>{if(!Ae(t)){const{message:r}=U("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(r)}const{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),P(this,"isValidEmit",async t=>{if(!Ae(t)){const{message:a}=U("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(a)}const{topic:i,event:r,chainId:n}=t;await this.isValidSessionTopic(i);const{namespaces:o}=this.client.session.get(i);if(!Qo(o,n)){const{message:a}=U("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(a)}if(!gm(r)){const{message:a}=U("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}if(!mm(o,n,r.name)){const{message:a}=U("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}}),P(this,"isValidDisconnect",async t=>{if(!Ae(t)){const{message:r}=U("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(r)}const{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),P(this,"isValidAuthenticate",t=>{const{chains:i,uri:r,domain:n,nonce:o}=t;if(!Array.isArray(i)||i.length===0)throw new Error("chains is required and must be a non-empty array");if(!le(r,!1))throw new Error("uri is required parameter");if(!le(n,!1))throw new Error("domain is required parameter");if(!le(o,!1))throw new Error("nonce is required parameter");if([...new Set(i.map(c=>jt(c).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");const{namespace:a}=jt(i[0]);if(a!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")}),P(this,"getVerifyContext",async t=>{const{attestationId:i,hash:r,encryptedId:n,metadata:o,transportType:a}=t,c={verified:{verifyUrl:o.verifyUrl||si,validation:"UNKNOWN",origin:o.url||""}};try{if(a===se.link_mode){const l=this.getAppLinkIfEnabled(o,a);return c.verified.validation=l&&new URL(l).origin===new URL(o.url).origin?"VALID":"INVALID",c}const h=await this.client.core.verify.resolve({attestationId:i,hash:r,encryptedId:n,verifyUrl:o.verifyUrl});h&&(c.verified.origin=h.origin,c.verified.isScam=h.isScam,c.verified.validation=h.origin===new URL(o.url).origin?"VALID":"INVALID")}catch(h){this.client.logger.warn(h)}return this.client.logger.debug(`Verify context: ${JSON.stringify(c)}`),c}),P(this,"validateSessionProps",(t,i)=>{Object.values(t).forEach((r,n)=>{if(r==null){const{message:o}=U("MISSING_OR_INVALID",`${i} must contain an existing value for each key. Received: ${r} for key ${Object.keys(t)[n]}`);throw new Error(o)}})}),P(this,"getPendingAuthRequest",t=>{const i=this.client.auth.requests.get(t);return typeof i=="object"?i:void 0}),P(this,"addToRecentlyDeleted",(t,i)=>{if(this.recentlyDeletedMap.set(t,i),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let r=0;const n=this.recentlyDeletedLimit/2;for(const o of this.recentlyDeletedMap.keys()){if(r++>=n)break;this.recentlyDeletedMap.delete(o)}}}),P(this,"checkRecentlyDeleted",t=>{const i=this.recentlyDeletedMap.get(t);if(i){const{message:r}=U("MISSING_OR_INVALID",`Record was recently deleted - ${i}: ${t}`);throw new Error(r)}}),P(this,"isLinkModeEnabled",(t,i)=>{var r,n,o,a,c,h,l,u,d;return!t||i!==se.link_mode?!1:((n=(r=this.client.metadata)==null?void 0:r.redirect)==null?void 0:n.linkMode)===!0&&((a=(o=this.client.metadata)==null?void 0:o.redirect)==null?void 0:a.universal)!==void 0&&((h=(c=this.client.metadata)==null?void 0:c.redirect)==null?void 0:h.universal)!==""&&((l=t==null?void 0:t.redirect)==null?void 0:l.universal)!==void 0&&((u=t==null?void 0:t.redirect)==null?void 0:u.universal)!==""&&((d=t==null?void 0:t.redirect)==null?void 0:d.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(t.redirect.universal)&&typeof(global==null?void 0:global.Linking)<"u"}),P(this,"getAppLinkIfEnabled",(t,i)=>{var r;return this.isLinkModeEnabled(t,i)?(r=t==null?void 0:t.redirect)==null?void 0:r.universal:void 0}),P(this,"handleLinkModeMessage",({url:t})=>{if(!t||!t.includes("wc_ev")||!t.includes("topic"))return;const i=uo(t,"topic")||"",r=decodeURIComponent(uo(t,"wc_ev")||""),n=this.client.session.keys.includes(i);n&&this.client.session.update(i,{transportType:se.link_mode}),this.client.core.dispatchEnvelope({topic:i,message:r,sessionExists:n})}),P(this,"registerLinkModeListeners",async()=>{var t;if(Dn()||zt()&&(t=this.client.metadata.redirect)!=null&&t.linkMode){const i=global==null?void 0:global.Linking;if(typeof i<"u"){i.addEventListener("url",this.handleLinkModeMessage,this.client.name);const r=await i.getInitialURL();r&&setTimeout(()=>{this.handleLinkModeMessage({url:r})},50)}}}),P(this,"getTVFParams",(t,i,r)=>{var n,o,a;if(!((n=i.request)!=null&&n.method))return{};const c={correlationId:t,rpcMethods:[i.request.method],chainId:i.chainId};try{const h=this.extractTxHashesFromResult(i.request,r);c.txHashes=h,c.contractAddresses=this.isValidContractData(i.request.params)?[(a=(o=i.request.params)==null?void 0:o[0])==null?void 0:a.to]:[]}catch(h){this.client.logger.warn("Error getting TVF params",h)}return c}),P(this,"isValidContractData",t=>{var i;if(!t)return!1;try{const r=(t==null?void 0:t.data)||((i=t==null?void 0:t[0])==null?void 0:i.data);if(!r.startsWith("0x"))return!1;const n=r.slice(2);return/^[0-9a-fA-F]*$/.test(n)?n.length%2===0:!1}catch{}return!1}),P(this,"extractTxHashesFromResult",(t,i)=>{var r;try{if(!i)return[];const n=t.method,o=_v[n];if(n==="sui_signTransaction")return[Fp(i.transactionBytes)];if(n==="near_signTransaction")return[vo(i)];if(n==="near_signTransactions")return i.map(c=>vo(c));if(n==="xrpl_signTransactionFor"||n==="xrpl_signTransaction")return[(r=i.tx_json)==null?void 0:r.hash];if(n==="polkadot_signTransaction")return[Um({transaction:t.params.transactionPayload,signature:i.signature})];if(n==="algo_signTxn")return Dt(i)?i.map(c=>Eo(c)):[Eo(i)];if(n==="cosmos_signDirect")return[Vp(i)];if(typeof i=="string")return[i];const a=i[o.key];if(Dt(a))return n==="solana_signAllTransactions"?a.map(c=>zp(c)):a;if(typeof a=="string")return[a]}catch(n){this.client.logger.warn("Error extracting tx hashes from result",n)}return[]})}async processPendingMessageEvents(){try{const e=this.client.session.keys,t=this.client.core.relayer.messages.getWithoutAck(e);for(const[i,r]of Object.entries(t))for(const n of r)try{await this.onProviderMessageEvent({topic:i,message:n,publishedAt:Date.now()})}catch{this.client.logger.warn(`Error processing pending message event for topic: ${i}, message: ${n}`)}}catch(e){this.client.logger.warn("processPendingMessageEvents failed",e)}}isInitialized(){if(!this.initialized){const{message:e}=U("NOT_INITIALIZED",this.name);throw new Error(e)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(oe.message,e=>{this.onProviderMessageEvent(e)})}async onRelayMessage(e){const{topic:t,message:i,attestation:r,transportType:n}=e,{publicKey:o}=this.client.auth.authKeys.keys.includes(Ui)?this.client.auth.authKeys.get(Ui):{publicKey:void 0};try{const a=await this.client.core.crypto.decode(t,i,{receiverPublicKey:o,encoding:n===se.link_mode?Bt:Te});wn(a)?(this.client.core.history.set(t,a),await this.onRelayEventRequest({topic:t,payload:a,attestation:r,transportType:n,encryptedId:Ke(i)})):Gi(a)?(await this.client.core.history.resolve(a),await this.onRelayEventResponse({topic:t,payload:a,transportType:n}),this.client.core.history.delete(t,a.id)):await this.onRelayEventUnknownPayload({topic:t,payload:a,transportType:n}),await this.client.core.relayer.messages.ack(t,i)}catch(a){this.client.logger.error(a)}}registerExpirerEvents(){this.client.core.expirer.on(Ve.expired,async e=>{const{topic:t,id:i}=$c(e.target);if(i&&this.client.pendingRequest.keys.includes(i))return await this.deletePendingSessionRequest(i,U("EXPIRED"),!0);if(i&&this.client.auth.requests.keys.includes(i))return await this.deletePendingAuthRequest(i,U("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession({topic:t,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:t})):i&&(await this.deleteProposal(i,!0),this.client.events.emit("proposal_expire",{id:i}))})}registerPairingEvents(){this.client.core.pairing.events.on(Kt.create,e=>this.onPairingCreated(e)),this.client.core.pairing.events.on(Kt.delete,e=>{this.addToRecentlyDeleted(e.topic,"pairing")})}isValidPairingTopic(e){if(!le(e,!1)){const{message:t}=U("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){const{message:t}=U("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(lt(this.client.core.pairing.pairings.get(e).expiry)){const{message:t}=U("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!le(e,!1)){const{message:t}=U("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(this.checkRecentlyDeleted(e),!this.client.session.keys.includes(e)){const{message:t}=U("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(lt(this.client.session.get(e).expiry)){await this.deleteSession({topic:e});const{message:t}=U("EXPIRED",`session topic: ${e}`);throw new Error(t)}if(!this.client.core.crypto.keychain.has(e)){const{message:t}=U("MISSING_OR_INVALID",`session topic does not exist in keychain: ${e}`);throw await this.deleteSession({topic:e}),new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.checkRecentlyDeleted(e),this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(le(e,!1)){const{message:t}=U("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{const{message:t}=U("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!um(e)){const{message:t}=U("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){const{message:t}=U("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(lt(this.client.proposal.get(e).expiryTimestamp)){await this.deleteProposal(e);const{message:t}=U("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}};class Mv extends is{constructor(e,t){super(e,t,Dv,qn),this.core=e,this.logger=t}}let zv=class extends is{constructor(e,t){super(e,t,Pv,qn),this.core=e,this.logger=t}},Fv=class extends is{constructor(e,t){super(e,t,$v,qn,i=>i.id),this.core=e,this.logger=t}},Hv=class extends is{constructor(e,t){super(e,t,Tv,nr,()=>Ui),this.core=e,this.logger=t}},Vv=class extends is{constructor(e,t){super(e,t,Rv,nr),this.core=e,this.logger=t}},Kv=class extends is{constructor(e,t){super(e,t,Nv,nr,i=>i.id),this.core=e,this.logger=t}};var Gv=Object.defineProperty,Wv=(s,e,t)=>e in s?Gv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Sr=(s,e,t)=>Wv(s,typeof e!="symbol"?e+"":e,t);class Jv{constructor(e,t){this.core=e,this.logger=t,Sr(this,"authKeys"),Sr(this,"pairingTopics"),Sr(this,"requests"),this.authKeys=new Hv(this.core,this.logger),this.pairingTopics=new Vv(this.core,this.logger),this.requests=new Kv(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}}var Yv=Object.defineProperty,Zv=(s,e,t)=>e in s?Yv(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,G=(s,e,t)=>Zv(s,typeof e!="symbol"?e+"":e,t);let Qv=class Mh extends Jl{constructor(e){super(e),G(this,"protocol",qh),G(this,"version",jh),G(this,"name",Dr.name),G(this,"metadata"),G(this,"core"),G(this,"logger"),G(this,"events",new gt.EventEmitter),G(this,"engine"),G(this,"session"),G(this,"proposal"),G(this,"pendingRequest"),G(this,"auth"),G(this,"signConfig"),G(this,"on",(i,r)=>this.events.on(i,r)),G(this,"once",(i,r)=>this.events.once(i,r)),G(this,"off",(i,r)=>this.events.off(i,r)),G(this,"removeListener",(i,r)=>this.events.removeListener(i,r)),G(this,"removeAllListeners",i=>this.events.removeAllListeners(i)),G(this,"connect",async i=>{try{return await this.engine.connect(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"pair",async i=>{try{return await this.engine.pair(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"approve",async i=>{try{return await this.engine.approve(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"reject",async i=>{try{return await this.engine.reject(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"update",async i=>{try{return await this.engine.update(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"extend",async i=>{try{return await this.engine.extend(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"request",async i=>{try{return await this.engine.request(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"respond",async i=>{try{return await this.engine.respond(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"ping",async i=>{try{return await this.engine.ping(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"emit",async i=>{try{return await this.engine.emit(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"disconnect",async i=>{try{return await this.engine.disconnect(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"find",i=>{try{return this.engine.find(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"getPendingSessionRequests",()=>{try{return this.engine.getPendingSessionRequests()}catch(i){throw this.logger.error(i.message),i}}),G(this,"authenticate",async(i,r)=>{try{return await this.engine.authenticate(i,r)}catch(n){throw this.logger.error(n.message),n}}),G(this,"formatAuthMessage",i=>{try{return this.engine.formatAuthMessage(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"approveSessionAuthenticate",async i=>{try{return await this.engine.approveSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),G(this,"rejectSessionAuthenticate",async i=>{try{return await this.engine.rejectSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),this.name=(e==null?void 0:e.name)||Dr.name,this.metadata=Nf(e==null?void 0:e.metadata),this.signConfig=e==null?void 0:e.signConfig;const t=typeof(e==null?void 0:e.logger)<"u"&&typeof(e==null?void 0:e.logger)!="string"?e.logger:ui(Wi({level:(e==null?void 0:e.logger)||Dr.logger}));this.core=(e==null?void 0:e.core)||new xv(e),this.logger=_e(t,this.name),this.session=new zv(this.core,this.logger),this.proposal=new Mv(this.core,this.logger),this.pendingRequest=new Fv(this.core,this.logger),this.engine=new Lv(this),this.auth=new Jv(this.core,this.logger)}static async init(e){const t=new Mh(e);return await t.initialize(),t}get context(){return Ue(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success")}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}};const Ca="error",Xv="wss://relay.walletconnect.org",e1="wc",t1="universal_provider",$i=`${e1}@2:${t1}:`,zh="https://rpc.walletconnect.org/v1/",Fh="generic",s1=`${zh}bundler`,Ds="call_status",i1=86400,Qe={DEFAULT_CHAIN_CHANGED:"default_chain_changed"};function jn(s){return s==null||typeof s!="object"&&typeof s!="function"}function Hh(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function Vh(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}const r1="[object RegExp]",Kh="[object String]",Gh="[object Number]",Wh="[object Boolean]",Jh="[object Arguments]",n1="[object Symbol]",o1="[object Date]",a1="[object Map]",c1="[object Set]",h1="[object Array]",l1="[object ArrayBuffer]",u1="[object Object]",d1="[object DataView]",f1="[object Uint8Array]",p1="[object Uint8ClampedArray]",g1="[object Uint16Array]",y1="[object Uint32Array]",m1="[object Int8Array]",w1="[object Int16Array]",b1="[object Int32Array]",v1="[object Float32Array]",E1="[object Float64Array]";function Ln(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)}function I1(s,e){return xs(s,void 0,s,new Map,e)}function xs(s,e,t,i=new Map,r=void 0){const n=r==null?void 0:r(s,e,t,i);if(n!=null)return n;if(jn(s))return s;if(i.has(s))return i.get(s);if(Array.isArray(s)){const o=new Array(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=xs(s[a],a,t,i,r);return Object.hasOwn(s,"index")&&(o.index=s.index),Object.hasOwn(s,"input")&&(o.input=s.input),o}if(s instanceof Date)return new Date(s.getTime());if(s instanceof RegExp){const o=new RegExp(s.source,s.flags);return o.lastIndex=s.lastIndex,o}if(s instanceof Map){const o=new Map;i.set(s,o);for(const[a,c]of s)o.set(a,xs(c,a,t,i,r));return o}if(s instanceof Set){const o=new Set;i.set(s,o);for(const a of s)o.add(xs(a,void 0,t,i,r));return o}if(typeof Buffer<"u"&&Buffer.isBuffer(s))return s.subarray();if(Ln(s)){const o=new(Object.getPrototypeOf(s)).constructor(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=xs(s[a],a,t,i,r);return o}if(s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);if(s instanceof DataView){const o=new DataView(s.buffer.slice(0),s.byteOffset,s.byteLength);return i.set(s,o),Gt(o,s,t,i,r),o}if(typeof File<"u"&&s instanceof File){const o=new File([s],s.name,{type:s.type});return i.set(s,o),Gt(o,s,t,i,r),o}if(s instanceof Blob){const o=new Blob([s],{type:s.type});return i.set(s,o),Gt(o,s,t,i,r),o}if(s instanceof Error){const o=new s.constructor;return i.set(s,o),o.message=s.message,o.name=s.name,o.stack=s.stack,o.cause=s.cause,Gt(o,s,t,i,r),o}if(typeof s=="object"&&x1(s)){const o=Object.create(Object.getPrototypeOf(s));return i.set(s,o),Gt(o,s,t,i,r),o}return s}function Gt(s,e,t=s,i,r){const n=[...Object.keys(e),...Hh(e)];for(let o=0;o<n.length;o++){const a=n[o],c=Object.getOwnPropertyDescriptor(s,a);(c==null||c.writable)&&(s[a]=xs(e[a],a,t,i,r))}}function x1(s){switch(Vh(s)){case Jh:case h1:case l1:case d1:case Wh:case o1:case v1:case E1:case m1:case w1:case b1:case a1:case Gh:case u1:case r1:case c1:case Kh:case n1:case f1:case p1:case g1:case y1:return!0;default:return!1}}function D1(s,e){return I1(s,(t,i,r,n)=>{if(typeof s=="object")switch(Object.prototype.toString.call(s)){case Gh:case Kh:case Wh:{const o=new s.constructor(s==null?void 0:s.valueOf());return Gt(o,s),o}case Jh:{const o={};return Gt(o,s),o.length=s.length,o[Symbol.iterator]=s[Symbol.iterator],o}default:return}})}function Ta(s){return D1(s)}function Ra(s){return s!==null&&typeof s=="object"&&Vh(s)==="[object Arguments]"}function Na(s){return typeof s=="object"&&s!==null}function P1(){}function S1(s){return Ln(s)}function _1(s){var t;if(typeof s!="object"||s==null)return!1;if(Object.getPrototypeOf(s)===null)return!0;if(Object.prototype.toString.call(s)!=="[object Object]"){const i=s[Symbol.toStringTag];return i==null||!((t=Object.getOwnPropertyDescriptor(s,Symbol.toStringTag))!=null&&t.writable)?!1:s.toString()===`[object ${i}]`}let e=s;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(s)===e}function $1(s){if(jn(s))return s;if(Array.isArray(s)||Ln(s)||s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);const e=Object.getPrototypeOf(s),t=e.constructor;if(s instanceof Date||s instanceof Map||s instanceof Set)return new t(s);if(s instanceof RegExp){const i=new t(s);return i.lastIndex=s.lastIndex,i}if(s instanceof DataView)return new t(s.buffer.slice(0));if(s instanceof Error){const i=new t(s.message);return i.stack=s.stack,i.name=s.name,i.cause=s.cause,i}if(typeof File<"u"&&s instanceof File)return new t([s],s.name,{type:s.type,lastModified:s.lastModified});if(typeof s=="object"){const i=Object.create(e);return Object.assign(i,s)}return s}function A1(s,...e){const t=e.slice(0,-1),i=e[e.length-1];let r=s;for(let n=0;n<t.length;n++){const o=t[n];r=pn(r,o,i,new Map)}return r}function pn(s,e,t,i){if(jn(s)&&(s=Object(s)),e==null||typeof e!="object")return s;if(i.has(e))return $1(i.get(e));if(i.set(e,s),Array.isArray(e)){e=e.slice();for(let n=0;n<e.length;n++)e[n]=e[n]??void 0}const r=[...Object.keys(e),...Hh(e)];for(let n=0;n<r.length;n++){const o=r[n];let a=e[o],c=s[o];if(Ra(a)&&(a={...a}),Ra(c)&&(c={...c}),typeof Buffer<"u"&&Buffer.isBuffer(a)&&(a=Ta(a)),Array.isArray(a))if(typeof c=="object"&&c!=null){const l=[],u=Reflect.ownKeys(c);for(let d=0;d<u.length;d++){const p=u[d];l[p]=c[p]}c=l}else c=[];const h=t(c,a,o,s,e,i);h!=null?s[o]=h:Array.isArray(a)||Na(c)&&Na(a)?s[o]=pn(c,a,t,i):c==null&&_1(a)?s[o]=pn({},a,t,i):c==null&&S1(a)?s[o]=Ta(a):(c===void 0||a!==void 0)&&(s[o]=a)}return s}function O1(s,...e){return A1(s,...e,P1)}var C1=Object.defineProperty,T1=Object.defineProperties,R1=Object.getOwnPropertyDescriptors,Ua=Object.getOwnPropertySymbols,N1=Object.prototype.hasOwnProperty,U1=Object.prototype.propertyIsEnumerable,ka=(s,e,t)=>e in s?C1(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ai=(s,e)=>{for(var t in e||(e={}))N1.call(e,t)&&ka(s,t,e[t]);if(Ua)for(var t of Ua(e))U1.call(e,t)&&ka(s,t,e[t]);return s},k1=(s,e)=>T1(s,R1(e));function Le(s,e,t){var i;const r=jt(s);return((i=e.rpcMap)==null?void 0:i[r.reference])||`${zh}?chainId=${r.namespace}:${r.reference}&projectId=${t}`}function rs(s){return s.includes(":")?s.split(":")[1]:s}function Yh(s){return s.map(e=>`${e.split(":")[0]}:${e.split(":")[1]}`)}function B1(s,e){const t=Object.keys(e.namespaces).filter(r=>r.includes(s));if(!t.length)return[];const i=[];return t.forEach(r=>{const n=e.namespaces[r].accounts;i.push(...n)}),i}function Ba(s){return Object.fromEntries(Object.entries(s).filter(([e,t])=>{var i,r;return((i=t==null?void 0:t.chains)==null?void 0:i.length)&&((r=t==null?void 0:t.chains)==null?void 0:r.length)>0}))}function Oi(s={},e={}){const t=Ba(qa(s)),i=Ba(qa(e));return O1(t,i)}function qa(s){var e,t,i,r,n;const o={};if(!ft(s))return o;for(const[a,c]of Object.entries(s)){const h=ir(a)?[a]:c.chains,l=c.methods||[],u=c.events||[],d=c.rpcMap||{},p=Is(a);o[p]=k1(Ai(Ai({},o[p]),c),{chains:dt(h,(e=o[p])==null?void 0:e.chains),methods:dt(l,(t=o[p])==null?void 0:t.methods),events:dt(u,(i=o[p])==null?void 0:i.events)}),(ft(d)||ft(((r=o[p])==null?void 0:r.rpcMap)||{}))&&(o[p].rpcMap=Ai(Ai({},d),(n=o[p])==null?void 0:n.rpcMap))}return o}function ja(s){return s.includes(":")?s.split(":")[2]:s}function La(s){const e={};for(const[t,i]of Object.entries(s)){const r=i.methods||[],n=i.events||[],o=i.accounts||[],a=ir(t)?[t]:i.chains?i.chains:Yh(i.accounts);e[t]={chains:a,methods:r,events:n,accounts:o}}return e}function _r(s){return typeof s=="number"?s:s.includes("0x")?parseInt(s,16):(s=s.includes(":")?s.split(":")[1]:s,isNaN(Number(s))?s:Number(s))}function q1(s){try{const e=JSON.parse(s);return typeof e=="object"&&e!==null&&!Array.isArray(e)}catch{return!1}}const Zh={},Y=s=>Zh[s],$r=(s,e)=>{Zh[s]=e};var j1=Object.defineProperty,Ma=Object.getOwnPropertySymbols,L1=Object.prototype.hasOwnProperty,M1=Object.prototype.propertyIsEnumerable,za=(s,e,t)=>e in s?j1(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Fa=(s,e)=>{for(var t in e||(e={}))L1.call(e,t)&&za(s,t,e[t]);if(Ma)for(var t of Ma(e))M1.call(e,t)&&za(s,t,e[t]);return s};const Ha="eip155",z1=["atomic","flow-control","paymasterService","sessionKeys","auxiliaryFunds"],F1=s=>s&&s.startsWith("0x")?BigInt(s).toString(10):s,Ar=s=>s&&s.startsWith("0x")?s:`0x${BigInt(s).toString(16)}`,Va=s=>Object.keys(s).filter(e=>z1.includes(e)).reduce((e,t)=>(e[t]=H1(s[t]),e),{}),H1=s=>typeof s=="string"&&q1(s)?JSON.parse(s):s,V1=(s,e,t)=>{const{sessionProperties:i={},scopedProperties:r={}}=s,n={};if(!ft(r)&&!ft(i))return;const o=Va(i);for(const a of t){const c=F1(a);if(!c)continue;n[Ar(c)]=o;const h=r==null?void 0:r[`${Ha}:${c}`];if(h){const l=h==null?void 0:h[`${Ha}:${c}:${e}`];n[Ar(c)]=Fa(Fa({},n[Ar(c)]),Va(l||h))}}for(const[a,c]of Object.entries(n))Object.keys(c).length===0&&delete n[a];return Object.keys(n).length>0?n:void 0};var K1=Object.defineProperty,G1=(s,e,t)=>e in s?K1(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,W1=(s,e,t)=>G1(s,e+"",t);let Or;class Mn{constructor(e){W1(this,"storage"),this.storage=e}async getItem(e){return await this.storage.getItem(e)}async setItem(e,t){return await this.storage.setItem(e,t)}async removeItem(e){return await this.storage.removeItem(e)}static getStorage(e){return Or||(Or=new Mn(e)),Or}}var J1=Object.defineProperty,Y1=Object.defineProperties,Z1=Object.getOwnPropertyDescriptors,Ka=Object.getOwnPropertySymbols,Q1=Object.prototype.hasOwnProperty,X1=Object.prototype.propertyIsEnumerable,Ga=(s,e,t)=>e in s?J1(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,eE=(s,e)=>{for(var t in e||(e={}))Q1.call(e,t)&&Ga(s,t,e[t]);if(Ka)for(var t of Ka(e))X1.call(e,t)&&Ga(s,t,e[t]);return s},tE=(s,e)=>Y1(s,Z1(e));async function sE(s,e){const t=jt(s.result.capabilities.caip345.caip2),i=s.result.capabilities.caip345.transactionHashes,r=await Promise.allSettled(i.map(u=>iE(t.reference,u,e))),n=r.filter(u=>u.status==="fulfilled").map(u=>u.value).filter(u=>u);r.filter(u=>u.status==="rejected").forEach(u=>console.warn("Failed to fetch transaction receipt:",u.reason));const o=!n.length||n.some(u=>!u),a=n.every(u=>(u==null?void 0:u.status)==="0x1"),c=n.every(u=>(u==null?void 0:u.status)==="0x0"),h=n.some(u=>(u==null?void 0:u.status)==="0x0");let l;return o?l=100:a?l=200:c?l=500:h&&(l=600),{id:s.result.id,version:s.request.version,atomic:s.request.atomicRequired,chainId:s.request.chainId,capabilities:s.result.capabilities,receipts:n,status:l}}async function iE(s,e,t){return await t(parseInt(s)).request(it("eth_getTransactionReceipt",[e]))}async function rE({sendCalls:s,storage:e}){const t=await e.getItem(Ds);await e.setItem(Ds,tE(eE({},t),{[s.result.id]:{request:s.request,result:s.result,expiry:he(i1)}}))}async function nE({resultId:s,storage:e}){const t=await e.getItem(Ds);if(t){delete t[s],await e.setItem(Ds,t);for(const i in t)lt(t[i].expiry)&&delete t[i];await e.setItem(Ds,t)}}async function oE({resultId:s,storage:e}){const t=await e.getItem(Ds),i=t==null?void 0:t[s];if(i&&!lt(i.expiry))return i;await nE({resultId:s,storage:e})}var aE=Object.defineProperty,cE=(s,e,t)=>e in s?aE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,us=(s,e,t)=>cE(s,typeof e!="symbol"?e+"":e,t);class hE{constructor(e){us(this,"name","polkadot"),us(this,"client"),us(this,"httpProviders"),us(this,"events"),us(this,"namespace"),us(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getAccounts(){const e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;const r=rs(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}}var lE=Object.defineProperty,uE=Object.defineProperties,dE=Object.getOwnPropertyDescriptors,Wa=Object.getOwnPropertySymbols,fE=Object.prototype.hasOwnProperty,pE=Object.prototype.propertyIsEnumerable,gn=(s,e,t)=>e in s?lE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Cr=(s,e)=>{for(var t in e||(e={}))fE.call(e,t)&&gn(s,t,e[t]);if(Wa)for(var t of Wa(e))pE.call(e,t)&&gn(s,t,e[t]);return s},Tr=(s,e)=>uE(s,dE(e)),Ht=(s,e,t)=>gn(s,typeof e!="symbol"?e+"":e,t);class gE{constructor(e){Ht(this,"name","eip155"),Ht(this,"client"),Ht(this,"chainId"),Ht(this,"namespace"),Ht(this,"httpProviders"),Ht(this,"events"),Ht(this,"storage"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain()),this.storage=Mn.getStorage(this.client.core.storage)}async request(e){switch(e.request.method){case"eth_requestAccounts":return this.getAccounts();case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(e);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(e);case"wallet_getCallsStatus":return await this.getCallStatus(e);case"wallet_sendCalls":return await this.sendCalls(e)}return this.namespace.methods.includes(e.request.method)?await this.client.request(e):this.getHttpProvider().request(e.request)}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(parseInt(e),t),this.chainId=parseInt(e),this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}createHttpProvider(e,t){const i=t||Le(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;const r=parseInt(rs(t));e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}getHttpProvider(e){const t=e||this.chainId;return this.httpProviders[t]||(this.httpProviders=Tr(Cr({},this.httpProviders),{[t]:this.createHttpProvider(t)}),this.httpProviders[t])}async handleSwitchChain(e){var t,i;let r=e.request.params?(t=e.request.params[0])==null?void 0:t.chainId:"0x0";r=r.startsWith("0x")?r:`0x${r}`;const n=parseInt(r,16);if(this.isChainApproved(n))this.setDefaultChain(`${n}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:e.topic,request:{method:e.request.method,params:[{chainId:r}]},chainId:(i=this.namespace.chains)==null?void 0:i[0]}),this.setDefaultChain(`${n}`);else throw new Error(`Failed to switch to chain 'eip155:${n}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(e){return this.namespace.chains.includes(`${this.name}:${e}`)}async getCapabilities(e){var t,i,r,n,o;const a=(i=(t=e.request)==null?void 0:t.params)==null?void 0:i[0],c=((n=(r=e.request)==null?void 0:r.params)==null?void 0:n[1])||[];if(!a)throw new Error("Missing address parameter in `wallet_getCapabilities` request");const h=this.client.session.get(e.topic),l=((o=h==null?void 0:h.sessionProperties)==null?void 0:o.capabilities)||{},u=`${a}${c.join(",")}`,d=l==null?void 0:l[u];if(d)return d;let p;try{p=V1(h,a,c)}catch(g){console.warn("Failed to extract capabilities from session",g)}if(p)return p;const f=await this.client.request(e);try{await this.client.session.update(e.topic,{sessionProperties:Tr(Cr({},h.sessionProperties||{}),{capabilities:Tr(Cr({},l||{}),{[u]:f})})})}catch(g){console.warn("Failed to update session with capabilities",g)}return f}async getCallStatus(e){var t,i,r;const n=this.client.session.get(e.topic),o=(t=n.sessionProperties)==null?void 0:t.bundler_name;if(o){const h=this.getBundlerUrl(e.chainId,o);try{return await this.getUserOperationReceipt(h,e)}catch(l){console.warn("Failed to fetch call status from bundler",l,h)}}const a=(i=n.sessionProperties)==null?void 0:i.bundler_url;if(a)try{return await this.getUserOperationReceipt(a,e)}catch(h){console.warn("Failed to fetch call status from custom bundler",h,a)}const c=await oE({resultId:(r=e.request.params)==null?void 0:r[0],storage:this.storage});if(c)try{return await sE(c,this.getHttpProvider.bind(this))}catch(h){console.warn("Failed to fetch call status from stored send calls",h,c)}if(this.namespace.methods.includes(e.request.method))return await this.client.request(e);throw new Error("Fetching call status not approved by the wallet.")}async getUserOperationReceipt(e,t){var i;const r=new URL(e),n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(it("eth_getUserOperationReceipt",[(i=t.request.params)==null?void 0:i[0]]))});if(!n.ok)throw new Error(`Failed to fetch user operation receipt - ${n.status}`);return await n.json()}getBundlerUrl(e,t){return`${s1}?projectId=${this.client.core.projectId}&chainId=${e}&bundler=${t}`}async sendCalls(e){var t,i,r;const n=await this.client.request(e),o=(t=e.request.params)==null?void 0:t[0],a=n==null?void 0:n.id,c=(n==null?void 0:n.capabilities)||{},h=(i=c==null?void 0:c.caip345)==null?void 0:i.caip2,l=(r=c==null?void 0:c.caip345)==null?void 0:r.transactionHashes;return!a||!h||!(l!=null&&l.length)||await rE({sendCalls:{request:o,result:n},storage:this.storage}),n}}var yE=Object.defineProperty,mE=(s,e,t)=>e in s?yE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ds=(s,e,t)=>mE(s,typeof e!="symbol"?e+"":e,t);class wE{constructor(e){ds(this,"name","solana"),ds(this,"client"),ds(this,"httpProviders"),ds(this,"events"),ds(this,"namespace"),ds(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;const r=rs(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}}var bE=Object.defineProperty,vE=(s,e,t)=>e in s?bE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,fs=(s,e,t)=>vE(s,typeof e!="symbol"?e+"":e,t);class EE{constructor(e){fs(this,"name","cosmos"),fs(this,"client"),fs(this,"httpProviders"),fs(this,"events"),fs(this,"namespace"),fs(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;const r=rs(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}}var IE=Object.defineProperty,xE=(s,e,t)=>e in s?IE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ps=(s,e,t)=>xE(s,typeof e!="symbol"?e+"":e,t);class DE{constructor(e){ps(this,"name","algorand"),ps(this,"client"),ps(this,"httpProviders"),ps(this,"events"),ps(this,"namespace"),ps(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(!this.httpProviders[e]){const i=t||Le(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;e[t]=this.createHttpProvider(t,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace,this.client.core.projectId);return typeof i>"u"?void 0:new Ze(new nt(i,Y("disableProviderPing")))}}var PE=Object.defineProperty,SE=(s,e,t)=>e in s?PE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,gs=(s,e,t)=>SE(s,typeof e!="symbol"?e+"":e,t);class _E{constructor(e){gs(this,"name","cip34"),gs(this,"client"),gs(this,"httpProviders"),gs(this,"events"),gs(this,"namespace"),gs(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{const i=this.getCardanoRPCUrl(t),r=rs(t);e[r]=this.createHttpProvider(r,i)}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}getCardanoRPCUrl(e){const t=this.namespace.rpcMap;if(t)return t[e]}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||this.getCardanoRPCUrl(e);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}}var $E=Object.defineProperty,AE=(s,e,t)=>e in s?$E(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ys=(s,e,t)=>AE(s,typeof e!="symbol"?e+"":e,t);class OE{constructor(e){ys(this,"name","elrond"),ys(this,"client"),ys(this,"httpProviders"),ys(this,"events"),ys(this,"namespace"),ys(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;const r=rs(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}}var CE=Object.defineProperty,TE=(s,e,t)=>e in s?CE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ms=(s,e,t)=>TE(s,typeof e!="symbol"?e+"":e,t);class RE{constructor(e){ms(this,"name","multiversx"),ms(this,"client"),ms(this,"httpProviders"),ms(this,"events"),ms(this,"namespace"),ms(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;const r=rs(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}}var NE=Object.defineProperty,UE=(s,e,t)=>e in s?NE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ws=(s,e,t)=>UE(s,typeof e!="symbol"?e+"":e,t);class kE{constructor(e){ws(this,"name","near"),ws(this,"client"),ws(this,"httpProviders"),ws(this,"events"),ws(this,"namespace"),ws(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){const i=t||Le(`${this.name}:${e}`,this.namespace);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{var i;e[t]=this.createHttpProvider(t,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace);return typeof i>"u"?void 0:new Ze(new nt(i,Y("disableProviderPing")))}}var BE=Object.defineProperty,qE=(s,e,t)=>e in s?BE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,bs=(s,e,t)=>qE(s,typeof e!="symbol"?e+"":e,t);class jE{constructor(e){bs(this,"name","tezos"),bs(this,"client"),bs(this,"httpProviders"),bs(this,"events"),bs(this,"namespace"),bs(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){const i=t||Le(`${this.name}:${e}`,this.namespace);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){const e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){const e={};return this.namespace.chains.forEach(t=>{e[t]=this.createHttpProvider(t)}),e}getHttpProvider(){const e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace);return typeof i>"u"?void 0:new Ze(new nt(i))}}var LE=Object.defineProperty,ME=(s,e,t)=>e in s?LE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,vs=(s,e,t)=>ME(s,typeof e!="symbol"?e+"":e,t);class zE{constructor(e){vs(this,"name",Fh),vs(this,"client"),vs(this,"httpProviders"),vs(this,"events"),vs(this,"namespace"),vs(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.name=this.getNamespaceName(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(e.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(e.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(e.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(e.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider(e.chainId).request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(Qe.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getNamespaceName(){const e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return jt(e).namespace}getAccounts(){const e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){var e,t;const i={};return(t=(e=this.namespace)==null?void 0:e.accounts)==null||t.forEach(r=>{const n=jt(r);i[n.reference]=this.createHttpProvider(r)}),i}getHttpProvider(e){const t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){const i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){const i=t||Le(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Ze(new nt(i,Y("disableProviderPing")))}}var FE=Object.defineProperty,HE=Object.defineProperties,VE=Object.getOwnPropertyDescriptors,Ja=Object.getOwnPropertySymbols,KE=Object.prototype.hasOwnProperty,GE=Object.prototype.propertyIsEnumerable,yn=(s,e,t)=>e in s?FE(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ci=(s,e)=>{for(var t in e||(e={}))KE.call(e,t)&&yn(s,t,e[t]);if(Ja)for(var t of Ja(e))GE.call(e,t)&&yn(s,t,e[t]);return s},Rr=(s,e)=>HE(s,VE(e)),He=(s,e,t)=>yn(s,typeof e!="symbol"?e+"":e,t);class or{constructor(e){He(this,"client"),He(this,"namespaces"),He(this,"optionalNamespaces"),He(this,"sessionProperties"),He(this,"scopedProperties"),He(this,"events",new bn),He(this,"rpcProviders",{}),He(this,"session"),He(this,"providerOpts"),He(this,"logger"),He(this,"uri"),He(this,"disableProviderPing",!1),this.providerOpts=e,this.logger=typeof(e==null?void 0:e.logger)<"u"&&typeof(e==null?void 0:e.logger)!="string"?e.logger:ui(Wi({level:(e==null?void 0:e.logger)||Ca})),this.disableProviderPing=(e==null?void 0:e.disableProviderPing)||!1}static async init(e){const t=new or(e);return await t.initialize(),t}async request(e,t,i){const[r,n]=this.validateChain(t);if(!this.session)throw new Error("Please call connect() before request()");return await this.getProvider(r).request({request:Ci({},e),chainId:`${r}:${n}`,topic:this.session.topic,expiry:i})}sendAsync(e,t,i,r){const n=new Date().getTime();this.request(e,i,r).then(o=>t(null,ri(n,o))).catch(o=>t(o,void 0))}async enable(){if(!this.client)throw new Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties}),await this.requestAccounts()}async disconnect(){var e;if(!this.session)throw new Error("Please call connect() before enable()");await this.client.disconnect({topic:(e=this.session)==null?void 0:e.topic,reason:ie("USER_DISCONNECTED")}),await this.cleanup()}async connect(e){if(!this.client)throw new Error("Sign Client not initialized");if(this.setNamespaces(e),this.cleanupPendingPairings(),!e.skipPairing)return await this.pair(e.pairingTopic)}async authenticate(e,t){if(!this.client)throw new Error("Sign Client not initialized");this.setNamespaces(e),await this.cleanupPendingPairings();const{uri:i,response:r}=await this.client.authenticate(e,t);i&&(this.uri=i,this.events.emit("display_uri",i));const n=await r();if(this.session=n.session,this.session){const o=La(this.session.namespaces);this.namespaces=Oi(this.namespaces,o),await this.persist("namespaces",this.namespaces),this.onConnect()}return n}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}removeListener(e,t){this.events.removeListener(e,t)}off(e,t){this.events.off(e,t)}get isWalletConnect(){return!0}async pair(e){const{uri:t,approval:i}=await this.client.connect({pairingTopic:e,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties});t&&(this.uri=t,this.events.emit("display_uri",t));const r=await i();this.session=r;const n=La(r.namespaces);return this.namespaces=Oi(this.namespaces,n),await this.persist("namespaces",this.namespaces),await this.persist("optionalNamespaces",this.optionalNamespaces),this.onConnect(),this.session}setDefaultChain(e,t){try{if(!this.session)return;const[i,r]=this.validateChain(e);this.getProvider(i).setDefaultChain(r,t)}catch(i){if(!/Please call connect/.test(i.message))throw i}}async cleanupPendingPairings(e={}){try{this.logger.info("Cleaning up inactive pairings...");const t=this.client.pairing.getAll();if(!Dt(t))return;for(const i of t)e.deletePairings?this.client.core.expirer.set(i.topic,0):await this.client.core.relayer.subscriber.unsubscribe(i.topic);this.logger.info(`Inactive pairings cleared: ${t.length}`)}catch(t){this.logger.warn("Failed to cleanup pending pairings",t)}}abortPairingAttempt(){this.logger.warn("abortPairingAttempt is deprecated. This is now a no-op.")}async checkStorage(){this.namespaces=await this.getFromStore("namespaces")||{},this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.session&&this.createProviders()}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){var e,t;if(this.client=this.providerOpts.client||await Qv.init({core:this.providerOpts.core,logger:this.providerOpts.logger||Ca,relayUrl:this.providerOpts.relayUrl||Xv,projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.providerOpts.session)try{this.session=this.client.session.get(this.providerOpts.session.topic)}catch(i){throw this.logger.error("Failed to get session",i),new Error(`The provided session: ${(t=(e=this.providerOpts)==null?void 0:e.session)==null?void 0:t.topic} doesn't exist in the Sign client`)}else{const i=this.client.session.getAll();this.session=i[0]}this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw new Error("Sign Client not initialized");if(!this.session)throw new Error("Session not initialized. Please call connect() before enable()");const e=[...new Set(Object.keys(this.session.namespaces).map(t=>Is(t)))];$r("client",this.client),$r("events",this.events),$r("disableProviderPing",this.disableProviderPing),e.forEach(t=>{if(!this.session)return;const i=B1(t,this.session);if((i==null?void 0:i.length)===0)return;const r=Yh(i),n=Oi(this.namespaces,this.optionalNamespaces),o=Rr(Ci({},n[t]),{accounts:i,chains:r});switch(t){case"eip155":this.rpcProviders[t]=new gE({namespace:o});break;case"algorand":this.rpcProviders[t]=new DE({namespace:o});break;case"solana":this.rpcProviders[t]=new wE({namespace:o});break;case"cosmos":this.rpcProviders[t]=new EE({namespace:o});break;case"polkadot":this.rpcProviders[t]=new hE({namespace:o});break;case"cip34":this.rpcProviders[t]=new _E({namespace:o});break;case"elrond":this.rpcProviders[t]=new OE({namespace:o});break;case"multiversx":this.rpcProviders[t]=new RE({namespace:o});break;case"near":this.rpcProviders[t]=new kE({namespace:o});break;case"tezos":this.rpcProviders[t]=new jE({namespace:o});break;default:this.rpcProviders[t]=new zE({namespace:o})}})}registerEventListeners(){if(typeof this.client>"u")throw new Error("Sign Client is not initialized");this.client.on("session_ping",e=>{var t;const{topic:i}=e;i===((t=this.session)==null?void 0:t.topic)&&this.events.emit("session_ping",e)}),this.client.on("session_event",e=>{var t;const{params:i,topic:r}=e;if(r!==((t=this.session)==null?void 0:t.topic))return;const{event:n}=i;if(n.name==="accountsChanged"){const o=n.data;o&&Dt(o)&&this.events.emit("accountsChanged",o.map(ja))}else if(n.name==="chainChanged"){const o=i.chainId,a=i.event.data,c=Is(o),h=_r(o)!==_r(a)?`${c}:${_r(a)}`:o;this.onChainChanged(h)}else this.events.emit(n.name,n.data);this.events.emit("session_event",e)}),this.client.on("session_update",({topic:e,params:t})=>{var i,r;if(e!==((i=this.session)==null?void 0:i.topic))return;const{namespaces:n}=t,o=(r=this.client)==null?void 0:r.session.get(e);this.session=Rr(Ci({},o),{namespaces:n}),this.onSessionUpdate(),this.events.emit("session_update",{topic:e,params:t})}),this.client.on("session_delete",async e=>{var t;e.topic===((t=this.session)==null?void 0:t.topic)&&(await this.cleanup(),this.events.emit("session_delete",e),this.events.emit("disconnect",Rr(Ci({},ie("USER_DISCONNECTED")),{data:e.topic})))}),this.on(Qe.DEFAULT_CHAIN_CHANGED,e=>{this.onChainChanged(e,!0)})}getProvider(e){return this.rpcProviders[e]||this.rpcProviders[Fh]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(e=>{var t;this.getProvider(e).updateNamespace((t=this.session)==null?void 0:t.namespaces[e])})}setNamespaces(e){const{namespaces:t={},optionalNamespaces:i={},sessionProperties:r,scopedProperties:n}=e;this.optionalNamespaces=Oi(t,i),this.sessionProperties=r,this.scopedProperties=n}validateChain(e){const[t,i]=(e==null?void 0:e.split(":"))||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[t,i];if(t&&!Object.keys(this.namespaces||{}).map(o=>Is(o)).includes(t))throw new Error(`Namespace '${t}' is not configured. Please call connect() first with namespace config.`);if(t&&i)return[t,i];const r=Is(Object.keys(this.namespaces)[0]),n=this.rpcProviders[r].getDefaultChain();return[r,n]}async requestAccounts(){const[e]=this.validateChain();return await this.getProvider(e).requestAccounts()}async onChainChanged(e,t=!1){if(!this.namespaces)return;const[i,r]=this.validateChain(e);if(!r)return;this.updateNamespaceChain(i,r);const n=this.getProvider(i).getDefaultChain();t?(this.events.emit("chainChanged",r),this.emitAccountsChangedOnChainChange({namespace:i,previousChainId:n,newChainId:e})):this.getProvider(i).setDefaultChain(r),await this.persist("namespaces",this.namespaces)}emitAccountsChangedOnChainChange({namespace:e,previousChainId:t,newChainId:i}){var r,n;try{if(t===i)return;const o=(n=(r=this.session)==null?void 0:r.namespaces[e])==null?void 0:n.accounts;if(!o)return;const a=o.filter(c=>c.includes(`${i}:`)).map(ja);if(!Dt(a))return;this.events.emit("accountsChanged",a)}catch(o){this.logger.warn("Failed to emit accountsChanged on chain change",o)}}updateNamespaceChain(e,t){if(!this.namespaces)return;const i=this.namespaces[e]?e:`${e}:${t}`,r={chains:[],methods:[],events:[],defaultChain:t};this.namespaces[i]?this.namespaces[i]&&(this.namespaces[i].defaultChain=t):this.namespaces[i]=r}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,await this.deleteFromStore("namespaces"),await this.deleteFromStore("optionalNamespaces"),await this.deleteFromStore("sessionProperties"),this.session=void 0,this.cleanupPendingPairings({deletePairings:!0}),await this.cleanupStorage()}async persist(e,t){var i;const r=((i=this.session)==null?void 0:i.topic)||"";await this.client.core.storage.setItem(`${$i}/${e}${r}`,t)}async getFromStore(e){var t;const i=((t=this.session)==null?void 0:t.topic)||"";return await this.client.core.storage.getItem(`${$i}/${e}${i}`)}async deleteFromStore(e){var t;const i=((t=this.session)==null?void 0:t.topic)||"";await this.client.core.storage.removeItem(`${$i}/${e}${i}`)}async cleanupStorage(){var e;try{if(((e=this.client)==null?void 0:e.session.length)>0)return;const t=await this.client.core.storage.getKeys();for(const i of t)i.startsWith($i)&&await this.client.core.storage.removeItem(i)}catch(t){this.logger.warn("Failed to cleanup storage",t)}}}const WE=or,N2=Object.freeze(Object.defineProperty({__proto__:null,UniversalProvider:WE,default:or},Symbol.toStringTag,{value:"Module"}));export{xu as H,Xn as a,oi as b,y2 as c,mu as d,oc as e,Du as f,g2 as g,ji as h,b2 as i,w2 as j,N2 as k,m2 as r,ac as t};
